<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora ONCE 2025 ‚Äî Diario y Resumen Mensual</title>
<meta name="theme-color" content="#0f766e">

<style>
  :root{
    --bg:#ffffff;--fg:#0f172a;--muted:#64748b;
    --brand:#0f766e;--card:#e0f2fe;--ok:#16a34a;--warn:#f59e0b;--err:#dc2626;
    --chip:#eef2ff;
  }
  [data-theme="dark"]{
    --bg:#0b1220;--fg:#e5e7eb;--muted:#9ca3af;
    --brand:#22d3ee;--card:#0f172a;--ok:#22c55e;--warn:#fbbf24;--err:#f87171;
    --chip:#1f2937;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:1rem 1rem .5rem}
  h1{font-size:1.15rem;margin:0;color:var(--brand)}
  main{padding:1rem;display:grid;gap:1rem;max-width:980px;margin:auto}
  .card{background:var(--card);border-radius:14px;padding:1rem;border:1px solid #0001}
  label{display:block;font-size:.9rem;color:var(--muted);margin:.35rem 0 .25rem}
  input,select,button{width:100%;padding:.7rem .8rem;border-radius:10px;border:1px solid #0002;background:var(--bg);color:var(--fg);font-size:1rem}
  button{background:var(--brand);color:#032; border:none;cursor:pointer;font-weight:600}
  button.ghost{background:transparent;border:1px solid #0002;color:var(--fg)}
  .row{display:grid;grid-template-columns:repeat(2,1fr);gap:.6rem}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
  .grid{display:grid;gap:.6rem}
  .hint{font-size:.9rem;color:var(--muted)}
  .pill{display:inline-block;background:var(--chip);padding:.2rem .55rem;border-radius:999px;font-size:.8rem;margin-right:.35rem}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
  .kpi .box{background:var(--bg);border:1px solid #0002;border-radius:12px;padding:.65rem}
  .box b{display:block;font-size:1.15rem;margin-top:.1rem}
  progress{width:100%;height:14px;border-radius:999px;overflow:hidden}
  progress::-webkit-progress-bar{background:#0001}
  progress::-webkit-progress-value{background:var(--brand)}
  table{width:100%;border-collapse:collapse;font-size:.95rem}
  th,td{padding:.6rem;border-bottom:1px dashed #0002;text-align:left}
  tfoot td{font-weight:700}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .actions{display:flex;gap:.6rem;flex-wrap:wrap}
  .sticky{position:sticky;bottom:.75rem;z-index:5}
  .notice{padding:.6rem .8rem;border-radius:10px;border:1px solid #0002;background:var(--bg)}
</style>
</head>
<body>
<header>
  <h1>Calculadora ONCE 2025 ‚Äî Diario & Mensual</h1>
  <div class="actions">
    <button id="btnTema" class="ghost" title="Tema">üåó Tema</button>
    <button id="btnReset" class="ghost" title="Borrar mes">üßπ Borrar mes</button>
  </div>
</header>

<main>
  <!-- FORMULARIO D√çA A D√çA -->
  <section class="card">
    <h2 style="margin:0 0 .5rem">Registrar d√≠a</h2>
    <div class="row">
      <div>
        <label>Fecha</label>
        <input type="date" id="fecha">
        <div class="hint" id="sugerencia"></div>
      </div>
      <div>
        <label>Comentarios (opcional)</label>
        <input type="text" id="nota" placeholder="Ej: Ma√±ana floja, tarde mejor">
      </div>
    </div>

    <div class="grid" style="margin-top:.6rem">
      <div class="row3">
        <div>
          <label>Diario (uds √ó 2‚Ç¨)</label>
          <input type="number" id="q_diario" min="0" value="0">
        </div>
        <div>
          <label>Cuponazo (uds √ó 3‚Ç¨)</label>
          <input type="number" id="q_cuponazo" min="0" value="0">
        </div>
        <div>
          <label>Sueldazo (uds √ó 2‚Ç¨)</label>
          <input type="number" id="q_sueldazo" min="0" value="0">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Eurojackpot (apuestas √ó 2‚Ç¨)</label>
          <input type="number" id="q_euro" min="0" value="0">
        </div>
        <div>
          <label>Mi D√≠a (apuestas √ó 1‚Ç¨)</label>
          <input type="number" id="q_midia" min="0" value="0">
        </div>
        <div>
          <label>Super Once (apuestas √ó 1‚Ç¨)</label>
          <input type="number" id="q_superonce" min="0" value="0">
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Triplex (apuestas √ó 0,50‚Ç¨)</label>
          <input type="number" id="q_triplex" min="0" value="0">
        </div>
        <div>
          <label>Otros (‚Ç¨ directos)</label>
          <input type="number" id="otros" min="0" step="0.01" value="0">
        </div>
        <div>
          <label>Importe del d√≠a (‚Ç¨)</label>
          <input type="text" id="importeDia" disabled value="0.00">
        </div>
      </div>

      <details>
        <summary><b>üì¶ Rascas (por <u>paquetes activados</u>)</b> <span class="hint">(se suman al importe del d√≠a)</span></summary>
        <div class="row3" style="margin-top:.6rem">
          <div><label>Rasca 1‚Ç¨ (100‚Ç¨/paquete)</label><input type="number" id="p_r1" min="0" value="0"></div>
          <div><label>Rasca 2‚Ç¨ (100‚Ç¨/paquete)</label><input type="number" id="p_r2" min="0" value="0"></div>
          <div><label>Rasca 3‚Ç¨ (150‚Ç¨/paquete)</label><input type="number" id="p_r3" min="0" value="0"></div>
        </div>
        <div class="row3" style="margin-top:.4rem">
          <div><label>Rasca 5‚Ç¨ (150‚Ç¨/paquete)</label><input type="number" id="p_r5" min="0" value="0"></div>
          <div><label>Rasca 10‚Ç¨ (150‚Ç¨/paquete)</label><input type="number" id="p_r10" min="0" value="0"></div>
          <div class="notice"><span class="pill">Info</span> Si activas 1 paquete de 3‚Ç¨, suma 150‚Ç¨ al d√≠a; 1 paquete de 1‚Ç¨, suma 100‚Ç¨.</div>
        </div>
      </details>

      <div class="actions">
        <button id="btnGuardar">üíæ Guardar d√≠a</button>
        <button id="btnCalcular" class="ghost">üî¢ Recalcular importe</button>
      </div>
    </div>
  </section>

  <!-- RESUMEN MENSUAL -->
  <section class="card">
    <h2 style="margin:0 0 .5rem">Resumen mensual</h2>
    <div class="kpi">
      <div class="box">
        <span class="hint">Jornadas registradas</span>
        <b id="kpiJornadas">0</b>
      </div>
      <div class="box">
        <span class="hint">Acumulado ventas (‚Ç¨)</span>
        <b id="kpiAcumulado">0.00</b>
      </div>
      <div class="box">
        <span class="hint">Comisi√≥n estimada (‚Ç¨)</span>
        <b id="kpiComision">0.00</b>
      </div>
    </div>

    <div style="margin-top:.75rem">
      <div class="row">
        <div class="box">
          <span class="hint">M√≠nimo (‚Ç¨)</span>
          <b id="kpiMinimo">0.00</b>
        </div>
        <div class="box">
          <span class="hint">Umbral (‚Ç¨)</span>
          <b id="kpiUmbral">0.00</b>
        </div>
      </div>
      <div style="margin-top:.6rem">
        <progress id="prog" max="100" value="0"></progress>
        <div class="hint" id="textoProg">Progreso al umbral: 0%</div>
      </div>
    </div>

    <div class="actions" style="margin-top:.75rem">
      <button id="btnExport">‚¨áÔ∏è Exportar CSV</button>
    </div>
  </section>

  <!-- LISTADO DEL MES -->
  <section class="card">
    <h2 style="margin:0 0 .5rem">Ventas del mes</h2>
    <div class="hint">Se guardan en este dispositivo. Puedes editar re-guardando la misma fecha.</div>
    <div style="overflow:auto;margin-top:.5rem">
      <table id="tabla">
        <thead>
          <tr>
            <th>Fecha</th><th>Diario</th><th>Cuponazo</th><th>Sueldazo</th>
            <th>Euro</th><th>Mi D√≠a</th><th>S. Once</th><th>Triplex</th>
            <th>Rascas (‚Ç¨)</th><th>Otros (‚Ç¨)</th><th>Total (‚Ç¨)</th><th>Nota</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td><b>Total</b></td><td id="t_di">0</td><td id="t_cu">0</td><td id="t_su">0</td>
            <td id="t_eu">0</td><td id="t_md">0</td><td id="t_so">0</td><td id="t_tr">0</td>
            <td id="t_ra">0.00</td><td id="t_ot">0.00</td><td id="t_tt">0.00</td><td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <div class="sticky" style="max-width:980px;margin:auto">
    <div id="alerta" class="notice"></div>
  </div>
</main>

<script>
/* -------------------- CONSTANTES -------------------- */
const PRECIOS = {
  diario: 2, cuponazo: 3, sueldazo: 2,
  euro: 2, midia: 1, superonce: 1, triplex: 0.5
};
// rascas por paquete (euros)
const PACK_RASCAS = { r1:100, r2:100, r3:150, r5:150, r10:150 };

// Tabla oficial 2025 (M√çNIMO y UMBRAL) por jornadas 0..25 (√≠ndice = jornadas)
// Fuente: tabla accesible (valores copiados).
const MINIMO = [0,142,284,426,568,710,852,994,1136,1278,1420,1562,1704,1846,1988,2130,2272,2414,2556,2698,2840,2982,3124,3266,3408,3550];
const UMBRAL = [0,210,420,630,840,1050,1260,1470,1680,1890,2100,2310,2520,2730,2940,3150,3360,3570,3780,3990,4200,4410,4620,4830,5040,5250];

/* Comisi√≥n (MVP): solo se cobra si acumulado >= umbral.
   Por simplicidad, estimamos comisi√≥n lineal del 10% sobre el EXCESO sobre el umbral.
   Luego si quieres, introducimos los tramos/familias exactos.
*/
const PORC_COMISION = 0.10;

/* -------------------- UTILIDADES -------------------- */
const $ = s => document.querySelector(s);

function yyyymm(date){
  const d = new Date(date);
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${d.getFullYear()}-${m}`;
}
function todayISO(){
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${d.getFullYear()}-${m}-${day}`;
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

/* -------------------- ESTADO & STORAGE -------------------- */
function keyMes(fechaIso){
  return 'once:'+ (fechaIso ? yyyymm(fechaIso) : yyyymm(todayISO()));
}
function loadMes(fechaIso){
  try{
    return JSON.parse(localStorage.getItem(keyMes(fechaIso))||'{}');
  }catch{ return {}; }
}
function saveMes(fechaIso, datos){
  localStorage.setItem(keyMes(fechaIso), JSON.stringify(datos));
}

/* -------------------- C√ÅLCULOS -------------------- */
function importeDelDia(d){
  const rascasEuros =
    (Number(d.p_r1)||0)*PACK_RASCAS.r1 +
    (Number(d.p_r2)||0)*PACK_RASCAS.r2 +
    (Number(d.p_r3)||0)*PACK_RASCAS.r3 +
    (Number(d.p_r5)||0)*PACK_RASCAS.r5 +
    (Number(d.p_r10)||0)*PACK_RASCAS.r10;

  const cuponesEuros =
    (Number(d.q_diario)||0)*PRECIOS.diario +
    (Number(d.q_cuponazo)||0)*PRECIOS.cuponazo +
    (Number(d.q_sueldazo)||0)*PRECIOS.sueldazo +
    (Number(d.q_euro)||0)*PRECIOS.euro +
    (Number(d.q_midia)||0)*PRECIOS.midia +
    (Number(d.q_superonce)||0)*PRECIOS.superonce +
    (Number(d.q_triplex)||0)*PRECIOS.triplex;

  const otros = Number(d.otros)||0;
  return rascasEuros + cuponesEuros + otros;
}

function resumenMes(mesData){
  const fechas = Object.keys(mesData).sort();
  let jornadas = fechas.length;
  let acumulado = 0;

  let sum = {di:0,cu:0,su:0,eu:0,md:0,so:0,tr:0,ra:0,ot:0,tt:0};

  fechas.forEach(f=>{
    const d = mesData[f];
    const imp = importeDelDia(d);
    acumulado += imp;

    sum.di += +d.q_diario||0;
    sum.cu += +d.q_cuponazo||0;
    sum.su += +d.q_sueldazo||0;
    sum.eu += +d.q_euro||0;
    sum.md += +d.q_midia||0;
    sum.so += +d.q_superonce||0;
    sum.tr += +d.q_triplex||0;

    const ras = (d.p_r1||0)*PACK_RASCAS.r1 + (d.p_r2||0)*PACK_RASCAS.r2 + (d.p_r3||0)*PACK_RASCAS.r3 + (d.p_r5||0)*PACK_RASCAS.r5 + (d.p_r10||0)*PACK_RASCAS.r10;
    sum.ra += ras;
    sum.ot += +d.otros||0;
    sum.tt += imp;
  });

  jornadas = clamp(jornadas,0,25);
  const minimo = MINIMO[jornadas] || 0;
  const umbral = UMBRAL[jornadas] || 0;

  let comision = 0;
  if (acumulado > umbral){
    comision = (acumulado - umbral) * PORC_COMISION;
  }

  return {jornadas, acumulado, minimo, umbral, comision, sum, fechas};
}

/* -------------------- UI -------------------- */
function pintarSugerencia(fechaIso){
  const d = new Date(fechaIso);
  if (isNaN(d)) { $('#sugerencia').textContent = ''; return; }
  const wd = d.getDay(); // 0 Dom .. 6 S√°b (¬°ojo! en JS 0=Domingo)
  let chips = [];
  if (wd>=1 && wd<=4) chips.push('Foco: Diario');
  if (wd===5) chips.push('Viernes: Cuponazo + Eurojackpot');
  if (wd===6 || wd===0) chips.push('Fin de semana: Sueldazo');
  $('#sugerencia').innerHTML = chips.map(c=>`<span class="pill">${c}</span>`).join(' ');
}

function formToData(){
  return {
    q_diario: +$('#q_diario').value||0,
    q_cuponazo: +$('#q_cuponazo').value||0,
    q_sueldazo: +$('#q_sueldazo').value||0,
    q_euro: +$('#q_euro').value||0,
    q_midia: +$('#q_midia').value||0,
    q_superonce: +$('#q_superonce').value||0,
    q_triplex: +$('#q_triplex').value||0,
    p_r1: +$('#p_r1').value||0,
    p_r2: +$('#p_r2').value||0,
    p_r3: +$('#p_r3').value||0,
    p_r5: +$('#p_r5').value||0,
    p_r10: +$('#p_r10').value||0,
    otros: +$('#otros').value||0,
    nota: $('#nota').value||''
  };
}

function calcularImporteInput(){
  const imp = importeDelDia(formToData());
  $('#importeDia').value = imp.toFixed(2);
}

function guardarDia(){
  const fecha = $('#fecha').value;
  if (!fecha){ alert('Selecciona fecha.'); return; }
  const mes = loadMes(fecha);
  mes[fecha] = formToData();
  saveMes(fecha, mes);
  $('#alerta').textContent = `Guardado ${fecha}.`;
  renderMes(yyyymm(fecha));
}

function exportCSV(mesIso){
  const mes = loadMes(mesIso+'-01');
  const fechas = Object.keys(mes).sort();
  let lines = [];
  lines.push('Fecha,Diario,Cuponazo,Sueldazo,Euro,MiDia,SuperOnce,Triplex,Rascas(‚Ç¨),Otros(‚Ç¨),Total(‚Ç¨),Nota');

  fechas.forEach(f=>{
    const d = mes[f];
    const ras = (d.p_r1||0)*PACK_RASCAS.r1 + (d.p_r2||0)*PACK_RASCAS.r2 + (d.p_r3||0)*PACK_RASCAS.r3 + (d.p_r5||0)*PACK_RASCAS.r5 + (d.p_r10||0)*PACK_RASCAS.r10;
    const tot = importeDelDia(d);
    lines.push([
      f, d.q_diario||0, d.q_cuponazo||0, d.q_sueldazo||0, d.q_euro||0, d.q_midia||0, d.q_superonce||0, d.q_triplex||0,
      ras.toFixed(2), (d.otros||0).toFixed(2), tot.toFixed(2),
      `"${(d.nota||'').replace(/"/g,'""')}"`
    ].join(','));
  });

  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `ventas_${mesIso}.csv`; a.click();
  URL.revokeObjectURL(url);
}

function renderMes(mesIso){
  // por defecto, el mes actual
  const mesKey = mesIso || yyyymm(todayISO());
  const data = loadMes(mesKey+'-01');
  const {jornadas, acumulado, minimo, umbral, comision, sum, fechas} = resumenMes(data);

  // KPIs
  $('#kpiJornadas').textContent = jornadas;
  $('#kpiAcumulado').textContent = acumulado.toFixed(2);
  $('#kpiMinimo').textContent = minimo.toFixed(2);
  $('#kpiUmbral').textContent = umbral.toFixed(2);
  $('#kpiComision').innerHTML =
    acumulado>=umbral ? `<span class="ok">${comision.toFixed(2)}</span>` :
    acumulado>=minimo ? `<span class="warn">0.00 (superado m√≠nimo, sin comisi√≥n)</span>` :
                        `<span class="err">0.00 (falta m√≠nimo)</span>`;

  const pct = umbral>0 ? clamp(Math.round(acumulado/umbral*100),0,100) : 0;
  $('#prog').value = pct;
  $('#textoProg').textContent = `Progreso al umbral: ${pct}% ${acumulado<umbral ? `¬∑ faltan ${(umbral-acumulado).toFixed(2)}‚Ç¨` : '¬∑ ¬°objetivo conseguido!'}`;

  // Tabla
  const tbody = $('#tabla tbody');
  tbody.innerHTML = '';
  fechas.forEach(f=>{
    const d = data[f];
    const ras = (d.p_r1||0)*PACK_RASCAS.r1 + (d.p_r2||0)*PACK_RASCAS.r2 + (d.p_r3||0)*PACK_RASCAS.r3 + (d.p_r5||0)*PACK_RASCAS.r5 + (d.p_r10||0)*PACK_RASCAS.r10;
    const tot = importeDelDia(d);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${f}</td>
      <td>${d.q_diario||0}</td>
      <td>${d.q_cuponazo||0}</td>
      <td>${d.q_sueldazo||0}</td>
      <td>${d.q_euro||0}</td>
      <td>${d.q_midia||0}</td>
      <td>${d.q_superonce||0}</td>
      <td>${d.q_triplex||0}</td>
      <td>${ras.toFixed(2)}</td>
      <td>${(d.otros||0).toFixed(2)}</td>
      <td><b>${tot.toFixed(2)}</b></td>
      <td>${(d.nota||'')}</td>
    `;
    tbody.appendChild(tr);
  });

  // Totales
  $('#t_di').textContent = sum.di;
  $('#t_cu').textContent = sum.cu;
  $('#t_su').textContent = sum.su;
  $('#t_eu').textContent = sum.eu;
  $('#t_md').textContent = sum.md;
  $('#t_so').textContent = sum.so;
  $('#t_tr').textContent = sum.tr;
  $('#t_ra').textContent = sum.ra.toFixed(2);
  $('#t_ot').textContent = sum.ot.toFixed(2);
  $('#t_tt').textContent = sum.tt.toFixed(2);
}

/* -------------------- EVENTOS -------------------- */
function initFechaHoy(){
  $('#fecha').value = todayISO();
  pintarSugerencia($('#fecha').value);
}

['#q_diario','#q_cuponazo','#q_sueldazo','#q_euro','#q_midia','#q_superonce','#q_triplex','#p_r1','#p_r2','#p_r3','#p_r5','#p_r10','#otros']
  .forEach(sel => document.addEventListener('input', e=>{
    if (e.target.matches(sel)) calcularImporteInput();
  }));

$('#fecha').addEventListener('change', e=>{
  pintarSugerencia(e.target.value);
});

$('#btnCalcular').addEventListener('click', calcularImporteInput);
$('#btnGuardar').addEventListener('click', guardarDia);
$('#btnExport').addEventListener('click', ()=>{
  const mesIso = yyyymm($('#fecha').value || todayISO());
  exportCSV(mesIso);
});
$('#btnReset').addEventListener('click', ()=>{
  const mesIso = yyyymm($('#fecha').value || todayISO());
  if (confirm(`¬øBorrar todos los d√≠as del mes ${mesIso}?`)){
    localStorage.removeItem('once:'+mesIso);
    renderMes(mesIso);
    $('#alerta').textContent = `Mes ${mesIso} eliminado.`;
  }
});

$('#btnTema').addEventListener('click', ()=>{
  const html = document.documentElement;
  html.dataset.theme = html.dataset.theme === 'dark' ? '' : 'dark';
  try{ localStorage.setItem('once:tema', html.dataset.theme || 'light'); }catch{}
});

/* -------------------- ARRANQUE -------------------- */
(function start(){
  // tema
  try{
    const t = localStorage.getItem('once:tema');
    if (t==='dark') document.documentElement.dataset.theme = 'dark';
  }catch{}
  initFechaHoy();
  renderMes();
  calcularImporteInput();

  // PWA (no rompe si no existen los archivos)
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('./service-worker.js')
      .then(()=>console.log('SW: ok'))
      .catch(()=>console.log('SW: no disponible (omitido)'));
  }
})();
</script>
</body>
</html>
