<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Comisiones ONCE 2025</title>

  <!-- PWA -->
  <meta name="theme-color" content="#d62828" />
  <link rel="manifest" href="./manifest.json" />

  <!-- Favicon: SVG embebido (evita 404). Adem√°s sube favicon.png (ver manifest). -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23d62828"/><text x="50" y="62" font-size="54" text-anchor="middle" fill="white" font-family="Arial, sans-serif">O</text></svg>' type="image/svg+xml">

  <style>
    :root { --bg:#fff; --fg:#111; --primary:#d62828; --secondary:#fcbf49; --accent:#003049; }
    [data-theme="dark"] { --bg:#1e1e1e; --fg:#f5f5f5; --primary:#ff595e; --secondary:#ffca3a; --accent:#8ac926; }
    *{box-sizing:border-box}
    body { font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--fg); margin:0; }
    header { padding:1rem; background:var(--primary); color:#fff; display:flex; gap:.5rem; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    header h1{font-size:1.1rem; margin:0}
    .wrap{ padding:1rem; max-width:900px; margin:0 auto; }
    .card{ background:var(--secondary); color:var(--accent); border-radius:12px; padding:1rem; }
    label{display:block; font-weight:600; margin-top:.5rem}
    select, input[type=number], input[type=date], input[type=month], button { width:100%; padding:.7rem; margin-top:.3rem; font-size:1rem; border-radius:10px; border:1px solid #0001; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:.8rem; }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:.8rem; }
    .mt{ margin-top:1rem; }
    .resultado{ background:#fff7; color:inherit; border-radius:10px; padding:1rem; margin-top:.8rem; }
    .alerta{font-weight:700; padding:.5rem; border-radius:6px; margin-top:.5rem}
    .verde{background:#d4edda; color:#155724}
    .naranja{background:#fff3cd; color:#856404}
    .rojo{background:#f8d7da; color:#721c24}
    .toolbar{display:flex; gap:.5rem; flex-wrap:wrap}
    .btn{ background:#000; color:#fff; border:none; cursor:pointer; padding:.7rem 1rem; border-radius:10px; }
    .btn.secondary{ background:var(--accent) }
    .btn.ghost{ background:transparent; color:#fff; border:1px solid #fff8 }
    small.mono{font-family:ui-monospace, Menlo, Consolas, monospace; opacity:.85}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:.6rem}
    @media (max-width:640px){ .row,.row3,.grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>Calculadora de Comisiones ONCE 2025</h1>
    <div class="toolbar">
      <button id="btnInstalar" class="btn ghost" hidden>üì≤ Instalar</button>
      <button id="btnTema" class="btn ghost">üåó Tema</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row3">
        <div>
          <label>Tipo de producto</label>
          <select id="tipo">
            <option value="diario">Diario (2‚Ç¨)</option>
            <option value="cuponazo">Cuponazo (3‚Ç¨)</option>
            <option value="sueldazo">Sueldazo (2‚Ç¨)</option>
            <option value="rasca">Rascas (1‚Äì10‚Ç¨)</option>
            <option value="triplex">Triplex (0,50‚Ç¨)</option>
            <option value="superonce">Super Once (1‚Ç¨)</option>
            <option value="midia">Mi D√≠a (1‚Ç¨)</option>
            <option value="eurojackpot">Eurojackpot (2‚Ç¨)</option>
            <option value="extraordinario">Extraordinario (2,50‚Ç¨)</option>
            <option value="resto">Otros</option>
          </select>
        </div>
        <div>
          <label>D√≠as trabajados (1‚Äì26)</label>
          <input id="dias" type="number" value="20" min="1" max="26" />
        </div>
        <div>
          <label>Precio por cup√≥n (‚Ç¨)</label>
          <input id="precio" type="number" value="2" step="0.1" />
        </div>
      </div>

      <div class="row mt">
        <div>
          <label>Unidades vendidas</label>
          <input id="vendidos" type="number" value="0" min="0" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnCalcular" class="btn secondary">üî¢ Calcular</button>
        </div>
      </div>

      <div id="resultado" class="resultado mt">
        <small class="mono">Introduce datos y pulsa Calcular</small>
      </div>

      <div class="grid2 mt">
        <div>
          <label>Guardar como d√≠a del mes</label>
          <div class="row">
            <input id="fecha" type="date" />
            <button id="btnGuardar" class="btn">üíæ Guardar</button>
          </div>
          <small class="mono">Se guarda en tu dispositivo (localStorage).</small>
        </div>
        <div>
          <label>Resumen del mes</label>
          <div class="row">
            <input id="mes" type="month" />
            <button id="btnResumen" class="btn">üìÖ Ver resumen</button>
          </div>
          <div id="resumen" class="resultado" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Datos base ---
    const preciosPorDefecto = {
      diario: 2, cuponazo: 3, sueldazo: 2,
      rasca: 1, triplex: 0.5, superonce: 1,
      midia: 1, eurojackpot: 2, extraordinario: 2.5, resto: 1.5
    };

    // Porcentaje por familia (aprox)
    const porcentajePorFamilia = {
      muyAlto: 0.105,  // 10,5%
      alto:    0.14,   // 14%
      resto:   0.10    // 10%
    };

    // Familia por tipo
    const familiaTipo = {
      diario: 'resto',
      cuponazo: 'resto',
      sueldazo: 'resto',
      rasca: 'resto',
      triplex: 'resto',
      superonce: 'resto',
      midia: 'resto',
      eurojackpot: 'resto',
      extraordinario: 'alto',
      resto: 'resto'
    };

    // Regla accesible (gen√©rica): m√≠nimo/umbral por d√≠as y precio
    function minUmbral(dias, precio) {
      const minimo = dias * precio * 71;
      const umbral  = dias * precio * 105;
      return { minimo, umbral };
    }

    // --- UI refs ---
    const tipoEl = document.getElementById('tipo');
    const diasEl = document.getElementById('dias');
    const precioEl = document.getElementById('precio');
    const vendidosEl = document.getElementById('vendidos');
    const resEl = document.getElementById('resultado');

    const fechaEl = document.getElementById('fecha');
    const btnGuardar = document.getElementById('btnGuardar');
    const mesEl = document.getElementById('mes');
    const btnResumen = document.getElementById('btnResumen');
    const resumenEl = document.getElementById('resumen');

    // Autoprecio al cambiar tipo
    tipoEl.addEventListener('change', () => {
      precioEl.value = preciosPorDefecto[tipoEl.value] ?? 1.5;
    });

    // Calcular
    document.getElementById('btnCalcular').addEventListener('click', () => {
      const tipo = tipoEl.value;
      const dias = +diasEl.value || 0;
      const vendidos = +vendidosEl.value || 0;
      const precio = +precioEl.value || preciosPorDefecto[tipo] || 1.5;

      const total = vendidos * precio;
      const { minimo, umbral } = minUmbral(dias, precio);

      // Comisi√≥n solo si supera umbral
      const pct = porcentajePorFamilia[familiaTipo[tipo]] || porcentajePorFamilia.resto;
      const comision = total >= umbral ? total * pct : 0;

      const alertaClase = total >= umbral ? 'verde' : (total >= minimo ? 'naranja' : 'rojo');
      const alertaTexto  = total >= umbral ? '‚úÖ Superado UMBRAL (cobra comisi√≥n)'
                         : total >= minimo ? '‚ö†Ô∏è Superado M√çNIMO (sin comisi√≥n)'
                         : '‚ùå Por debajo del m√≠nimo';

      resEl.innerHTML = `
        <div><b>Tipo:</b> ${tipo} | <b>Familia:</b> ${familiaTipo[tipo]}</div>
        <div>üî¢ Vendidos: <b>${vendidos}</b> √ó ${precio.toFixed(2)} ‚Ç¨ = <b>${total.toFixed(2)} ‚Ç¨</b></div>
        <div>üìÖ D√≠as: <b>${dias}</b> ‚Üí M√≠nimo: <b>${minimo.toFixed(2)} ‚Ç¨</b> | Umbral: <b>${umbral.toFixed(2)} ‚Ç¨</b></div>
        <div>üìà % comisi√≥n (si supera umbral): <b>${(pct*100).toFixed(1)}%</b></div>
        <div>üí∞ Ganancia estimada: <b>${comision.toFixed(2)} ‚Ç¨</b></div>
        <div class="alerta ${alertaClase}">${alertaTexto}</div>
      `;
    });

    // Tema
    document.getElementById('btnTema').addEventListener('click', () => {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', html.dataset.theme || 'light');
    });
    // Restaurar tema
    (function(){
      const t = localStorage.getItem('theme') || 'light';
      if (t === 'dark') document.documentElement.dataset.theme = 'dark';
    })();

    // Guardar d√≠a (localStorage)
    btnGuardar.addEventListener('click', () => {
      const f = fechaEl.value;
      if (!f) { alert('Elige fecha.'); return; }
      const registro = JSON.parse(localStorage.getItem('ventasONCE') || '{}');
      const data = {
        tipo: tipoEl.value,
        dias: +diasEl.value || 0,
        vendidos: +vendidosEl.value || 0,
        precio: +precioEl.value || preciosPorDefecto[tipoEl.value] || 1.5
      };
      registro[f] = data;
      localStorage.setItem('ventasONCE', JSON.stringify(registro));
      alert('Guardado ‚úî');
    });

    // Resumen del mes
    btnResumen.addEventListener('click', () => {
      const m = mesEl.value; // yyyy-mm
      if (!m) { alert('Elige mes.'); return; }
      const registro = JSON.parse(localStorage.getItem('ventasONCE') || '{}');
      let totalEuros = 0, totalUnidades = 0;

      Object.entries(registro).forEach(([fecha, d]) => {
        if (fecha.startsWith(m)) {
          totalUnidades += d.vendidos;
          totalEuros += d.vendidos * d.precio;
        }
      });

      resumenEl.style.display = 'block';
      resumenEl.innerHTML = `
        <b>Mes:</b> ${m}<br>
        üßæ Unidades: <b>${totalUnidades}</b><br>
        üí∂ Ventas: <b>${totalEuros.toFixed(2)} ‚Ç¨</b>
      `;
    });

    // --- PWA: instalaci√≥n + SW ---
    let deferredPrompt = null;
    const btnInstalar = document.getElementById('btnInstalar');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();             // control manual del banner
      deferredPrompt = e;
      btnInstalar.hidden = false;     // muestro bot√≥n
    });

    btnInstalar.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      btnInstalar.hidden = true;
      deferredPrompt = null;
    });

    (async function registrarSW(){
      if (!('serviceWorker' in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.register('./service-worker.js', { scope: './' });
        console.log('SW registrado', reg.scope);
      } catch (err) {
        console.log('SW no disponible:', err?.message || err);
      }
    })();
  </script>
</body>
</html>
