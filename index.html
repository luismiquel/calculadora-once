<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora Comisiones ONCE 2025</title>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#0b1320; --fg:#e8eefc; --muted:#9bb0cc; --card:#111a2c; --accent:#4da3ff; --good:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --border:#1f2a44;
      --focus: 0 0 0 3px rgba(77,163,255,.25);
    }
    [data-theme="light"]{
      --bg:#f4f7fb; --fg:#0e1624; --muted:#456; --card:#ffffff; --accent:#1e71ff; --good:#1ea64b; --warn:#b58900; --bad:#c0392b; --border:#dfe7f2;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    .wrap{max-width:980px;margin-inline:auto;padding:20px;}
    h1{font-size:clamp(22px,3.5vw,30px);margin:0 0 14px}
    .row{display:grid;gap:16px}
    @media(min-width:720px){.row{grid-template-columns:1.2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,button{font:inherit}
    input[type="number"], input[type="date"], input[type="month"], select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
    input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,select:focus{outline:var(--focus)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(4,1fr)}}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--fg)}
    .btn:focus{outline:var(--focus)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-variant-numeric:tabular-nums}
    th:first-child,td:first-child{text-align:left}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .kpi .box{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:12px}
    .kpi .val{font-size:18px;font-weight:600}
    progress{width:100%;height:14px}
    .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .pill{border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:transparent;color:var(--fg);cursor:pointer}
    .danger{color:#fff;background:var(--bad);border-color:transparent}
    .ok{color:#fff;background:var(--good);border-color:transparent}
    .tips{font-size:13px;color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="head">
      <h1>Calculadora ONCE 2025 ‚Äî Registro diario con calendario</h1>
      <div class="switch">
        <button id="toggleTheme" class="pill" title="Cambiar tema">üåó Tema</button>
        <button id="exportCsv" class="pill" title="Exportar a CSV">‚¨áÔ∏è CSV</button>
        <button id="resetMes" class="pill danger" title="Borrar datos del mes">üóëÔ∏è Borrar mes</button>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <h2 style="margin-top:0">A√±adir ventas de un d√≠a</h2>
        <div class="grid">
          <div>
            <label>Fecha</label>
            <input type="date" id="fecha" />
          </div>
          <div>
            <label>Jornada tipo (s√≥lo informativo)</label>
            <select id="tipoJornada">
              <option value="libre">Libre</option>
              <option value="diario">L-J Diario</option>
              <option value="cuponazo">Viernes Cuponazo</option>
              <option value="sueldazo">S-D Sueldazo</option>
              <option value="eurojackpot">Mar/Vie Eurojackpot</option>
            </select>
          </div>
        </div>

        <h3>Cupones</h3>
        <div class="grid">
          <div>
            <label>Diario (2‚Ç¨) ‚Äî L-J</label>
            <input type="number" id="nDiario" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Cuponazo (3‚Ç¨) ‚Äî Vie</label>
            <input type="number" id="nCuponazo" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Sueldazo (2‚Ç¨) ‚Äî S-D</label>
            <input type="number" id="nSueldazo" min="0" step="1" placeholder="0" />
          </div>
        </div>

        <h3 style="margin-top:12px">Rascas (por libros)</h3>
        <div class="grid">
          <div>
            <label>Rasca 1‚Ç¨ (libro=100‚Ç¨)</label>
            <input type="number" id="libroR1" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Rasca 2‚Ç¨ (libro=100‚Ç¨)</label>
            <input type="number" id="libroR2" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Rasca 3‚Ç¨ (libro=150‚Ç¨)</label>
            <input type="number" id="libroR3" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Rasca 5‚Ç¨ (libro=150‚Ç¨)</label>
            <input type="number" id="libroR5" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Rasca 10‚Ç¨ (libro=150‚Ç¨)</label>
            <input type="number" id="libroR10" min="0" step="1" placeholder="0" />
          </div>
        </div>

        <h3 style="margin-top:12px">Productos activos</h3>
        <div class="grid">
          <div>
            <label>Triples (0,50‚Ç¨ por apuesta)</label>
            <input type="number" id="nTriples" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>SuperONCE (importe en ‚Ç¨)</label>
            <input type="number" id="eurosSuperonce" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Mi D√≠a (1‚Ç¨ por apuesta)</label>
            <input type="number" id="nMiDia" min="0" step="1" placeholder="0" />
          </div>
          <div>
            <label>Eurojackpot (2‚Ç¨ por apuesta)</label>
            <input type="number" id="nEurojackpot" min="0" step="1" placeholder="0" />
          </div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="guardarDia">üíæ Guardar d√≠a</button>
          <button class="btn secondary" id="limpiarForm">‚Ü∫ Limpiar</button>
        </div>
        <p class="tips">Consejo: rellena s√≥lo lo que hayas vendido ese d√≠a. Si vuelves a guardar la misma fecha, se <b>sumar√°</b> a lo ya guardado.</p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">Resumen del mes</h2>
        <div class="kpi">
          <div class="box">
            <div class="muted">Jornadas trabajadas</div>
            <div class="val mono" id="kpiJornadas">0</div>
          </div>
          <div class="box">
            <div class="muted">Vendido acumulado (‚Ç¨)</div>
            <div class="val mono" id="kpiVendido">0,00</div>
          </div>
          <div class="box">
            <div class="muted">M√≠nimo (142‚Ç¨/jornada)</div>
            <div class="val mono" id="kpiMinimo">0,00</div>
          </div>
          <div class="box">
            <div class="muted">Umbral (210‚Ç¨/jornada)</div>
            <div class="val mono" id="kpiUmbral">0,00</div>
          </div>
        </div>
        <div style="margin-top:14px">
          <label>Progreso a m√≠nimo</label>
          <progress id="progMin" value="0" max="1"></progress>
          <div class="muted mono" id="txtMin"></div>
        </div>
        <div style="margin-top:10px">
          <label>Progreso a umbral</label>
          <progress id="progUmb" value="0" max="1"></progress>
          <div class="muted mono" id="txtUmb"></div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <h2 style="margin:0">Ventas del mes (d√≠a a d√≠a)</h2>
        <div>
          <label class="muted" for="mesSel">Mes</label>
          <input type="month" id="mesSel" />
        </div>
      </div>

      <div style="overflow:auto;margin-top:10px">
        <table id="tabla">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Diario</th>
              <th>Cuponazo</th>
              <th>Sueldazo</th>
              <th>R1‚Ç¨ (libros)</th>
              <th>R2‚Ç¨</th>
              <th>R3‚Ç¨</th>
              <th>R5‚Ç¨</th>
              <th>R10‚Ç¨</th>
              <th>Triples</th>
              <th>SuperONCE ‚Ç¨</th>
              <th>Mi D√≠a</th>
              <th>Eurojackpot</th>
              <th>Total ‚Ç¨</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>
    </section>

    <p class="tips">M√≠nimo y umbral se calculan como: <b>142‚Ç¨</b> y <b>210‚Ç¨</b> por jornada trabajada (un d√≠a con ventas &gt; 0). Tus datos se guardan autom√°ticamente en este dispositivo (localStorage) por mes.</p>
  </div>

  <script>
  (function(){
    const EL = (id)=>document.getElementById(id);

    const PRICES = {
      diario: 2,
      cuponazo: 3,
      sueldazo: 2,
      triples: 0.5,
      miDia: 1,
      eurojackpot: 2
    };

    const LIBROS_RASCAS = { r1:100, r2:100, r3:150, r5:150, r10:150 };

    const KEY = 'calcOnce.diario.v2';

    const fecha = EL('fecha');
    const tipoJornada = EL('tipoJornada');
    const nDiario = EL('nDiario');
    const nCuponazo = EL('nCuponazo');
    const nSueldazo = EL('nSueldazo');
    const libroR1 = EL('libroR1');
    const libroR2 = EL('libroR2');
    const libroR3 = EL('libroR3');
    const libroR5 = EL('libroR5');
    const libroR10 = EL('libroR10');
    const nTriples = EL('nTriples');
    const eurosSuperonce = EL('eurosSuperonce');
    const nMiDia = EL('nMiDia');
    const nEurojackpot = EL('nEurojackpot');

    const guardarDia = EL('guardarDia');
    const limpiarForm = EL('limpiarForm');
    const exportCsv = EL('exportCsv');
    const resetMes = EL('resetMes');
    const toggleTheme = EL('toggleTheme');

    const kpiJornadas = EL('kpiJornadas');
    const kpiVendido = EL('kpiVendido');
    const kpiMinimo = EL('kpiMinimo');
    const kpiUmbral = EL('kpiUmbral');
    const progMin = EL('progMin');
    const progUmb = EL('progUmb');
    const txtMin = EL('txtMin');
    const txtUmb = EL('txtUmb');

    const mesSel = EL('mesSel');
    const tbody = document.querySelector('#tabla tbody');
    const tfoot = document.querySelector('#tabla tfoot');

    const today = new Date();
    fecha.valueAsDate = today;
    mesSel.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

    // Tema
    (function initTheme(){
      const saved = localStorage.getItem('calcOnce.theme') || 'dark';
      if(saved==='light') document.documentElement.setAttribute('data-theme','light');
      toggleTheme.addEventListener('click',()=>{
        const isLight = document.documentElement.getAttribute('data-theme')==='light';
        if(isLight){ document.documentElement.removeAttribute('data-theme'); localStorage.setItem('calcOnce.theme','dark'); }
        else { document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('calcOnce.theme','light'); }
      });
    })();

    function load(){
      try{ return JSON.parse(localStorage.getItem(KEY) || '{}'); }catch{ return {}; }
    }
    function save(data){ localStorage.setItem(KEY, JSON.stringify(data)); }

    function getMonthData(yyyymm){
      const data = load();
      return data[yyyymm] || {};
    }
    function setMonthData(yyyymm, monthObj){
      const data = load();
      data[yyyymm] = monthObj;
      save(data);
    }

    function fmtEur(n){ return (n||0).toLocaleString('es-ES',{minimumFractionDigits:2, maximumFractionDigits:2}); }

    function calcTotal(entry){
      const totalCupones = (entry.diario||0)*PRICES.diario + (entry.cuponazo||0)*PRICES.cuponazo + (entry.sueldazo||0)*PRICES.sueldazo;
      const totalRascas = (entry.r1||0)*LIBROS_RASCAS.r1 + (entry.r2||0)*LIBROS_RASCAS.r2 + (entry.r3||0)*LIBROS_RASCAS.r3 + (entry.r5||0)*LIBROS_RASCAS.r5 + (entry.r10||0)*LIBROS_RASCAS.r10;
      const totalActivos = (entry.triples||0)*PRICES.triples + (entry.superonce||0) + (entry.miDia||0)*PRICES.miDia + (entry.eurojackpot||0)*PRICES.eurojackpot;
      return totalCupones + totalRascas + totalActivos;
    }

    function render(){
      const yyyymm = mesSel.value;
      const month = getMonthData(yyyymm);
      const fechas = Object.keys(month).sort();

      // Tabla
      tbody.innerHTML = '';
      let tot = {diario:0,cuponazo:0,sueldazo:0,r1:0,r2:0,r3:0,r5:0,r10:0,triples:0,superonce:0,miDia:0,eurojackpot:0};
      let vendido = 0; let jornadas = 0;
      for(const f of fechas){
        const e = month[f];
        const rowTotal = calcTotal(e);
        if(rowTotal>0) jornadas++;
        vendido += rowTotal;
        for(const k in tot){ tot[k]+= (e[k]||0); }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="white-space:nowrap">${f}</td>
          <td>${e.diario||0}</td>
          <td>${e.cuponazo||0}</td>
          <td>${e.sueldazo||0}</td>
          <td>${e.r1||0}</td>
          <td>${e.r2||0}</td>
          <td>${e.r3||0}</td>
          <td>${e.r5||0}</td>
          <td>${e.r10||0}</td>
          <td>${e.triples||0}</td>
          <td>${fmtEur(e.superonce||0)}</td>
          <td>${e.miDia||0}</td>
          <td>${e.eurojackpot||0}</td>
          <td class="mono">${fmtEur(rowTotal)}</td>
          <td><button class="pill" data-del="${f}">üóëÔ∏è</button></td>`;
        tbody.appendChild(tr);
      }

      const totEur = calcTotal(tot);
      tfoot.innerHTML = `
        <tr>
          <th>Total</th>
          <th>${tot.diario}</th>
          <th>${tot.cuponazo}</th>
          <th>${tot.sueldazo}</th>
          <th>${tot.r1}</th>
          <th>${tot.r2}</th>
          <th>${tot.r3}</th>
          <th>${tot.r5}</th>
          <th>${tot.r10}</th>
          <th>${tot.triples}</th>
          <th class="mono">${fmtEur(tot.superonce)}</th>
          <th>${tot.miDia}</th>
          <th>${tot.eurojackpot}</th>
          <th class="mono">${fmtEur(totEur)}</th>
          <th></th>
        </tr>`;

      // KPIs y progresos
      const minimo = 142 * jornadas;
      const umbral = 210 * jornadas;
      kpiJornadas.textContent = jornadas;
      kpiVendido.textContent = fmtEur(vendido);
      kpiMinimo.textContent = fmtEur(minimo);
      kpiUmbral.textContent = fmtEur(umbral);

      const vMin = minimo>0? Math.min(1, vendido/minimo): 0;
      const vUmb = umbral>0? Math.min(1, vendido/umbral): 0;
      progMin.value = vMin; progUmb.value = vUmb;
      txtMin.textContent = vendido>=minimo? `‚úÖ Alcanzado. +${fmtEur(vendido-minimo)} sobre m√≠nimo.` : `Faltan ${fmtEur(minimo-vendido)} para el m√≠nimo.`;
      txtUmb.textContent = vendido>=umbral? `‚úÖ Alcanzado. +${fmtEur(vendido-umbral)} sobre umbral.` : `Faltan ${fmtEur(umbral-vendido)} para el umbral.`;

      // Borrado por fila
      tbody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const f = btn.getAttribute('data-del');
          const data = load();
          if(data[yyyymm]){ delete data[yyyymm][f]; save(data); render(); }
        })
      })
    }

    function sumaGuardada(prev, add){
      const out = {...(prev||{})};
      const keys = ['diario','cuponazo','sueldazo','r1','r2','r3','r5','r10','triples','superonce','miDia','eurojackpot'];
      for(const k of keys){ out[k] = (out[k]||0) + (add[k]||0); }
      return out;
    }

    guardarDia.addEventListener('click',()=>{
      if(!fecha.value){ alert('Selecciona una fecha.'); return; }
      const d = new Date(fecha.value);
      const yyyymm = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const key = d.toISOString().slice(0,10);

      const entry = {
        diario: +nDiario.value||0,
        cuponazo: +nCuponazo.value||0,
        sueldazo: +nSueldazo.value||0,
        r1: +libroR1.value||0,
        r2: +libroR2.value||0,
        r3: +libroR3.value||0,
        r5: +libroR5.value||0,
        r10: +libroR10.value||0,
        triples: +nTriples.value||0,
        superonce: +eurosSuperonce.value||0,
        miDia: +nMiDia.value||0,
        eurojackpot: +nEurojackpot.value||0,
        tipo: tipoJornada.value
      };

      const data = load();
      data[yyyymm] = data[yyyymm] || {};
      data[yyyymm][key] = sumaGuardada(data[yyyymm][key], entry);
      save(data);
      render();
    });

    limpiarForm.addEventListener('click',()=>{
      [nDiario,nCuponazo,nSueldazo,libroR1,libroR2,libroR3,libroR5,libroR10,nTriples,eurosSuperonce,nMiDia,nEurojackpot].forEach(i=>i.value='');
    });

    mesSel.addEventListener('change', render);

    exportCsv.addEventListener('click',()=>{
      const yyyymm = mesSel.value;
      const month = getMonthData(yyyymm);
      const fechas = Object.keys(month).sort();
      if(fechas.length===0){ alert('No hay ventas en el mes seleccionado.'); return; }
      const rows = [
        ['Fecha','Diario','Cuponazo','Sueldazo','R1‚Ç¨(libros)','R2‚Ç¨','R3‚Ç¨','R5‚Ç¨','R10‚Ç¨','Triples','SuperONCE ‚Ç¨','Mi D√≠a','Eurojackpot','Total ‚Ç¨']
      ];
      let tot = {diario:0,cuponazo:0,sueldazo:0,r1:0,r2:0,r3:0,r5:0,r10:0,triples:0,superonce:0,miDia:0,eurojackpot:0};
      for(const f of fechas){
        const e = month[f];
        const tEur = calcTotal(e);
        rows.push([f,e.diario||0,e.cuponazo||0,e.sueldazo||0,e.r1||0,e.r2||0,e.r3||0,e.r5||0,e.r10||0,e.triples||0,(e.superonce||0).toFixed(2),e.miDia||0,e.eurojackpot||0,tEur.toFixed(2)]);
        for(const k in tot){ tot[k]+= (e[k]||0); }
      }
      const totEur2 = calcTotal(tot);
      rows.push(['TOTAL',tot.diario,tot.cuponazo,tot.sueldazo,tot.r1,tot.r2,tot.r3,tot.r5,tot.r10,tot.triples,tot.superonce.toFixed(2),tot.miDia,tot.eurojackpot,totEur2.toFixed(2)]);

      // CSV con saltos de l√≠nea correctos
      const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `ventas_${yyyymm}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    resetMes.addEventListener('click',()=>{
      const yyyymm = mesSel.value;
      if(!confirm(`¬øBorrar todos los datos de ${yyyymm}?`)) return;
      const data = load();
      delete data[yyyymm];
      save(data);
      render();
    });

    // Inicial
    render();
  })();

  // Registro del Service Worker (silencioso, sin errores en consola si 404)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('SW registrado', reg.scope))
        .catch(() => console.warn('SW no encontrado (404). Registro omitido.'));
    });
  }
  </script>
</body>
</html>
