<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Comisiones ONCE 2025</title>

  <!-- PWA -->
  <meta name="theme-color" content="#d62828" />
  <link rel="manifest" href="./manifest.json" />

  <!-- Favicon embebido (evita 404). Puedes subir tambi√©n favicon.png para el manifest -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23d62828"/><text x="50" y="62" font-size="54" text-anchor="middle" fill="white" font-family="Arial, sans-serif">O</text></svg>' type="image/svg+xml">

  <style>
    :root { --bg:#fff; --fg:#111; --primary:#d62828; --secondary:#fcbf49; --accent:#003049; }
    [data-theme="dark"] { --bg:#1e1e1e; --fg:#f5f5f5; --primary:#ff595e; --secondary:#ffca3a; --accent:#8ac926; }
    *{box-sizing:border-box}
    body { font-family: system-ui, Arial, sans-serif; background: var(--bg); color: var(--fg); margin:0; }
    header { padding:1rem; background:var(--primary); color:#fff; display:flex; gap:.5rem; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    header h1{font-size:1.05rem; margin:0}
    .wrap{ padding:1rem; max-width:980px; margin:0 auto; }
    .card{ background:var(--secondary); color:var(--accent); border-radius:12px; padding:1rem; }
    label{display:block; font-weight:600; margin-top:.5rem}
    select, input[type=number], input[type=date], input[type=month], button { width:100%; padding:.7rem; margin-top:.3rem; font-size:1rem; border-radius:10px; border:1px solid #0001; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:.8rem; }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:.8rem; }
    .mt{ margin-top:1rem; }
    .resultado{ background:#fff7; color:inherit; border-radius:10px; padding:1rem; margin-top:.8rem; }
    .alerta{font-weight:700; padding:.5rem; border-radius:6px; margin-top:.5rem}
    .verde{background:#d4edda; color:#155724}
    .naranja{background:#fff3cd; color:#856404}
    .rojo{background:#f8d7da; color:#721c24}
    .toolbar{display:flex; gap:.5rem; flex-wrap:wrap}
    .btn{ background:#000; color:#fff; border:none; cursor:pointer; padding:.7rem 1rem; border-radius:10px; }
    .btn.secondary{ background:var(--accent) }
    .btn.ghost{ background:transparent; color:#fff; border:1px solid #fff8 }
    small.mono{font-family:ui-monospace, Menlo, Consolas, monospace; opacity:.85}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:.6rem}
    @media (max-width:640px){ .row,.row3,.grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <h1>Calculadora de Comisiones ONCE 2025</h1>
    <div class="toolbar">
      <button id="btnInstalar" class="btn ghost" hidden>üì≤ Instalar</button>
      <button id="btnTema" class="btn ghost">üåó Tema</button>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row3">
        <div>
          <label>Tipo de producto</label>
          <select id="tipo">
            <option value="diario">Diario (2‚Ç¨)</option>
            <option value="cuponazo">Cuponazo (3‚Ç¨)</option>
            <option value="sueldazo">Sueldazo (2‚Ç¨)</option>
            <option value="rasca">Rascas (1‚Äì10‚Ç¨)</option>
            <option value="triplex">Triplex (0,50‚Ç¨)</option>
            <option value="superonce">Super Once (1‚Ç¨)</option>
            <option value="midia">Mi D√≠a (1‚Ç¨)</option>
            <option value="eurojackpot">Eurojackpot (2‚Ç¨)</option>
            <option value="extraordinario">Extraordinario (2,50‚Ç¨)</option>
            <option value="resto">Otros</option>
          </select>
        </div>
        <div>
          <label>D√≠as trabajados (1‚Äì25)</label>
          <input id="dias" type="number" value="20" min="1" max="25" />
        </div>
        <div>
          <label>Precio por unidad (‚Ç¨)</label>
          <input id="precio" type="number" value="2" step="0.1" />
        </div>
      </div>

      <div class="row mt">
        <div>
          <label>Unidades vendidas</label>
          <input id="vendidos" type="number" value="0" min="0" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="btnCalcular" class="btn secondary">üî¢ Calcular</button>
        </div>
      </div>

      <div id="resultado" class="resultado mt">
        <small class="mono">Introduce datos y pulsa Calcular</small>
      </div>

      <div class="grid2 mt">
        <div>
          <label>Guardar como d√≠a del mes</label>
          <div class="row">
            <input id="fecha" type="date" />
            <button id="btnGuardar" class="btn">üíæ Guardar</button>
          </div>
          <small class="mono">Se guarda en tu dispositivo (localStorage).</small>
        </div>
        <div>
          <label>Resumen del mes</label>
          <div class="row">
            <input id="mes" type="month" />
            <button id="btnResumen" class="btn">üìÖ Ver resumen</button>
          </div>
          <div id="resumen" class="resultado" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    //  DATOS OFICIALES 2025
    // =========================
    // Familias y porcentajes por ESCALA (8 tramos; columna 1 ya es el UMBRAL)
    // MUY ALTO:   [1.5, 4.0, 7.0, 8.5, 9.0, 9.5, 10.0, 10.5]
    // ALTO:       [2.0, 5.0, 8.5, 11.5, 12.0, 12.5, 13.0, 14.0]
    // RESTO:      [2.5, 6.0, 10.0, 13.0, 14.0, 15.0, 16.0, 17.5]

    const PERCENTS = {
      muyAlto:  [1.5, 4.0, 7.0, 8.5, 9.0, 9.5, 10.0, 10.5],
      alto:     [2.0, 5.0, 8.5, 11.5, 12.0, 12.5, 13.0, 14.0],
      resto:    [2.5, 6.0, 10.0, 13.0, 14.0, 15.0, 16.0, 17.5]
    };

    // Familia por tipo de producto
    const FAMILIA = {
      diario: 'resto',
      cuponazo: 'resto',
      sueldazo: 'resto',
      rasca: 'resto',
      triplex: 'resto',
      superonce: 'resto',
      midia: 'resto',
      eurojackpot: 'resto',
      extraordinario: 'alto', // Extraordinarios tienen su tabla especial (se ignoran escalas)
      resto: 'resto'
    };

    // Precios por defecto
    const PRECIO_DEF = {
      diario: 2, cuponazo: 3, sueldazo: 2,
      rasca: 1, triplex: 0.5, superonce: 1,
      midia: 1, eurojackpot: 2, extraordinario: 2.5, resto: 1.5
    };

    // Tabla accesible 2025 (por jornadas). Cada fila:
    // { dias, umbral, minimo, escalas[8] } (escalas = [umbral, tramo2, ..., tramo8] en ‚Ç¨)
    // Fuente: tabla accesible 2025 (valores en euros).
    const TABLA = [
      {d:1,  u:210,  m:142,  e:[210,289,344,400,455,510,566,677]},
      {d:2,  u:420,  m:284,  e:[420,578,688,800,910,1020,1132,1354]},
      {d:3,  u:630,  m:426,  e:[630,867,1032,1200,1365,1530,1698,2031]},
      {d:4,  u:840,  m:568,  e:[840,1156,1376,1600,1820,2040,2264,2708]},
      {d:5,  u:1050, m:710,  e:[1050,1445,1720,2000,2275,2550,2830,3385]},
      {d:6,  u:1260, m:852,  e:[1260,1734,2064,2400,2730,3060,3396,4062]},
      {d:7,  u:1470, m:994,  e:[1470,2023,2408,2800,3185,3570,3962,4739]},
      {d:8,  u:1680, m:1136, e:[1680,2312,2752,3200,3640,4080,4528,5416]},
      {d:9,  u:1890, m:1278, e:[1890,2601,3096,3600,4095,4590,5094,6093]},
      {d:10, u:2100, m:1420, e:[2100,2890,3440,4000,4550,5100,5660,6770]},
      {d:11, u:2310, m:1562, e:[2310,3179,3784,4400,5005,5610,6226,7447]},
      {d:12, u:2520, m:1704, e:[2520,3468,4128,4800,5460,6120,6792,8124]},
      {d:13, u:2730, m:1846, e:[2730,3757,4472,5200,5915,6630,7358,8801]},
      {d:14, u:2940, m:1988, e:[2940,4046,4816,5600,6370,7140,7924,9478]},
      {d:15, u:3150, m:2130, e:[3150,4335,5160,6000,6825,7650,8490,10155]},
      {d:16, u:3360, m:2272, e:[3360,4624,5504,6400,7280,8160,9056,10832]},
      {d:17, u:3570, m:2414, e:[3570,4913,5848,6800,7735,8670,9622,11509]},
      {d:18, u:3780, m:2556, e:[3780,5202,6192,7200,8190,9180,10188,12186]},
      {d:19, u:3990, m:2698, e:[3990,5491,6536,7600,8645,9690,10754,12863]},
      {d:20, u:4200, m:2840, e:[4200,5780,6880,8000,9100,10200,11320,13540]},
      {d:21, u:4410, m:2982, e:[4410,6069,7224,8400,9555,10710,11886,14217]},
      {d:22, u:4620, m:3124, e:[4620,6358,7568,8800,10010,11220,12452,14894]},
      {d:23, u:4830, m:3266, e:[4830,6647,7912,9200,10465,11730,13018,15571]},
      {d:24, u:5040, m:3408, e:[5040,6936,8256,9600,10920,12240,13584,16248]},
      {d:25, u:5250, m:3550, e:[5250,7225,8600,10000,11375,12750,14150,16925]},
    ];

    // Tabla extraordinarios: comisi√≥n por UNIDADES (no por ‚Ç¨)
    // 1‚Äì199:12% | 200‚Äì299:13% | 300‚Äì399:14% | 400‚Äì499:15% | 500‚Äì599:16% | 600+:17%
    function percentExtraordinario(unidades){
      if (unidades >= 600) return 17;
      if (unidades >= 500) return 16;
      if (unidades >= 400) return 15;
      if (unidades >= 300) return 14;
      if (unidades >= 200) return 13;
      if (unidades >= 1)   return 12;
      return 0;
    }

    // =========================
    //   L√ìGICA DE C√ÅLCULO
    // =========================
    const tipoEl = document.getElementById('tipo');
    const diasEl = document.getElementById('dias');
    const precioEl = document.getElementById('precio');
    const vendidosEl = document.getElementById('vendidos');
    const resEl = document.getElementById('resultado');

    const fechaEl = document.getElementById('fecha');
    const btnGuardar = document.getElementById('btnGuardar');
    const mesEl = document.getElementById('mes');
    const btnResumen = document.getElementById('btnResumen');
    const resumenEl = document.getElementById('resumen');

    // Autoprecio seg√∫n tipo
    tipoEl.addEventListener('change', () => {
      precioEl.value = PRECIO_DEF[tipoEl.value] ?? 1.5;
    });

    // Buscar fila de d√≠as (1..25). Si te pasas, usa 25.
    function filaDias(d){
      const x = Math.max(1, Math.min(25, Math.floor(d||0)));
      return TABLA.find(r => r.d === x);
    }

    // Hallar % por familia y euros vendidos usando escalas
    function percentPorEscala(familia, eurosVendidos, fila){
      // Si no llega a UMBRAL, 0% (aunque pase M√çNIMO)
      if (eurosVendidos < fila.u) return 0;

      // Encuentra el √≠ndice m√°ximo cuyo tramo <= eurosVendidos
      let idx = 0;
      for (let i=0; i<fila.e.length; i++){
        if (eurosVendidos >= fila.e[i]) idx = i;
      }
      const lista = PERCENTS[familia] || PERCENTS.resto;
      return lista[idx]; // % correspondiente al tramo
    }

    // Calcular
    document.getElementById('btnCalcular').addEventListener('click', () => {
      const tipo = tipoEl.value;
      const dias = +diasEl.value || 0;
      const unidades = +vendidosEl.value || 0;
      const precio = +precioEl.value || PRECIO_DEF[tipo] || 1.5;

      const euros = unidades * precio;

      // Extraordinario: por unidades
      if (tipo === 'extraordinario'){
        const pct = percentExtraordinario(unidades);
        const comision = euros * (pct/100);
        resEl.innerHTML = `
          <div><b>Tipo:</b> ${tipo} (extraordinario por unidades)</div>
          <div>üî¢ Unidades: <b>${unidades}</b> √ó ${precio.toFixed(2)} ‚Ç¨ = <b>${euros.toFixed(2)} ‚Ç¨</b></div>
          <div>üìà Tramo extraordinario: <b>${pct}%</b></div>
          <div>üí∞ Comisi√≥n estimada: <b>${comision.toFixed(2)} ‚Ç¨</b></div>
          <div class="alerta ${pct>0?'verde':'rojo'}">${pct>0?'‚úÖ Con comisi√≥n seg√∫n tramo':'‚ùå Sin ventas'}</div>
        `;
        return;
      }

      // Resto de productos: por escalas (euros) y familia
      const fila = filaDias(dias);
      const familia = FAMILIA[tipo] || 'resto';
      const pct = percentPorEscala(familia, euros, fila);
      const comision = euros * (pct/100);

      const alertaClase = euros >= fila.u ? 'verde' : (euros >= fila.m ? 'naranja' : 'rojo');
      const alertaTexto  = euros >= fila.u ? '‚úÖ Superado UMBRAL (cobra comisi√≥n por tramo)'
                         : euros >= fila.m ? '‚ö†Ô∏è Superado M√çNIMO (sin comisi√≥n)'
                         : '‚ùå Por debajo del m√≠nimo';

      resEl.innerHTML = `
        <div><b>Tipo:</b> ${tipo} | <b>Familia:</b> ${familia}</div>
        <div>üî¢ Vendido: <b>${unidades}</b> √ó ${precio.toFixed(2)} ‚Ç¨ = <b>${euros.toFixed(2)} ‚Ç¨</b></div>
        <div>üìÖ D√≠as: <b>${fila.d}</b> ‚Üí M√≠nimo: <b>${fila.m.toFixed(2)} ‚Ç¨</b> | Umbral: <b>${fila.u.toFixed(2)} ‚Ç¨</b></div>
        <div>üìä Escalas (‚Ç¨): ${fila.e.map(v=>v.toFixed(0)).join(' ‚Üí ')}</div>
        <div>üìà % comisi√≥n (seg√∫n escala alcanzada): <b>${pct.toFixed(1)}%</b></div>
        <div>üí∞ Comisi√≥n estimada: <b>${comision.toFixed(2)} ‚Ç¨</b></div>
        <div class="alerta ${alertaClase}">${alertaTexto}</div>
      `;
    });

    // =========================
    //   TEMA, MEMORIA, RESUMEN
    // =========================
    document.getElementById('btnTema').addEventListener('click', () => {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', html.dataset.theme || 'light');
    });
    (function(){
      const t = localStorage.getItem('theme') || 'light';
      if (t === 'dark') document.documentElement.dataset.theme = 'dark';
    })();

    // Guardar d√≠a (localStorage)
    btnGuardar.addEventListener('click', () => {
      const f = fechaEl.value;
      if (!f) { alert('Elige fecha.'); return; }
      const registro = JSON.parse(localStorage.getItem('ventasONCE') || '{}');
      const data = {
        tipo: tipoEl.value,
        dias: +diasEl.value || 0,
        vendidos: +vendidosEl.value || 0,
        precio: +precioEl.value || PRECIO_DEF[tipoEl.value] || 1.5
      };
      registro[f] = data;
      localStorage.setItem('ventasONCE', JSON.stringify(registro));
      alert('Guardado ‚úî');
    });

    // Resumen del mes
    btnResumen.addEventListener('click', () => {
      const m = mesEl.value; // yyyy-mm
      if (!m) { alert('Elige mes.'); return; }
      const registro = JSON.parse(localStorage.getItem('ventasONCE') || '{}');
      let totalEuros = 0, totalUnidades = 0;

      Object.entries(registro).forEach(([fecha, d]) => {
        if (fecha.startsWith(m)) {
          totalUnidades += d.vendidos;
          totalEuros += d.vendidos * d.precio;
        }
      });

      resumenEl.style.display = 'block';
      resumenEl.innerHTML = `
        <b>Mes:</b> ${m}<br>
        üßæ Unidades: <b>${totalUnidades}</b><br>
        üí∂ Ventas: <b>${totalEuros.toFixed(2)} ‚Ç¨</b>
      `;
    });

    // =========================
    //        PWA (SW)
    // =========================
    let deferredPrompt = null;
    const btnInstalar = document.getElementById('btnInstalar');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();             // control manual del banner
      deferredPrompt = e;
      btnInstalar.hidden = false;     // muestro bot√≥n
    });

    btnInstalar.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      btnInstalar.hidden = true;
      deferredPrompt = null;
    });

    (async function registrarSW(){
      if (!('serviceWorker' in navigator)) return;
      try {
        const reg = await navigator.serviceWorker.register('./service-worker.js', { scope: './' });
        console.log('SW registrado', reg.scope);
      } catch (err) {
        console.log('SW no disponible:', err?.message || err);
      }
    })();
  </script>
</body>
</html>
