<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora ONCE 2025</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#ffffff; --fg:#0b1220; --muted:#475569;
      --card:#f1f5f9; --primary:#0ea5e9; --primary-2:#0369a1;
      --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --ring:#94a3b8;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --fg:#e5efff; --muted:#9fb3c8;
      --card:#101a2c; --primary:#38bdf8; --primary-2:#7dd3fc;
      --ok:#22c55e; --warn:#fbbf24; --bad:#f87171; --ring:#334155;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,arial,Segoe UI,Roboto,sans-serif}
    header{padding:16px 12px}
    h1{margin:0 0 8px;color:var(--primary);font-size:1.35rem;text-align:center}
    .toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .btn{padding:10px 12px;border-radius:8px;border:1px solid var(--ring);background:var(--card);color:var(--fg);cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border:none}
    .btn.danger{background:var(--bad);color:#fff;border:none}
    .wrap{max-width:940px;margin:0 auto;padding:0 12px 28px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:12px;margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:720px){.grid{grid-template-columns:1.1fr 1fr}}
    label{font-size:.9rem;color:var(--muted)}
    select,input{width:100%;padding:10px;border:1px solid var(--ring);border-radius:8px;background:var(--bg);color:var(--fg)}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid var(--ring);padding:8px;font-size:.95rem}
    th{text-align:left;color:var(--muted)}
    .pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;font-size:.8rem}
    .pill.ok{background:color-mix(in oklab, var(--ok) 18%, transparent);color:var(--ok)}
    .pill.warn{background:color-mix(in oklab, var(--warn) 18%, transparent);color:var(--warn)}
    .pill.bad{background:color-mix(in oklab, var(--bad) 18%, transparent);color:var(--bad)}
    .totales{display:grid;grid-template-columns:1fr;gap:8px;margin-top:8px}
    @media(min-width:620px){.totales{grid-template-columns:1fr 1fr}}
    .kpi{border:1px dashed var(--ring);border-radius:10px;padding:10px}
    .kpi h3{margin:0 0 4px;font-size:1rem;color:var(--muted)}
    .kpi b{font-size:1.15rem}
    footer{padding:16px;text-align:center;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Calculadora de Comisiones ONCE 2025</h1>
    <div class="toolbar">
      <button class="btn" id="toggleTema">üåó Tema</button>
      <button class="btn" id="btnExportar">‚¨áÔ∏è Exportar JSON</button>
      <input id="fileImport" type="file" accept="application/json" hidden>
      <button class="btn" id="btnImportar">‚¨ÜÔ∏è Importar JSON</button>
      <button class="btn danger" id="btnReset">üóëÔ∏è Borrar todo</button>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Entrada diaria -->
      <section class="card">
        <h2 style="margin:0 0 8px">‚ûï A√±adir ventas del d√≠a</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label>Fecha</label>
            <input type="date" id="fecha">
          </div>
          <div>
            <label>Producto</label>
            <select id="producto"></select>
          </div>
          <div>
            <label>Unidades vendidas</label>
            <input type="number" id="unidades" min="0" step="1" value="0">
          </div>
          <div>
            <label>Precio por unidad (‚Ç¨)</label>
            <input type="number" id="precio" step="0.1" min="0">
          </div>
        </div>
        <div class="toolbar" style="justify-content:flex-end;margin-top:8px">
          <button class="btn primary" id="btnAgregar">A√±adir</button>
        </div>
        <small style="color:var(--muted)">Las ventas se guardan autom√°ticamente en tu dispositivo.</small>
      </section>

      <!-- Filtros y resumen -->
      <section class="card">
        <h2 style="margin:0 0 8px">üìÖ Filtro y estado</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label>Mes</label>
            <input type="month" id="mesFiltro">
          </div>
          <div>
            <label>Estado umbral</label><br>
            <span id="estadoPill" class="pill">‚Äî</span>
          </div>
        </div>

        <div class="totales">
          <div class="kpi">
            <h3>Jornadas (d√≠as con ventas)</h3>
            <b id="kpiJornadas">0</b>
          </div>
          <div class="kpi">
            <h3>Ventas (‚Ç¨)</h3>
            <b id="kpiVentas">0.00 ‚Ç¨</b>
          </div>
          <div class="kpi">
            <h3>M√≠nimo</h3>
            <b id="kpiMinimo">0.00 ‚Ç¨</b>
          </div>
          <div class="kpi">
            <h3>Umbral</h3>
            <b id="kpiUmbral">0.00 ‚Ç¨</b>
          </div>
          <div class="kpi">
            <h3>Comisi√≥n estimada</h3>
            <b id="kpiComision">0.00 ‚Ç¨</b>
          </div>
        </div>
      </section>
    </div>

    <!-- Tabla de ventas -->
    <section class="card">
      <h2 style="margin:0 0 8px">üìí Ventas registradas</h2>
      <table id="tabla">
        <thead>
          <tr>
            <th style="width:130px">Fecha</th>
            <th>Producto</th>
            <th style="text-align:right">Unidades</th>
            <th style="text-align:right">Precio (‚Ç¨)</th>
            <th style="text-align:right">Importe (‚Ç¨)</th>
            <th style="text-align:right">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <th colspan="4" style="text-align:right">Total</th>
            <th id="tfootTotal" style="text-align:right">0.00 ‚Ç¨</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </section>
  </main>

  <footer>
    <small>ONCE 2025 ¬∑ C√°lculo basado en tabla accesible: <b>M√≠nimo = 142 ‚Ç¨/d√≠a</b> ¬∑ <b>Umbral = 210 ‚Ç¨/d√≠a</b>. Las comisiones se aplican si superas el umbral.</small>
  </footer>

  <script>
    // ------- Cat√°logo de productos, precios por defecto y % comisi√≥n (si supera umbral)
    const PRODUCTOS = {
      diario:        { nombre: "Diario",        precio: 2,   pct: 0.077 },
      cuponazo:      { nombre: "Cuponazo",      precio: 3,   pct: 0.077 },
      sueldazo:      { nombre: "Sueldazo",      precio: 2,   pct: 0.077 },
      rasca:         { nombre: "Rasca",         precio: 1,   pct: 0.065 },
      triplex:       { nombre: "Triples",       precio: 0.5, pct: 0.05  },
      superonce:     { nombre: "Super Once",    precio: 1,   pct: 0.05  },
      midia:         { nombre: "Mi D√≠a",        precio: 1,   pct: 0.05  },
      eurojackpot:   { nombre: "Eurojackpot",   precio: 2,   pct: 0.05  },
      extraordinario:{ nombre: "Extraordinario",precio: 2.5, pct: 0.10  },
      resto:         { nombre: "Otros",         precio: 1.5, pct: 0.04  }
    };

    // ------- Estado (persistente en localStorage)
    const LS_KEY = "ventas_once_2025";
    let ventas = cargarVentas(); // { id, fecha (YYYY-MM-DD), producto, unidades, precio }

    // ------- UI init
    const $ = s => document.querySelector(s);
    const elFecha = $("#fecha");
    const elProd  = $("#producto");
    const elUnid  = $("#unidades");
    const elPrec  = $("#precio");
    const elMes   = $("#mesFiltro");
    const elTbody = $("#tbody");
    const elTfoot = $("#tfootTotal");
    const elPill  = $("#estadoPill");

    const kpiJornadas = $("#kpiJornadas");
    const kpiVentas   = $("#kpiVentas");
    const kpiMinimo   = $("#kpiMinimo");
    const kpiUmbral   = $("#kpiUmbral");
    const kpiComision = $("#kpiComision");

    // Rellenar select productos
    elProd.innerHTML = Object.entries(PRODUCTOS)
      .map(([k,v]) => `<option value="${k}">${v.nombre}</option>`).join("");
    autocompletarPrecio();

    // Fecha por defecto: hoy
    elFecha.value = new Date().toISOString().slice(0,10);
    elMes.value = new Date().toISOString().slice(0,7);

    // ------- Eventos
    $("#toggleTema").onclick = () => {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === "dark" ? "light" : "dark";
      localStorage.setItem("theme_once", html.dataset.theme);
    };
    (function initTema(){
      const t = localStorage.getItem("theme_once");
      if (t) document.documentElement.dataset.theme = t;
    })();

    $("#btnAgregar").onclick = () => {
      const fecha = elFecha.value;
      const producto = elProd.value;
      const unidades = parseInt(elUnid.value || "0", 10);
      const precio = parseFloat(elPrec.value || "0");
      if (!fecha) return alert("Selecciona fecha");
      if (unidades <= 0) return alert("Indica unidades > 0");
      if (precio <= 0) return alert("Precio inv√°lido");

      ventas.push({ id: crypto.randomUUID(), fecha, producto, unidades, precio });
      guardarVentas();
      elUnid.value = 0;
      render();
    };

    $("#btnReset").onclick = () => {
      if (confirm("¬øBorrar TODAS las ventas guardadas?")) {
        ventas = [];
        guardarVentas();
        render();
      }
    };

    $("#btnExportar").onclick = () => {
      const blob = new Blob([JSON.stringify(ventas, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ventas_once_2025.json";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };

    $("#btnImportar").onclick = () => $("#fileImport").click();
    $("#fileImport").onchange = e => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!Array.isArray(data)) throw new Error("Formato inv√°lido");
          ventas = data;
          guardarVentas();
          render();
        } catch(err){
          alert("JSON inv√°lido: " + err.message);
        }
      };
      reader.readAsText(f);
      e.target.value = "";
    };

    elProd.onchange = autocompletarPrecio;
    elMes.onchange = render;

    function autocompletarPrecio(){
      const p = PRODUCTOS[elProd.value];
      if (p) elPrec.value = p.precio;
    }

    function cargarVentas(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function guardarVentas(){
      localStorage.setItem(LS_KEY, JSON.stringify(ventas));
    }

    // ------- C√°lculos
    function filtrarPorMes(yyyyMM){
      return ventas.filter(v => v.fecha.slice(0,7) === yyyyMM);
    }
    function totalEuros(lista){
      return lista.reduce((s,v) => s + v.unidades * v.precio, 0);
    }
    function jornadas(lista){
      return new Set(lista.map(v => v.fecha)).size; // d√≠as con cualquier venta
    }
    function minimo(dias){ return dias * 142; }
    function umbral(dias){ return dias * 210; }

    function comisionPorProducto(lista, superoUmbral){
      // Si NO se supera el umbral: 0 comisi√≥n
      if (!superoUmbral) return { total: 0, detalle: {} };

      // Comisi√≥n se calcula por cada l√≠nea usando el % de su producto
      const detalle = {};
      let total = 0;
      for (const v of lista){
        const pct = PRODUCTOS[v.producto]?.pct ?? 0.04;
        const base = v.unidades * v.precio;
        const c = base * pct;
        total += c;
        detalle[v.producto] = (detalle[v.producto] || 0) + c;
      }
      return { total, detalle };
    }

    function estadoPill(total, min, umb){
      if (total >= umb) return { clase:"ok", txt:"‚úÖ Umbral superado (con comisi√≥n)" };
      if (total >= min) return { clase:"warn", txt:"‚ö†Ô∏è M√≠nimo superado (sin comisi√≥n)" };
      return { clase:"bad", txt:"‚ùå M√≠nimo NO alcanzado" };
    }

    // ------- Render
    function render(){
      const yyyyMM = elMes.value;
      const lista = filtrarPorMes(yyyyMM).sort((a,b) => (a.fecha < b.fecha ? -1:1));

      // Tabla
      elTbody.innerHTML = lista.map(v => {
        const prod = PRODUCTOS[v.producto]?.nombre || v.producto;
        const imp = (v.unidades * v.precio).toFixed(2);
        return `<tr>
          <td>${v.fecha}</td>
          <td>${prod}</td>
          <td style="text-align:right">${v.unidades}</td>
          <td style="text-align:right">${v.precio.toFixed(2)}</td>
          <td style="text-align:right">${imp}</td>
          <td style="text-align:right">
            <button class="btn" onclick="eliminar('${v.id}')">Eliminar</button>
          </td>
        </tr>`;
      }).join("");

      const total = totalEuros(lista);
      elTfoot.textContent = total.toFixed(2) + " ‚Ç¨";

      const dias = jornadas(lista);
      const min = minimo(dias);
      const umb = umbral(dias);
      const pill = estadoPill(total, min, umb);
      elPill.className = "pill " + pill.clase;
      elPill.textContent = pill.txt;

      const { total: comi } = comisionPorProducto(lista, total >= umb);

      kpiJornadas.textContent = dias;
      kpiVentas.textContent   = total.toFixed(2) + " ‚Ç¨";
      kpiMinimo.textContent   = min.toFixed(2) + " ‚Ç¨";
      kpiUmbral.textContent   = umb.toFixed(2) + " ‚Ç¨";
      kpiComision.textContent = comi.toFixed(2) + " ‚Ç¨";
    }

    window.eliminar = function(id){
      if (!confirm("¬øEliminar esta l√≠nea?")) return;
      ventas = ventas.filter(v => v.id !== id);
      guardarVentas();
      render();
    };

    // ------- PWA
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js")
        .then(() => console.log("SW registrado"))
        .catch((e) => console.log("SW error", e));
    }

    // Primer pintado
    render();
  </script>
</body>
</html>
