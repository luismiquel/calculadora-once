<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Calculadora ONCE 2025</title>
<meta name="theme-color" content="#0d9488">
<link rel="manifest" href="./manifest.json">
<style>
  :root{
    --bg:#0b1220;--fg:#e5e7eb;--card:#0f172a;--muted:#94a3b8;--primary:#0d9488;--warn:#f59e0b;--danger:#ef4444;--ok:#22c55e;--border:#24304a;
  }
  [data-theme="light"]{
    --bg:#f7fafc;--fg:#0b1220;--card:#ffffff;--muted:#475569;--primary:#0ea5e9;--warn:#b45309;--danger:#b91c1c;--ok:#16a34a;--border:#e2e8f0;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
  header{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:10}
  h1{font-size:1.05rem;margin:0}
  .row{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
  .muted{color:var(--muted);font-size:.9rem}
  select,input[type="number"],input[type="month"],button{background:#0b1324;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:.6rem .7rem}
  [data-theme="light"] select,[data-theme="light"] input,[data-theme="light"] button{background:#fff;color:var(--fg)}
  button{cursor:pointer}
  .btn{border:1px solid var(--border)}
  .btn-primary{background:var(--primary);border-color:transparent}
  .btn-ghost{background:transparent}
  .grid{display:grid;gap:12px}
  .days{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
  .day{padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card)}
  .day header{position:static;border:none;padding:0;margin-bottom:8px}
  .tag{font-size:.75rem;padding:.15rem .5rem;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
  .pill{font-size:.8rem;padding:.2rem .55rem;border-radius:999px}
  .ok{background:color-mix(in srgb,var(--ok) 15%,transparent);color:var(--ok)}
  .warn{background:color-mix(in srgb,var(--warn) 18%,transparent);color:var(--warn)}
  .danger{background:color-mix(in srgb,var(--danger) 18%,transparent);color:var(--danger)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px dashed var(--border);font-size:.92rem}
  tfoot td{font-weight:600}
  .right{text-align:right}
  .family{font-size:.78rem;color:var(--muted)}
  .section-title{font-size:.95rem;margin:6px 0 8px;color:var(--muted)}
  .foot{padding:10px 14px}
  .hint{font-size:.8rem;color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Calculadora ONCE 2025</h1>
  <div class="row">
    <input id="mes" type="month">
    <button id="autoMes" class="btn">Autorrellenar mes</button>
    <button id="csv" class="btn">Exportar CSV</button>
    <button id="tema" class="btn-ghost">üåó Tema</button>
  </div>
</header>

<main class="grid" style="padding:12px">
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="section-title">Resumen mensual</div>
        <div class="muted">Se recalcula al editar cualquier d√≠a</div>
      </div>
      <div class="row">
        <span id="jornadas" class="tag">0 jornadas</span>
        <span id="estadoMin" class="pill warn">M√≠nimo 0,00 ‚Ç¨</span>
        <span id="estadoUmb" class="pill danger">Umbral 0,00 ‚Ç¨</span>
      </div>
    </div>
    <div class="row" style="margin-top:8px;gap:18px;flex-wrap:wrap">
      <div class="card" style="flex:1;min-width:220px">
        <div class="muted">Total vendido</div>
        <div id="totalVendido" style="font-size:1.3rem;font-weight:700">0,00 ‚Ç¨</div>
      </div>
      <div class="card" style="flex:1;min-width:220px">
        <div class="muted">Comisi√≥n estimada</div>
        <div id="comision" style="font-size:1.3rem;font-weight:700">0,00 ‚Ç¨</div>
        <div class="hint">Solo si superas <b>umbral</b></div>
      </div>
      <div class="card" style="flex:1;min-width:280px">
        <div class="muted">Por familias</div>
        <div id="familias"></div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div class="section-title">Registro d√≠a a d√≠a</div>
      <div class="hint">Reglas: L‚ÄìJ Diario ¬∑ V Cuponazo(+Eurojackpot) ¬∑ S‚ÄìD Sueldazo ¬∑ Mar/Vie: Eurojackpot</div>
    </div>
    <div id="dias" class="days"></div>
  </section>
</main>

<script>
/* ===== Config ===== */
const MINIMO_DIA = 142;   // ‚Ç¨ por d√≠a (tabla 2025)
const UMBRAL_DIA = 210;   // ‚Ç¨ por d√≠a (tabla 2025)

// Precios por tipo
const PRECIOS = {
  diario: 2,
  cuponazo: 3,
  sueldazo: 2,
  eurojackpot: 2,
  rasca1: 1,
  rasca2: 2,
  rasca3: 3,
  rasca5: 5,
  rasca10: 10,
  triplex: 0.5,
  superonce: 1,
  midia: 1,
  extraordinario: 2.5
};

// Familias (para desglose)
const FAMILIA = {
  diario: "Diario",
  cuponazo: "Cuponazo",
  sueldazo: "Sueldazo",
  eurojackpot: "Eurojackpot",
  rasca1: "Rascas",
  rasca2: "Rascas",
  rasca3: "Rascas",
  rasca5: "Rascas",
  rasca10: "Rascas",
  triplex: "Activos",
  superonce: "Activos",
  midia: "Activos",
  extraordinario: "Extra"
};

// % comisi√≥n simple por tipo (aplicado solo si superas UMBRAL mensual)
const PORC = {
  diario: 0.077,
  cuponazo: 0.077,
  sueldazo: 0.077,
  eurojackpot: 0.05,
  rasca1: 0.065,
  rasca2: 0.065,
  rasca3: 0.065,
  rasca5: 0.065,
  rasca10: 0.065,
  triplex: 0.05,
  superonce: 0.05,
  midia: 0.05,
  extraordinario: 0.10
};

// Productos que se pueden a√±adir manualmente a un d√≠a
const OPC_EXTRA = [
  {id:"rasca1", txt:"Rasca 1 ‚Ç¨"},
  {id:"rasca2", txt:"Rasca 2 ‚Ç¨"},
  {id:"rasca3", txt:"Rasca 3 ‚Ç¨"},
  {id:"rasca5", txt:"Rasca 5 ‚Ç¨"},
  {id:"rasca10", txt:"Rasca 10 ‚Ç¨"},
  {id:"triplex", txt:"Triplex 0,50 ‚Ç¨"},
  {id:"superonce", txt:"Super Once 1 ‚Ç¨"},
  {id:"midia", txt:"Mi D√≠a 1 ‚Ç¨"},
  {id:"extraordinario", txt:"Extraordinario 2,5 ‚Ç¨"},
];

/* ===== Estado (LocalStorage por mes) ===== */
const $mes = document.getElementById("mes");
const $dias = document.getElementById("dias");
const $jornadas = document.getElementById("jornadas");
const $estadoMin = document.getElementById("estadoMin");
const $estadoUmb = document.getElementById("estadoUmb");
const $totalVendido = document.getElementById("totalVendido");
const $comision = document.getElementById("comision");
const $familias = document.getElementById("familias");

function yyyymm(date){ return date.toISOString().slice(0,7); }
function getKey(){ return "calc-once-" + $mes.value; }
function loadMes(){
  const raw = localStorage.getItem(getKey());
  return raw ? JSON.parse(raw) : { dias:{} };
}
function saveMes(data){
  localStorage.setItem(getKey(), JSON.stringify(data));
}

/* ===== Reglas por d√≠a ===== */
function productosPorFecha(fecha){ // fecha = Date
  const d = fecha.getDay(); // 0=Dom, 1=Lun,... 6=Sab
  const isTue = d===2, isFri = d===5;
  const lista = [];
  if (d>=1 && d<=4){ // L-J
    lista.push({tipo:"diario", unidades:0});
  } else if (d===5){ // Viernes
    lista.push({tipo:"cuponazo", unidades:0});
  } else { // Sab-Dom
    lista.push({tipo:"sueldazo", unidades:0});
  }
  if (isTue || isFri){
    lista.push({tipo:"eurojackpot", unidades:0});
  }
  return lista;
}

/* ===== UI D√≠a ===== */
function filaProductoHTML(idDia, idx, item){
  const tipo = item.tipo;
  const precio = PRECIOS[tipo];
  const fam = FAMILIA[tipo] || "Otros";
  return `
    <tr>
      <td>
        <select data-dia="${idDia}" data-idx="${idx}" class="selTipo">
          ${opcionesTipo(tipo)}
        </select>
        <div class="family">${fam}</div>
      </td>
      <td class="right">
        <input data-dia="${idDia}" data-idx="${idx}" class="inpUnd" type="number" min="0" step="1" value="${item.unidades}">
      </td>
      <td class="right muted">${precio.toFixed(2)} ‚Ç¨</td>
      <td class="right" data-imp="${idDia}-${idx}">${(item.unidades*precio).toFixed(2)} ‚Ç¨</td>
      <td class="right">
        <button class="btn-ghost" data-del="${idDia}-${idx}" title="Quitar">üóëÔ∏è</button>
      </td>
    </tr>
  `;
}
function opcionesTipo(sel){
  const todos = [
    {id:"diario", txt:"Diario 2 ‚Ç¨"},
    {id:"cuponazo", txt:"Cuponazo 3 ‚Ç¨"},
    {id:"sueldazo", txt:"Sueldazo 2 ‚Ç¨"},
    {id:"eurojackpot", txt:"Eurojackpot 2 ‚Ç¨"},
    ...OPC_EXTRA
  ];
  return todos.map(o=>`<option value="${o.id}" ${o.id===sel?'selected':''}>${o.txt}</option>`).join("");
}
function tarjetaDiaHTML(idDia, fecha, dataDia){
  const f = fecha.toLocaleDateString('es-ES',{weekday:'short', day:'2-digit', month:'2-digit'});
  const trabajado = !!dataDia.trabajado;
  const totalDia = totalDiaEuros(dataDia);
  const estado = !trabajado ? 'danger' : totalDia>=UMBRAL_DIA ? 'ok' : totalDia>=MINIMO_DIA ? 'warn' : 'danger';
  return `
    <div class="day" id="day-${idDia}">
      <header class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <strong>${f}</strong>
          <span class="tag">${trabajado?'Trabajado':'Descanso'}</span>
        </div>
        <div class="row">
          <label class="row" style="gap:6px" title="Marcar si trabajaste este d√≠a">
            <input type="checkbox" data-work="${idDia}" ${trabajado?'checked':''}>
            <span class="muted">Trabajado</span>
          </label>
          <span class="pill ${estado}">${totalDia.toFixed(2)} ‚Ç¨</span>
        </div>
      </header>
      <table>
        <thead>
          <tr><th>Producto</th><th class="right">Unid.</th><th class="right">Precio</th><th class="right">Importe</th><th></th></tr>
        </thead>
        <tbody id="tbody-${idDia}">
          ${dataDia.items.map((it,idx)=>filaProductoHTML(idDia, idx, it)).join("")}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="5">
              <div class="row" style="justify-content:space-between">
                <select data-add="${idDia}">
                  <option value="">A√±adir producto‚Ä¶</option>
                  ${OPC_EXTRA.map(o=>`<option value="${o.id}">${o.txt}</option>`).join("")}
                </select>
                <span class="muted">M√≠n: ${MINIMO_DIA.toFixed(2)} ‚Ç¨ ¬∑ Umbral: ${UMBRAL_DIA.toFixed(2)} ‚Ç¨</span>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;
}

/* ===== C√°lculos ===== */
function totalDiaEuros(dia){
  if (!dia.trabajado) return 0;
  return dia.items.reduce((s,it)=>s + (PRECIOS[it.tipo]||0)*(Number(it.unidades)||0), 0);
}
function resumenMes(data){
  let jornadas=0, total=0;
  const fam = {};
  for (const id in data.dias){
    const d = data.dias[id];
    if (d.trabajado){ jornadas++; }
    const td = totalDiaEuros(d);
    total += td;
    // desgloses
    for (const it of d.items){
      const euros = (PRECIOS[it.tipo]||0)*(Number(it.unidades)||0);
      const f = FAMILIA[it.tipo]||"Otros";
      fam[f] = (fam[f]||0) + euros;
    }
  }
  const minimo = jornadas*MINIMO_DIA;
  const umbral = jornadas*UMBRAL_DIA;
  // comisi√≥n: solo si superas umbral ‚Üí sumatoria por producto con su %
  let comi = 0;
  if (total >= umbral){
    for (const id in data.dias){
      for (const it of data.dias[id].items){
        const euros = (PRECIOS[it.tipo]||0)*(Number(it.unidades)||0);
        comi += euros * (PORC[it.tipo]||0.05);
      }
    }
  }
  return {jornadas, total, minimo, umbral, fam, comi};
}

/* ===== Render ===== */
function render(){
  const data = loadMes();
  // crear tarjetas
  $dias.innerHTML = "";
  const [y,m] = $mes.value.split("-").map(n=>parseInt(n,10));
  const start = new Date(y, m-1, 1);
  const end = new Date(y, m, 0).getDate();
  for (let d=1; d<=end; d++){
    const fecha = new Date(y, m-1, d);
    const idDia = fecha.toISOString().slice(0,10);
    const dData = data.dias[idDia] || {trabajado:false, items:[]};
    $dias.insertAdjacentHTML("beforeend", tarjetaDiaHTML(idDia, fecha, dData));
  }
  // summary
  const r = resumenMes(data);
  $jornadas.textContent = `${r.jornadas} jornada${r.jornadas===1?"":"s"}`;
  $estadoMin.textContent = `M√≠nimo ${r.minimo.toFixed(2)} ‚Ç¨`;
  $estadoUmb.textContent = `Umbral ${r.umbral.toFixed(2)} ‚Ç¨`;
  // colores de estado
  $estadoMin.className = "pill " + (r.total>=r.minimo ? "ok":"warn");
  $estadoUmb.className = "pill " + (r.total>=r.umbral ? "ok":"danger");
  // totales
  $totalVendido.textContent = `${r.total.toFixed(2)} ‚Ç¨`;
  $comision.textContent = `${r.comi.toFixed(2)} ‚Ç¨`;
  // familias
  $familias.innerHTML = Object.keys(r.fam).length
    ? Object.entries(r.fam).map(([k,v])=>`<div>${k}: <b>${v.toFixed(2)} ‚Ç¨</b></div>`).join("")
    : `<div class="muted">Sin ventas todav√≠a</div>`;
  // Listeners delegados
  wireEvents();
}

/* ===== Eventos por delegaci√≥n ===== */
function wireEvents(){
  // marcar trabajado
  document.querySelectorAll("[data-work]").forEach(chk=>{
    chk.onchange = () => {
      const id = chk.getAttribute("data-work");
      const data = loadMes();
      data.dias[id] = data.dias[id] || {trabajado:false, items:[]};
      data.dias[id].trabajado = chk.checked;
      saveMes(data); render();
    };
  });
  // cambiar tipo
  document.querySelectorAll(".selTipo").forEach(sel=>{
    sel.onchange = () => {
      const idDia = sel.getAttribute("data-dia");
      const idx = parseInt(sel.getAttribute("data-idx"),10);
      const data = loadMes();
      data.dias[idDia].items[idx].tipo = sel.value;
      saveMes(data); render();
    };
  });
  // cambiar unidades
  document.querySelectorAll(".inpUnd").forEach(inp=>{
    inp.oninput = () => {
      const idDia = inp.getAttribute("data-dia");
      const idx = parseInt(inp.getAttribute("data-idx"),10);
      const data = loadMes();
      data.dias[idDia].items[idx].unidades = Number(inp.value)||0;
      saveMes(data);
      // actualizar solo importe de la fila para fluidez
      const tipo = data.dias[idDia].items[idx].tipo;
      const imp = (PRECIOS[tipo]||0)*(Number(inp.value)||0);
      const cell = document.querySelector(`[data-imp="${idDia}-${idx}"]`);
      if (cell) cell.textContent = `${imp.toFixed(2)} ‚Ç¨`;
      // actualizar totales r√°pidos
      fastSummary();
    };
  });
  // a√±adir extra
  document.querySelectorAll("[data-add]").forEach(sel=>{
    sel.onchange = () => {
      const idDia = sel.getAttribute("data-add");
      const v = sel.value;
      if (!v) return;
      const data = loadMes();
      data.dias[idDia] = data.dias[idDia] || {trabajado:true, items:[]};
      data.dias[idDia].items.push({tipo:v, unidades:0});
      saveMes(data); render();
    };
  });
  // borrar fila
  document.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = () => {
      const [idDia, idx] = btn.getAttribute("data-del").split("-");
      const data = loadMes();
      data.dias[idDia].items.splice(Number(idx),1);
      saveMes(data); render();
    };
  });
}

/* ===== Fast summary en cambios de unidades ===== */
function fastSummary(){
  const r = resumenMes(loadMes());
  $jornadas.textContent = `${r.jornadas} jornada${r.jornadas===1?"":"s"}`;
  $estadoMin.textContent = `M√≠nimo ${r.minimo.toFixed(2)} ‚Ç¨`;
  $estadoUmb.textContent = `Umbral ${r.umbral.toFixed(2)} ‚Ç¨`;
  $estadoMin.className = "pill " + (r.total>=r.minimo ? "ok":"warn");
  $estadoUmb.className = "pill " + (r.total>=r.umbral ? "ok":"danger");
  $totalVendido.textContent = `${r.total.toFixed(2)} ‚Ç¨`;
  $comision.textContent = `${r.comi.toFixed(2)} ‚Ç¨`;
  $familias.innerHTML = Object.keys(r.fam).length
    ? Object.entries(r.fam).map(([k,v])=>`<div>${k}: <b>${v.toFixed(2)} ‚Ç¨</b></div>`).join("")
    : `<div class="muted">Sin ventas todav√≠a</div>`;
}

/* ===== Autorrellenar mes ===== */
function autorrellenar(){
  const data = loadMes();
  const [y,m] = $mes.value.split("-").map(n=>parseInt(n,10));
  const start = new Date(y, m-1, 1);
  const end = new Date(y, m, 0).getDate();
  for (let d=1; d<=end; d++){
    const fecha = new Date(y, m-1, d);
    const id = fecha.toISOString().slice(0,10);
    if (!data.dias[id]){
      data.dias[id] = {trabajado:true, items: productosPorFecha(fecha)};
    }
  }
  saveMes(data); render();
}

/* ===== CSV ===== */
function exportCSV(){
  const data = loadMes();
  const rows = [["Fecha","Trabajado","Producto","Familia","Unidades","Precio","Importe (‚Ç¨)"]];
  for (const id in data.dias){
    const d = data.dias[id];
    if (!d.trabajado && (!d.items || !d.items.length)){
      rows.push([id,"No","","",0,"", "0.00"]);
      continue;
    }
    for (const it of d.items){
      const precio = PRECIOS[it.tipo]||0;
      const imp = precio*(Number(it.unidades)||0);
      rows.push([id, d.trabajado?"S√≠":"No", it.tipo, FAMILIA[it.tipo]||"", it.unidades, precio.toFixed(2), imp.toFixed(2)]);
    }
  }
  const csv = rows.map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `ventas_${$mes.value}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== Tema & PWA ===== */
const $tema = document.getElementById("tema");
$tema.onclick = ()=>{
  const html = document.documentElement;
  html.dataset.theme = html.dataset.theme==="light" ? "" : "light";
  localStorage.setItem("theme", html.dataset.theme || "dark");
};
(function initTheme(){
  const t = localStorage.getItem("theme") || "dark";
  if (t==="light") document.documentElement.dataset.theme = "light";
})();

// SW (solo si existe el archivo en el repo)
if ('serviceWorker' in navigator){
  fetch('./service-worker.js',{method:'HEAD'}).then(r=>{
    if(r.ok){
      navigator.serviceWorker.register('./service-worker.js')
        .then(()=>console.log('SW registrado', location.origin + location.pathname.replace(/[^/]+$/,'')))
        .catch(()=>{});
    }else{
      console.log('SW no encontrado (404). Registro omitido.');
    }
  }).catch(()=>{});
}

/* ===== Init ===== */
(function init(){
  // mes por defecto: actual
  const now = new Date();
  $mes.value = yyyymm(now);
  // listeners
  document.getElementById("autoMes").onclick = autorrellenar;
  document.getElementById("csv").onclick = exportCSV;
  $mes.onchange = ()=>render();
  render();
})();
</script>
</body>
</html>
