<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Comisiones ONCE 2025</title>
  <meta name="theme-color" content="#0f172a">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="https://placehold.co/192x192/0f172a/ffffff?text=ONCE" sizes="192x192">

  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --card:#f1f5f9; --brand:#0ea5e9; --accent:#22c55e;
      --btn:#0ea5e9; --btn-fg:#ffffff; --warn:#f59e0b; --danger:#ef4444; --muted:#64748b;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --fg:#e5e7eb; --card:#111827; --brand:#38bdf8; --accent:#22c55e;
      --btn:#38bdf8; --btn-fg:#0b1220; --warn:#fbbf24; --danger:#f87171; --muted:#94a3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:16px;background:var(--bg);color:var(--fg);font-family:system-ui,Arial,sans-serif}
    h1{margin:0 0 12px;font-size:1.4rem;color:var(--brand)}
    .card{background:var(--card);border-radius:12px;padding:12px}
    label{display:block;margin:10px 0 6px;font-size:.92rem;color:var(--muted)}
    select,input{width:100%;padding:10px;font-size:1rem;border-radius:10px;border:1px solid #0001;background:#fff0}
    .row{display:grid;gap:10px}
    @media(min-width:700px){.row{grid-template-columns:repeat(2,1fr)}}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    button{padding:10px 12px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
    .btn{background:var(--btn);color:var(--btn-fg)}
    .btn-secondary{background:#00000012;color:var(--fg)}
    .resultado{margin-top:12px}
    .alerta{margin-top:8px;padding:10px;border-radius:8px;font-weight:600}
    .verde{background:#16a34a22;color:#16a34a}
    .naranja{background:#f59e0b22;color:#b45309}
    .rojo{background:#ef444422;color:#b91c1c}
    .muted{color:var(--muted);font-size:.9rem}
    .small{font-size:.9rem}
    .footer{margin-top:16px;color:var(--muted);font-size:.85rem;text-align:center}
  </style>
</head>
<body>
  <h1>Calculadora de Comisiones ONCE 2025</h1>

  <div class="toolbar">
    <button class="btn-secondary" id="toggleTema" onclick="cambiarTema()">üåó Tema</button>
    <button class="btn" id="btnCalcular" onclick="calcularComision()">üî¢ Calcular</button>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <label>Tipo de producto</label>
        <select id="tipo" onchange="autocompletarPrecioYPorcentaje()">
          <option value="diario">Diario</option>
          <option value="cuponazo">Cuponazo</option>
          <option value="sueldazo">Sueldazo</option>
          <option value="rasca">Rasca</option>
          <option value="triplex">Tr√≠plex</option>
          <option value="superonce">Super Once</option>
          <option value="midia">Mi D√≠a</option>
          <option value="eurojackpot">Eurojackpot</option>
          <option value="extraordinario">Extraordinario</option>
          <option value="resto">Otros</option>
        </select>
      </div>

      <div>
        <label>D√≠as trabajados (1‚Äì26)</label>
        <input id="dias" type="number" min="1" max="26" value="20" />
      </div>

      <div>
        <label>Unidades vendidas</label>
        <input id="vendidos" type="number" min="0" value="0" />
      </div>

      <div>
        <label>Precio por unidad (‚Ç¨)</label>
        <input id="precio" type="number" step="0.1" value="2" />
      </div>

      <div>
        <label>Porcentaje de comisi√≥n (%) <span class="muted">(editable)</span></label>
        <input id="porc" type="number" step="0.1" min="0" value="7.7" />
      </div>
    </div>

    <div class="resultado" id="resultado"></div>
    <div class="small muted">Notas:
      <ul>
        <li><b>M√≠nimo</b> = 142 ‚Ç¨/d√≠a &nbsp;|&nbsp; <b>Umbral</b> = 210 ‚Ç¨/d√≠a.</li>
        <li><b>Extraordinarios</b>: comisi√≥n por tramos (12‚Äì17%) <b>sin umbral</b>.</li>
        <li>El % es editable para ajustar a cambios oficiales.</li>
      </ul>
    </div>
  </div>

  <div class="footer">PWA offline. Si algo no se actualiza, recarga con cach√© vac√≠a.</div>

  <script>
    // ======= Datos por producto =======
    const precios = {
      diario: 2, cuponazo: 3, sueldazo: 2, rasca: 1,
      triplex: 0.5, superonce: 1, midia: 1, eurojackpot: 2,
      extraordinario: 2.5, resto: 1.5
    };

    // Porcentaje sugerido por producto (editable en UI)
    const porcentajeSugerido = {
      diario: 7.7, cuponazo: 7.7, sueldazo: 7.7,
      rasca: 6.5, triplex: 5, superonce: 5,
      midia: 5, eurojackpot: 5, extraordinario: 12, resto: 4
    };

    // Tramos Extraordinarios (por n√∫mero de cupones)
    function tramoExtra(vendidos){
      if (vendidos >= 600) return 17;
      if (vendidos >= 500) return 16;
      if (vendidos >= 400) return 15;
      if (vendidos >= 300) return 14;
      if (vendidos >= 200) return 13;
      if (vendidos >=   1) return 12;
      return 0;
    }

    function autocompletarPrecioYPorcentaje(){
      const tipo = document.getElementById("tipo").value;
      document.getElementById("precio").value = precios[tipo];
      if (tipo === "extraordinario") {
        // Para extraordinarios, el % real lo determina el tramo -> dejamos el campo como referencia
        document.getElementById("porc").value = 12;
      } else {
        document.getElementById("porc").value = porcentajeSugerido[tipo];
      }
    }

    function calcularMinimoUmbral(dias){
      // Tabla 2025: patr√≥n lineal por d√≠a (observado en documento):
      // m√≠nimo = 142 ‚Ç¨/d√≠a, umbral = 210 ‚Ç¨/d√≠a
      const minimo = 142 * dias;
      const umbral = 210 * dias;
      return { minimo, umbral };
    }

    function formatoEuros(n){
      return n.toLocaleString("es-ES",{style:"currency",currency:"EUR"});
    }

    function calcularComision(){
      const btn = document.getElementById("btnCalcular");
      if (btn) btn.disabled = true; // evita doble clic muy r√°pido

      const tipo     = document.getElementById("tipo").value;
      const dias     = Math.max(1, Math.min(26, parseInt(document.getElementById("dias").value || "0", 10)));
      const vendidos = Math.max(0, parseInt(document.getElementById("vendidos").value || "0", 10));
      const precio   = Math.max(0, parseFloat(document.getElementById("precio").value || "0"));
      let porc       = Math.max(0, parseFloat(document.getElementById("porc").value || "0"));

      const total = vendidos * precio;
      const { minimo, umbral } = calcularMinimoUmbral(dias);

      let comision = 0, detalle = "", alertaClase = "rojo", estadoTexto = "‚ùå No alcanzado el m√≠nimo";
      if (tipo === "extraordinario"){
        // Extraordinario: por tramos, sin umbral
        const tramo = tramoExtra(vendidos);
        porc = tramo; // % final
        comision = total * (porc/100);
        detalle = `üßæ Extraordinario: ${vendidos} cupones ‚Üí tramo ${porc}% (sin umbral).`;
        // Pintamos sem√°foro informativo seg√∫n tramo
        if (porc >= 15) { alertaClase = "verde"; estadoTexto = "‚úÖ Buen tramo de comisi√≥n"; }
        else if (porc >= 12) { alertaClase = "naranja"; estadoTexto = "‚ÑπÔ∏è Tramo inicial de comisi√≥n"; }
        else { alertaClase = "rojo"; estadoTexto = "‚Äî"; }
      } else {
        // Resto: solo hay comisi√≥n si se supera el UMBRAL
        if (total >= umbral){
          comision = total * (porc/100);
          alertaClase = "verde"; estadoTexto = "‚úÖ Superado el umbral";
        } else if (total >= minimo){
          comision = 0;
          alertaClase = "naranja"; estadoTexto = "‚ö†Ô∏è Sobre el m√≠nimo, pero sin comisi√≥n";
        } else {
          comision = 0;
          alertaClase = "rojo"; estadoTexto = "‚ùå No alcanzado el m√≠nimo";
        }
        detalle = `üìè Regla: comisi√≥n solo si total ‚â• umbral (${formatoEuros(umbral)}).`;
      }

      const html = `
        <div>
          <div>üõí <b>${vendidos}</b> √ó ${formatoEuros(precio)} = <b>${formatoEuros(total)}</b></div>
          <div>üìÖ D√≠as: <b>${dias}</b> &nbsp;‚Üí&nbsp; M√≠nimo: <b>${formatoEuros(minimo)}</b> ¬∑ Umbral: <b>${formatoEuros(umbral)}</b></div>
          <div>üìà % comisi√≥n aplicado: <b>${porc.toFixed(1)}%</b></div>
          <div>üí∞ Ganancia estimada: <b>${formatoEuros(comision)}</b></div>
          <div class="alerta ${alertaClase}">${estadoTexto}</div>
          <div class="muted small">${detalle}</div>
        </div>
      `;
      document.getElementById("resultado").innerHTML = html;

      if (btn) setTimeout(()=>btn.disabled=false, 200);
    }

    // ==== Tema persistente ====
    (function initTema(){
      const saved = localStorage.getItem("calc-once-theme");
      if (saved) document.documentElement.dataset.theme = saved;
    })();

    function cambiarTema(){
      const html = document.documentElement;
      const next = html.dataset.theme === "dark" ? "light" : "dark";
      html.dataset.theme = next;
      localStorage.setItem("calc-once-theme", next);
    }

    // ==== PWA: registro seguro del SW (evita error si 404) ====
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          const resp = await fetch("./service-worker.js", { cache: "no-store" });
          if (resp.ok) {
            await navigator.serviceWorker.register("./service-worker.js");
            console.log("Service Worker registrado.");
          } else {
            console.warn("SW no encontrado (404). Registro omitido.");
          }
        } catch (e) {
          console.warn("No se pudo registrar el SW:", e);
        }
      });
    }

    // Autocompletar al abrir
    autocompletarPrecioYPorcentaje();
  </script>
</body>
</html>
