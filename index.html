<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora Comisiones ONCE 2025</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üí∂</text></svg>'>
  <meta name="theme-color" content="#0b1320">

  <style>
    :root{
      --bg:#0b1320; --fg:#e8eefc; --muted:#9bb0cc; --card:#111a2c; --accent:#4da3ff; --good:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --border:#1f2a44;
      --focus: 0 0 0 3px rgba(77,163,255,.25); --badge:#22304d;
    }
    [data-theme="light"]{
      --bg:#f4f7fb; --fg:#0e1624; --muted:#456; --card:#ffffff; --accent:#1e71ff; --good:#1ea64b; --warn:#b58900; --bad:#c0392b; --border:#dfe7f2; --badge:#eef3fb;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;}
    .wrap{max-width:1100px;margin-inline:auto;padding:20px}
    h1{font-size:clamp(22px,3.5vw,30px);margin:0 0 14px}
    h2{font-size:clamp(18px,3vw,22px)}
    .row{display:grid;gap:16px}
    @media(min-width:900px){.row{grid-template-columns:1.2fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,button{font:inherit}
    input[type="number"], input[type="date"], input[type="month"], select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
    input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,select:focus{outline:var(--focus)}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(4,1fr)}}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--fg)}
    .btn:focus{outline:var(--focus)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right;font-variant-numeric:tabular-nums}
    th:first-child,td:first-child{text-align:left}
    .muted{color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    .kpi .box{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:12px}
    .kpi .val{font-size:18px;font-weight:600}
    progress{width:100%;height:14px}
    .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
    .switch{display:flex;gap:8px;flex-wrap:wrap}
    .pill{border:1px solid var(--border);padding:8px 12px;border-radius:999px;background:transparent;color:var(--fg);cursor:pointer}
    .danger{color:#fff;background:var(--bad);border-color:transparent}
    .ok{color:#fff;background:var(--good);border-color:transparent}
    .tips{font-size:13px;color:var(--muted)}
    .mono{font-variant-numeric:tabular-nums}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .two{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){.two{grid-template-columns:1fr 1fr}}
    .badge{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:var(--badge);border:1px solid var(--border);font-size:.85rem}
    .badge.good{background:color-mix(in oklab,var(--good) 25%, var(--badge));border-color:transparent;color:#fff}
    .badge.warn{background:color-mix(in oklab,var(--warn) 25%, var(--badge));border-color:transparent;color:#1a1600}
    .badge.bad{background:color-mix(in oklab,var(--bad) 30%, var(--badge));border-color:transparent;color:#fff}
    .nowrap{white-space:nowrap}
    .row-actions{display:flex;gap:6px;justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <div class="head">
      <h1>Calculadora ONCE 2025 ‚Äî Registro diario con calendario</h1>
      <div class="switch">
        <button id="toggleTheme" class="pill" title="Cambiar tema">üåó Tema</button>
        <button id="btnUndo" class="pill" title="Deshacer √∫ltimo cambio">‚Ü©Ô∏è Deshacer</button>
        <button id="exportCsv" class="pill" title="Exportar CSV del mes">‚¨áÔ∏è CSV mes</button>
        <button id="exportJson" class="pill" title="Backup JSON (todo)">‚¨áÔ∏è Backup JSON</button>
        <button id="importJsonBtn" class="pill" title="Importar JSON">‚¨ÜÔ∏è Importar JSON</button>
        <input type="file" id="importJson" accept="application/json" style="display:none">
        <button id="resetMes" class="pill danger" title="Borrar datos del mes">üóëÔ∏è Borrar mes</button>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <h2 style="margin-top:0">A√±adir / editar ventas de un d√≠a</h2>
        <div class="grid">
          <div>
            <label>Fecha</label>
            <input type="date" id="fecha" />
          </div>
          <div>
            <label>Jornada tipo (informativo)</label>
            <select id="tipoJornada">
              <option value="libre">Libre</option>
              <option value="diario">L-J Diario</option>
              <option value="cuponazo">Viernes Cuponazo</option>
              <option value="sueldazo">S-D Sueldazo</option>
              <option value="eurojackpot">Mar/Vie Eurojackpot</option>
            </select>
          </div>
        </div>

        <h3>Cupones</h3>
        <div class="grid">
          <div><label>Diario (2‚Ç¨) ‚Äî L-J</label><input type="number" id="nDiario" min="0" step="1" placeholder="0" /></div>
          <div><label>Cuponazo (3‚Ç¨) ‚Äî Vie</label><input type="number" id="nCuponazo" min="0" step="1" placeholder="0" /></div>
          <div><label>Sueldazo (2‚Ç¨) ‚Äî S-D</label><input type="number" id="nSueldazo" min="0" step="1" placeholder="0" /></div>
        </div>

        <h3 style="margin-top:12px">Rascas (por libros)</h3>
        <div class="grid">
          <div><label>Rasca 1‚Ç¨ (libro=100‚Ç¨)</label><input type="number" id="libroR1" min="0" step="1" placeholder="0" /></div>
          <div><label>Rasca 2‚Ç¨ (libro=100‚Ç¨)</label><input type="number" id="libroR2" min="0" step="1" placeholder="0" /></div>
          <div><label>Rasca 3‚Ç¨ (libro=150‚Ç¨)</label><input type="number" id="libroR3" min="0" step="1" placeholder="0" /></div>
          <div><label>Rasca 5‚Ç¨ (libro=150‚Ç¨)</label><input type="number" id="libroR5" min="0" step="1" placeholder="0" /></div>
          <div><label>Rasca 10‚Ç¨ (libro=150‚Ç¨)</label><input type="number" id="libroR10" min="0" step="1" placeholder="0" /></div>
        </div>

        <h3 style="margin-top:12px">Productos activos</h3>
        <div class="grid">
          <div><label>Triples (0,50‚Ç¨ por apuesta)</label><input type="number" id="nTriples" min="0" step="1" placeholder="0" /></div>
          <div><label>SuperONCE (importe en ‚Ç¨)</label><input type="number" id="eurosSuperonce" min="0" step="1" placeholder="0" /></div>
          <div><label>Mi D√≠a (1‚Ç¨ por apuesta)</label><input type="number" id="nMiDia" min="0" step="1" placeholder="0" /></div>
          <div><label>Eurojackpot (2‚Ç¨ por apuesta)</label><input type="number" id="nEurojackpot" min="0" step="1" placeholder="0" /></div>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ok" id="guardarDia">üíæ Guardar (sumar)</button>
          <button class="btn" id="guardarReemplazar" title="Reemplaza por completo el d√≠a" style="display:none">üíæ Guardar (reemplazar)</button>
          <button class="btn secondary" id="cancelarEdicion" style="display:none">‚úñÔ∏è Cancelar edici√≥n</button>
          <button class="btn secondary" id="limpiarForm">‚Ü∫ Limpiar</button>
        </div>
        <p class="tips">Por defecto <b>se suma</b> a lo ya guardado. En modo edici√≥n puedes <b>reemplazar</b> el d√≠a completo.</p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">Resumen del mes</h2>

        <div class="inline" style="gap:12px">
          <div class="inline">
            <label class="inline" style="gap:6px"><input type="checkbox" id="chkJornadasManual"> Usar jornadas manuales</label>
            <input type="number" id="inpJornadas" min="0" max="26" step="1" placeholder="0" style="max-width:110px">
          </div>
          <div>
            <label class="muted" for="mesSel">Mes</label>
            <input type="month" id="mesSel" />
          </div>
        </div>

        <div class="kpi">
          <div class="box"><div class="muted">Jornadas (calculadas)</div><div class="val mono" id="kpiJornadasCalc">0</div></div>
          <div class="box"><div class="muted">Jornadas usadas</div><div class="val mono" id="kpiJornadasUsadas">0</div></div>
          <div class="box"><div class="muted">Vendido acumulado (‚Ç¨)</div><div class="val mono" id="kpiVendido">0,00</div></div>
          <div class="box"><div class="muted">M√≠nimo (142‚Ç¨/jornada)</div><div class="val mono" id="kpiMinimo">0,00</div></div>
          <div class="box"><div class="muted">Umbral (210‚Ç¨/jornada)</div><div class="val mono" id="kpiUmbral">0,00</div></div>
          <div class="box"><div class="muted">Comisi√≥n total (‚Ç¨)</div><div class="val mono" id="kpiComisionTotal">0,00</div></div>
        </div>

        <div style="margin-top:14px">
          <label>Progreso a m√≠nimo</label>
          <progress id="progMin" value="0" max="1"></progress>
          <div class="muted mono" id="txtMin"></div>
        </div>
        <div style="margin-top:10px">
          <label>Progreso a umbral</label>
          <progress id="progUmb" value="0" max="1"></progress>
          <div class="muted mono" id="txtUmb"></div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <h2 style="margin:0">Ventas del mes (d√≠a a d√≠a)</h2>
      </div>
      <div style="overflow:auto;margin-top:10px">
        <table id="tabla">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Diario</th>
              <th>Cuponazo</th>
              <th>Sueldazo</th>
              <th>R1‚Ç¨ (libros)</th>
              <th>R2‚Ç¨</th>
              <th>R3‚Ç¨</th>
              <th>R5‚Ç¨</th>
              <th>R10‚Ç¨</th>
              <th>Triples</th>
              <th>SuperONCE ‚Ç¨</th>
              <th>Mi D√≠a</th>
              <th>Eurojackpot</th>
              <th>Total ‚Ç¨</th>
              <th>Objetivo</th>
              <th class="nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2 style="margin:0 0 6px">Resumen por semanas (Lunes‚ÄìDomingo)</h2>
      <p class="tips">Agrupa s√≥lo los d√≠as del mes seleccionado.</p>
      <div style="overflow:auto;margin-top:8px">
        <table id="tablaSemanas">
          <thead>
            <tr>
              <th>Semana</th>
              <th>Rango visible</th>
              <th>Jornadas</th>
              <th>Vendido ‚Ç¨</th>
              <th>M√≠nimo ‚Ç¨</th>
              <th>Umbral ‚Ç¨</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>
    </section>

    <section class="card two" style="margin-top:16px">
      <div>
        <h2 style="margin:0">Comisiones por categor√≠a</h2>
        <p class="tips">Introduce tus porcentajes reales. Se guardan y se aplican al resumen mensual.</p>
        <div class="grid">
          <div><label>% Muy alto (Diario/Cuponazo/Sueldazo)</label><input type="number" id="pctMuyAlto" min="0" max="100" step="0.1" placeholder="0"></div>
          <div><label>% Alto (Rascas)</label><input type="number" id="pctAlto" min="0" max="100" step="0.1" placeholder="0"></div>
          <div><label>% Resto (Triples/SuperONCE/Mi D√≠a/EJ)</label><input type="number" id="pctResto" min="0" max="100" step="0.1" placeholder="0"></div>
          <div><label>% Extraordinarios</label><input type="number" id="pctExtra" min="0" max="100" step="0.1" placeholder="0"></div>
        </div>

        <div class="kpi" style="margin-top:10px">
          <div class="box"><div class="muted">‚Ç¨ Muy alto</div><div class="val mono" id="eurMuyAlto">0,00</div></div>
          <div class="box"><div class="muted">‚Ç¨ Alto (Rascas)</div><div class="val mono" id="eurAlto">0,00</div></div>
          <div class="box"><div class="muted">‚Ç¨ Resto</div><div class="val mono" id="eurResto">0,00</div></div>
          <div class="box"><div class="muted">‚Ç¨ Extra</div><div class="val mono" id="eurExtra">0,00</div></div>
        </div>

        <div class="kpi" style="margin-top:10px">
          <div class="box"><div class="muted">Comisi√≥n Muy alto</div><div class="val mono" id="comMuyAlto">0,00</div></div>
          <div class="box"><div class="muted">Comisi√≥n Alto</div><div class="val mono" id="comAlto">0,00</div></div>
          <div class="box"><div class="muted">Comisi√≥n Resto</div><div class="val mono" id="comResto">0,00</div></div>
          <div class="box"><div class="muted">Comisi√≥n Extra</div><div class="val mono" id="comExtra">0,00</div></div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="pill" id="savePct">üíæ Guardar porcentajes</button>
          <button class="pill" id="resetPct">‚Ü∫ Restablecer</button>
        </div>
      </div>
      <div>
        <h2 style="margin:0">Notas</h2>
        <ul class="tips" style="margin-top:6px;line-height:1.5">
          <li>Una <b>jornada</b> cuenta cuando el total del d√≠a &gt; 0‚Ç¨.</li>
          <li>Estados diarios: <span class="badge bad">Pendiente</span>, <span class="badge warn">M√≠nimo</span> (‚â•142‚Ç¨), <span class="badge good">Umbral</span> (‚â•210‚Ç¨).</li>
        </ul>
      </div>
    </section>

    <p class="tips">M√≠nimo y umbral: <b>142‚Ç¨</b> y <b>210‚Ç¨</b> por jornada. Datos por mes en este dispositivo (localStorage).</p>
  </div>

  <script>
  (function(){
    // ---------- Helpers ----------
    const EL = (id)=>document.getElementById(id);

    // Formateo determinista "es-ES" (puntos miles, coma decimales)
    function fmtEur(n){
      const s = (Number(n)||0).toFixed(2);
      const [ent, dec] = s.split('.');
      const entMiles = ent.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      return `${entMiles},${dec}`;
    }

    const clampInt = (v)=> Math.max(0, Number.isFinite(+v) ? Math.floor(+v) : 0);
    const clampMoney = (v)=> Math.max(0, Number.isFinite(+v) ? +v : 0);

    // Precios / importes
    const PRICES = { diario: 2, cuponazo: 3, sueldazo: 2, triples: 0.5, miDia: 1, eurojackpot: 2 };
    const LIBROS_RASCAS = { r1:100, r2:100, r3:150, r5:150, r10:150 };

    // Objetivos por jornada
    const MIN_DIA = 142, UMBRAL_DIA = 210;

    // Storage keys
    const KEY = 'calcOnce.diario.v2';
    const THEME_KEY = 'calcOnce.theme';
    const JORNADAS_KEY = 'calcOnce.jornadasManual'; // {enabled:boolean, value:number}
    const PCTS_KEY = 'calcOnce.porcentajes';        // {muyAlto, alto, resto, extra}
    const UNDO_KEY = 'calcOnce.undo';               // snapshot para deshacer

    // ---------- Elementos ----------
    const fecha = EL('fecha');
    const tipoJornada = EL('tipoJornada');
    const nDiario = EL('nDiario');
    const nCuponazo = EL('nCuponazo');
    const nSueldazo = EL('nSueldazo');
    const libroR1 = EL('libroR1');
    const libroR2 = EL('libroR2');
    const libroR3 = EL('libroR3');
    const libroR5 = EL('libroR5');
    const libroR10 = EL('libroR10');
    const nTriples = EL('nTriples');
    const eurosSuperonce = EL('eurosSuperonce');
    const nMiDia = EL('nMiDia');
    const nEurojackpot = EL('nEurojackpot');

    const guardarDia = EL('guardarDia');
    const guardarReemplazar = EL('guardarReemplazar');
    const cancelarEdicion = EL('cancelarEdicion');
    const limpiarForm = EL('limpiarForm');
    const exportCsv = EL('exportCsv');
    const exportJson = EL('exportJson');
    const importJsonBtn = EL('importJsonBtn');
    const importJson = EL('importJson');
    const btnUndo = EL('btnUndo');
    const resetMes = EL('resetMes');
    const toggleTheme = EL('toggleTheme');

    const chkJornadasManual = EL('chkJornadasManual');
    const inpJornadas = EL('inpJornadas');
    const kpiJornadasCalc = EL('kpiJornadasCalc');
    const kpiJornadasUsadas = EL('kpiJornadasUsadas');
    const kpiVendido = EL('kpiVendido');
    const kpiMinimo = EL('kpiMinimo');
    const kpiUmbral = EL('kpiUmbral');
    const kpiComisionTotal = EL('kpiComisionTotal');
    const progMin = EL('progMin');
    const progUmb = EL('progUmb');
    const txtMin = EL('txtMin');
    const txtUmb = EL('txtUmb');

    const mesSel = EL('mesSel');
    const tbody = document.querySelector('#tabla tbody');
    const tfoot = document.querySelector('#tabla tfoot');

    const tbodySem = document.querySelector('#tablaSemanas tbody');
    const tfootSem = document.querySelector('#tablaSemanas tfoot');

    const pctMuyAlto = EL('pctMuyAlto');
    const pctAlto = EL('pctAlto');
    const pctResto = EL('pctResto');
    const pctExtra = EL('pctExtra');
    const savePct = EL('savePct');
    const resetPct = EL('resetPct');

    const eurMuyAlto = EL('eurMuyAlto');
    const eurAlto = EL('eurAlto');
    const eurResto = EL('eurResto');
    const eurExtra = EL('eurExtra');

    const comMuyAlto = EL('comMuyAlto');
    const comAlto = EL('comAlto');
    const comResto = EL('comResto');
    const comExtra = EL('comExtra');

    // Estado de edici√≥n
    let editDateISO = null;

    // ---------- Inicializar fecha y mes ----------
    const today = new Date();
    if (fecha) fecha.valueAsDate = today;
    if (mesSel) mesSel.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;

    // ---------- Tema ----------
    (function initTheme(){
      let saved = localStorage.getItem(THEME_KEY);
      if(!saved){
        const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        saved = prefersLight ? 'light' : 'dark';
      }
      if(saved === 'light'){
        document.documentElement.setAttribute('data-theme','light');
        document.querySelector('meta[name="theme-color"]').setAttribute('content','#f4f7fb');
      } else {
        document.documentElement.removeAttribute('data-theme');
        document.querySelector('meta[name="theme-color"]').setAttribute('content','#0b1320');
      }
      toggleTheme.addEventListener('click',()=>{
        const isLight = document.documentElement.getAttribute('data-theme')==='light';
        if(isLight){
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem(THEME_KEY,'dark');
          document.querySelector('meta[name="theme-color"]').setAttribute('content','#0b1320');
        }else{
          document.documentElement.setAttribute('data-theme','light');
          localStorage.setItem(THEME_KEY,'light');
          document.querySelector('meta[name="theme-color"]').setAttribute('content','#f4f7fb');
        }
      });
    })();

    // ---------- Storage ----------
    const load = ()=>{ try{ return JSON.parse(localStorage.getItem(KEY) || '{}'); }catch{ return {}; } };
    const save = (data)=> localStorage.setItem(KEY, JSON.stringify(data));
    const snapshot = ()=> localStorage.getItem(KEY) || '{}';
    const pushUndo = ()=> localStorage.setItem(UNDO_KEY, snapshot());
    const canUndo = ()=> !!localStorage.getItem(UNDO_KEY);
    const doUndo = ()=>{ const s = localStorage.getItem(UNDO_KEY); if(s){ localStorage.setItem(KEY, s); localStorage.removeItem(UNDO_KEY); } };

    const loadJornadasState = ()=>{ try{ return JSON.parse(localStorage.getItem(JORNADAS_KEY) || '{}'); }catch{ return {}; } };
    const saveJornadasState = (obj)=> localStorage.setItem(JORNADAS_KEY, JSON.stringify(obj||{}));

    const loadPcts = ()=>{ try{ return JSON.parse(localStorage.getItem(PCTS_KEY) || '{}'); }catch{ return {}; } };
    const savePcts = (p)=> localStorage.setItem(PCTS_KEY, JSON.stringify(p||{}));

    // ---------- Normaliza entradas ----------
    function readEntryFromForm(){
      return {
        diario: clampInt(nDiario.value),
        cuponazo: clampInt(nCuponazo.value),
        sueldazo: clampInt(nSueldazo.value),
        r1: clampInt(libroR1.value),
        r2: clampInt(libroR2.value),
        r3: clampInt(libroR3.value),
        r5: clampInt(libroR5.value),
        r10: clampInt(libroR10.value),
        triples: clampInt(nTriples.value),
        superonce: clampMoney(eurosSuperonce.value),
        miDia: clampInt(nMiDia.value),
        eurojackpot: clampInt(nEurojackpot.value),
        tipo: tipoJornada.value || 'libre'
      };
    }

    // ---------- C√°lculos ----------
    function calcTotal(entry){
      const totalCupones = (entry.diario||0)*PRICES.diario + (entry.cuponazo||0)*PRICES.cuponazo + (entry.sueldazo||0)*PRICES.sueldazo;
      const totalRascas = (entry.r1||0)*LIBROS_RASCAS.r1 + (entry.r2||0)*LIBROS_RASCAS.r2 + (entry.r3||0)*LIBROS_RASCAS.r3 + (entry.r5||0)*LIBROS_RASCAS.r5 + (entry.r10||0)*LIBROS_RASCAS.r10;
      const totalActivos = (entry.triples||0)*PRICES.triples + (entry.superonce||0) + (entry.miDia||0)*PRICES.miDia + (entry.eurojackpot||0)*PRICES.eurojackpot;
      return totalCupones + totalRascas + totalActivos + (entry.extraEur||0);
    }

    function jornadasCalculadas(month){
      let j = 0;
      for(const f of Object.keys(month)){ if(calcTotal(month[f]) > 0) j++; }
      return j;
    }

    function eurosPorCategorias(month){
      let muyAlto=0, alto=0, resto=0, extra=0;
      for(const f of Object.keys(month)){
        const e = month[f]||{};
        muyAlto += (e.diario||0)*PRICES.diario + (e.cuponazo||0)*PRICES.cuponazo + (e.sueldazo||0)*PRICES.sueldazo;
        alto    += (e.r1||0)*LIBROS_RASCAS.r1 + (e.r2||0)*LIBROS_RASCAS.r2 + (e.r3||0)*LIBROS_RASCAS.r3 + (e.r5||0)*LIBROS_RASCAS.r5 + (e.r10||0)*LIBROS_RASCAS.r10;
        resto   += (e.triples||0)*PRICES.triples + (e.superonce||0) + (e.miDia||0)*PRICES.miDia + (e.eurojackpot||0)*PRICES.eurojackpot;
        extra   += (e.extraEur||0);
      }
      return {muyAlto, alto, resto, extra};
    }

    // Fechas / semanas
    const pad2 = (n)=> String(n).padStart(2,'0');
    const parseISO = (s)=>{ const [Y,M,D]=s.split('-').map(Number); return new Date(Y, M-1, D); };
    const sameMonth = (d, yyyymm)=> d.getFullYear()===(+yyyymm.slice(0,4)) && (d.getMonth()+1)===(+yyyymm.slice(5,7));
    function mondayOf(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; }
    function sundayOf(d){ const m=mondayOf(d); const s=new Date(m); s.setDate(m.getDate()+6); s.setHours(23,59,59,999); return s; }

    // ---------- Render principal ----------
    function render(){
      const yyyymm = mesSel.value;
      const month = (function(){ const d = load(); return d[yyyymm] || {}; })();
      const fechas = Object.keys(month).sort();

      // Tabla d√≠as
      tbody.innerHTML = '';
      let tot = {diario:0,cuponazo:0,sueldazo:0,r1:0,r2:0,r3:0,r5:0,r10:0,triples:0,superonce:0,miDia:0,eurojackpot:0,extraEur:0};
      let vendido = 0;

      for(const f of fechas){
        const e = month[f];
        const rowTotal = calcTotal(e);
        vendido += rowTotal;
        for(const k in tot){ tot[k]+= (e[k]||0); }

        let badgeClass='bad', badgeText='Pendiente';
        if(rowTotal >= UMBRAL_DIA){ badgeClass='good'; badgeText='Umbral'; }
        else if(rowTotal >= MIN_DIA){ badgeClass='warn'; badgeText='M√≠nimo'; }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${f}</td>
          <td>${e.diario||0}</td>
          <td>${e.cuponazo||0}</td>
          <td>${e.sueldazo||0}</td>
          <td>${e.r1||0}</td>
          <td>${e.r2||0}</td>
          <td>${e.r3||0}</td>
          <td>${e.r5||0}</td>
          <td>${e.r10||0}</td>
          <td>${e.triples||0}</td>
          <td>${fmtEur(e.superonce||0)}</td>
          <td>${e.miDia||0}</td>
          <td>${e.eurojackpot||0}</td>
          <td class="mono">${fmtEur(rowTotal)}</td>
          <td><span class="badge ${badgeClass}">${badgeText}</span></td>
          <td>
            <div class="row-actions">
              <button class="pill" data-edit="${f}" title="Editar d√≠a">‚úèÔ∏è</button>
              <button class="pill" data-del="${f}" title="Borrar fila">üóëÔ∏è</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      }

      const totEur = calcTotal(tot);
      tfoot.innerHTML = `
        <tr>
          <th>Total</th>
          <th>${tot.diario}</th>
          <th>${tot.cuponazo}</th>
          <th>${tot.sueldazo}</th>
          <th>${tot.r1}</th>
          <th>${tot.r2}</th>
          <th>${tot.r3}</th>
          <th>${tot.r5}</th>
          <th>${tot.r10}</th>
          <th>${tot.triples}</th>
          <th class="mono">${fmtEur(tot.superonce)}</th>
          <th>${tot.miDia}</th>
          <th>${tot.eurojackpot}</th>
          <th class="mono">${fmtEur(totEur)}</th>
          <th></th><th></th>
        </tr>`;

      // Jornadas (calc vs usadas)
      const jCalc = jornadasCalculadas(month);
      const jState = (loadJornadasState()[yyyymm] || {enabled:false, value:0});
      chkJornadasManual.checked = !!jState.enabled;
      inpJornadas.value = jState.value || '';
      const jUsadas = jState.enabled ? Math.max(0, Math.min(26, Number(jState.value||0))) : jCalc;

      // KPIs y progreso
      const minimo = MIN_DIA * jUsadas;
      const umbral = UMBRAL_DIA * jUsadas;
      kpiJornadasCalc.textContent = jCalc;
      kpiJornadasUsadas.textContent = jUsadas;
      kpiVendido.textContent = fmtEur(vendido);
      kpiMinimo.textContent = fmtEur(minimo);
      kpiUmbral.textContent = fmtEur(umbral);

      const vMin = minimo>0? Math.min(1, vendido/minimo): 0;
      const vUmb = umbral>0? Math.min(1, vendido/umbral): 0;
      progMin.value = vMin; progUmb.value = vUmb;
      txtMin.textContent = vendido>=minimo? `‚úÖ Alcanzado. +${fmtEur(vendido-minimo)} sobre m√≠nimo.` : `Faltan ${fmtEur(minimo-vendido)} para el m√≠nimo.`;
      txtUmb.textContent = vendido>=umbral? `‚úÖ Alcanzado. +${fmtEur(vendido-umbral)} sobre umbral.` : `Faltan ${fmtEur(umbral-vendido)} para el umbral.`;

      // Comisiones por categor√≠as
      const p = Object.assign({muyAlto:0, alto:0, resto:0, extra:0}, loadPcts());
      pctMuyAlto.value = p.muyAlto || '';
      pctAlto.value    = p.alto || '';
      pctResto.value   = p.resto || '';
      pctExtra.value   = p.extra || '';

      const eur = eurosPorCategorias(month);
      eurMuyAlto.textContent = fmtEur(eur.muyAlto);
      eurAlto.textContent    = fmtEur(eur.alto);
      eurResto.textContent   = fmtEur(eur.resto);
      eurExtra.textContent   = fmtEur(eur.extra);

      const cMuy = eur.muyAlto * (Number(p.muyAlto||0)/100);
      const cAlt = eur.alto    * (Number(p.alto||0)/100);
      const cRes = eur.resto   * (Number(p.resto||0)/100);
      const cExt = eur.extra   * (Number(p.extra||0)/100);
      const cTot = cMuy + cAlt + cRes + cExt;

      comMuyAlto.textContent = fmtEur(cMuy);
      comAlto.textContent    = fmtEur(cAlt);
      comResto.textContent   = fmtEur(cRes);
      comExtra.textContent   = fmtEur(cExt);
      kpiComisionTotal.textContent = fmtEur(cTot);

      // Acciones fila
      tbody.querySelectorAll('button[data-del]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const f = btn.getAttribute('data-del');
          const yyyymm = mesSel.value;
          const data = load();
          if(data[yyyymm]){
            pushUndo();
            delete data[yyyymm][f];
            save(data);
            if(editDateISO===f) salirEdicion();
            render();
          }
        });
      });
      tbody.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const f = btn.getAttribute('data-edit');
          const yyyymm = mesSel.value;
          const data = load();
          const e = data[yyyymm]?.[f];
          if(!e) return;
          // Entrar en modo edici√≥n
          editDateISO = f;
          fecha.value = f;
          nDiario.value = e.diario||0; nCuponazo.value = e.cuponazo||0; nSueldazo.value = e.sueldazo||0;
          libroR1.value=e.r1||0; libroR2.value=e.r2||0; libroR3.value=e.r3||0; libroR5.value=e.r5||0; libroR10.value=e.r10||0;
          nTriples.value=e.triples||0; eurosSuperonce.value=e.superonce||0; nMiDia.value=e.miDia||0; nEurojackpot.value=e.eurojackpot||0;
          tipoJornada.value=e.tipo||'libre';
          guardarReemplazar.style.display='inline-block';
          cancelarEdicion.style.display='inline-block';
          guardarDia.textContent='üíæ Guardar (sumar)';
        });
      });

      // Resumen por semanas
      renderSemanas(yyyymm, month);

      // Deshacer visible si hay snapshot
      btnUndo.disabled = !canUndo();
    }

    // Sumar y reemplazar
    function sumaGuardada(prev, add){
      const out = Object.assign({}, prev||{});
      const keys = ['diario','cuponazo','sueldazo','r1','r2','r3','r5','r10','triples','superonce','miDia','eurojackpot','extraEur','tipo'];
      for(const k of keys){
        if(k==='tipo'){ out[k] = (add[k] || out[k] || 'libre'); continue; }
        out[k] = (out[k]||0) + (add[k]||0);
      }
      return out;
    }
    function salirEdicion(){
      editDateISO = null;
      guardarReemplazar.style.display='none';
      cancelarEdicion.style.display='none';
      guardarDia.textContent='üíæ Guardar (sumar)';
    }

    // Semanas (L‚ÄìD)
    function renderSemanas(yyyymm, month){
      tbodySem.innerHTML=''; tfootSem.innerHTML='';
      const weeks = {};
      let totalMes=0, totalJornadas=0, totalMin=0, totalUmb=0;

      for(const f of Object.keys(month)){
        const e = month[f]; const tot = calcTotal(e);
        if(tot<=0) continue;
        const d = parseISO(f); if(!sameMonth(d, yyyymm)) continue;
        const mon = mondayOf(d), sun = sundayOf(d);

        const [Y,M] = yyyymm.split('-').map(Number);
        const firstMonth = new Date(Y, M-1, 1);
        const lastMonth = new Date(Y, M, 0);
        const showStart = mon < firstMonth ? firstMonth : mon;
        const showEnd   = sun > lastMonth ? lastMonth : sun;

        const key = `${mon.getFullYear()}-${pad2(mon.getMonth()+1)}-${pad2(mon.getDate())}|${sun.getFullYear()}-${pad2(sun.getMonth()+1)}-${pad2(sun.getDate())}`;
        if(!weeks[key]) weeks[key] = { vendido:0, jornadas:0, showStart, showEnd, mon };
        weeks[key].vendido += tot; weeks[key].jornadas += 1;
      }

      const wkeys = Object.keys(weeks).sort((a,b)=> weeks[a].mon - weeks[b].mon);
      for(const key of wkeys){
        const w = weeks[key];
        const minW = MIN_DIA * w.jornadas;
        const umbW = UMBRAL_DIA * w.jornadas;

        totalMes += w.vendido; totalJornadas += w.jornadas; totalMin += minW; totalUmb += umbW;

        let badgeClass='bad', badgeText='Pendiente';
        if(w.vendido >= umbW){ badgeClass='good'; badgeText='Umbral'; }
        else if(w.vendido >= minW){ badgeClass='warn'; badgeText='M√≠nimo'; }

        const rango = `${w.showStart.getFullYear()}-${pad2(w.showStart.getMonth()+1)}-${pad2(w.showStart.getDate())} a ${w.showEnd.getFullYear()}-${pad2(w.showEnd.getMonth()+1)}-${pad2(w.showEnd.getDate())}`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${key.split('|')[0]} ‚Üí ${key.split('|')[1]}</td>
          <td class="nowrap">${rango}</td>
          <td>${w.jornadas}</td>
          <td class="mono">${fmtEur(w.vendido)}</td>
          <td class="mono">${fmtEur(minW)}</td>
          <td class="mono">${fmtEur(umbW)}</td>
          <td><span class="badge ${badgeClass}">${badgeText}</span></td>`;
        tbodySem.appendChild(tr);
      }
      if(wkeys.length){
        const tf = document.createElement('tr');
        tf.innerHTML = `<th>Total</th><th></th><th>${totalJornadas}</th><th class="mono">${fmtEur(totalMes)}</th><th class="mono">${fmtEur(totalMin)}</th><th class="mono">${fmtEur(totalUmb)}</th><th></th>`;
        tfootSem.appendChild(tf);
      }
    }

    // ---------- Listeners ----------
    guardarDia.addEventListener('click',()=>{
      if(!fecha.value){ alert('Selecciona una fecha.'); return; }
      const d = new Date(fecha.value);
      const yyyymm = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const key = d.toISOString().slice(0,10);

      const entry = readEntryFromForm();
      const data = load(); data[yyyymm] = data[yyyymm] || {};
      pushUndo();
      data[yyyymm][key] = sumaGuardada(data[yyyymm][key], entry); // SUMA
      save(data); render();
    });

    guardarReemplazar.addEventListener('click',()=>{
      if(!fecha.value){ alert('Selecciona una fecha.'); return; }
      const d = new Date(fecha.value);
      const yyyymm = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const key = d.toISOString().slice(0,10);

      const entry = readEntryFromForm();
      const data = load(); data[yyyymm] = data[yyyymm] || {};
      pushUndo();
      data[yyyymm][key] = entry; // REEMPLAZA
      save(data); salirEdicion(); render();
    });

    cancelarEdicion.addEventListener('click',()=>{ salirEdicion(); });

    limpiarForm.addEventListener('click',()=>{
      [nDiario,nCuponazo,nSueldazo,libroR1,libroR2,libroR3,libroR5,libroR10,nTriples,eurosSuperonce,nMiDia,nEurojackpot].forEach(i=>i.value='');
    });

    mesSel.addEventListener('change', render);

    btnUndo.addEventListener('click',()=>{
      if(!canUndo()) return;
      doUndo(); render();
    });

    chkJornadasManual.addEventListener('change', ()=>{
      const yyyymm = mesSel.value;
      const st = loadJornadasState();
      st[yyyymm] = st[yyyymm] || {enabled:false, value:0};
      st[yyyymm].enabled = chkJornadasManual.checked;
      if(!st[yyyymm].enabled){ st[yyyymm].value = 0; inpJornadas.value = ''; }
      saveJornadasState(st);
      render();
    });

    inpJornadas.addEventListener('input', ()=>{
      const yyyymm = mesSel.value;
      const st = loadJornadasState();
      st[yyyymm] = st[yyyymm] || {enabled:false, value:0};
      st[yyyymm].value = Math.max(0, Math.min(26, Number(inpJornadas.value||0)));
      saveJornadasState(st);
      render();
    });

    savePct.addEventListener('click', ()=>{
      const p = { muyAlto:Number(pctMuyAlto.value||0), alto:Number(pctAlto.value||0), resto:Number(pctResto.value||0), extra:Number(pctExtra.value||0) };
      savePcts(p);
      render();
    });
    resetPct.addEventListener('click', ()=>{
      localStorage.removeItem(PCTS_KEY);
      pctMuyAlto.value = pctAlto.value = pctResto.value = pctExtra.value = '';
      render();
    });

    // CSV MES
    exportCsv.addEventListener('click',()=>{
      const yyyymm = mesSel.value;
      const month = (load()[yyyymm]||{});
      const fechas = Object.keys(month).sort();
      const rows = [['Fecha','Diario','Cuponazo','Sueldazo','R1‚Ç¨(libros)','R2‚Ç¨','R3‚Ç¨','R5‚Ç¨','R10‚Ç¨','Triples','SuperONCE ‚Ç¨','Mi D√≠a','Eurojackpot','Total ‚Ç¨','Estado objetivo']];
      for(const f of fechas){
        const e = month[f]; const tEur = calcTotal(e);
        const estado = tEur>=UMBRAL_DIA ? 'Umbral' : (tEur>=MIN_DIA ? 'M√≠nimo' : 'Pendiente');
        rows.push([f,e.diario||0,e.cuponazo||0,e.sueldazo||0,e.r1||0,e.r2||0,e.r3||0,e.r5||0,e.r10||0,e.triples||0,(e.superonce||0).toFixed(2),e.miDia||0,e.eurojackpot||0,tEur.toFixed(2),estado]);
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).split('"').join('""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `ventas_${yyyymm}.csv`; a.click(); URL.revokeObjectURL(a.href);
    });

    // BACKUP/RESTORE JSON (todo)
    exportJson.addEventListener('click',()=>{
      const all = { data: load(), jornadas: loadJornadasState(), pcts: loadPcts(), exportedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(all,null,2)],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `once_backup.json`; a.click(); URL.revokeObjectURL(a.href);
    });
    importJsonBtn.addEventListener('click',()=> importJson.click());
    importJson.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);
        if(obj && obj.data){
          pushUndo();
          localStorage.setItem(KEY, JSON.stringify(obj.data||{}));
          if(obj.jornadas) localStorage.setItem(JORNADAS_KEY, JSON.stringify(obj.jornadas));
          if(obj.pcts) localStorage.setItem(PCTS_KEY, JSON.stringify(obj.pcts));
          render();
          alert('Importaci√≥n completada.');
        } else {
          alert('Archivo no v√°lido.');
        }
      }catch(err){ alert('Error al importar JSON.'); }
      importJson.value = '';
    });

    // Borrar mes
    resetMes.addEventListener('click',()=>{
      const yyyymm = mesSel.value;
      if(!confirm(`¬øBorrar todos los datos de ${yyyymm}?`)) return;
      const data = load(); if(data[yyyymm]){
        pushUndo();
        delete data[yyyymm]; save(data);
      }
      const st = loadJornadasState(); if(st[yyyymm]){ delete st[yyyymm]; saveJornadasState(st); }
      render();
    });

    // ---------- Tests en consola ----------
    function runTests(){
      try{
        console.log('%c[Tests] Iniciando...', 'color:#4da3ff');
        // Test 1: formato exacto
        console.assert(fmtEur(1234.5) === '1.234,50', 'fmtEur deber√≠a formatear 1.234,50');
        // Test 2: calcTotal
        const sample = {diario:10, cuponazo:2, sueldazo:0, r1:1, r3:1, triples:4, superonce:12.5, miDia:3, eurojackpot:2};
        const expected = (10*2)+(2*3)+(0*2) + (1*100)+(1*150) + (4*0.5)+12.5+(3*1)+(2*2);
        console.assert(Math.abs(calcTotal(sample)-expected)<1e-9, 'calcTotal incorrecto');
        // Test 3: jornadasCalculadas
        const m = { '2025-08-01':{diario:1}, '2025-08-02':{r1:0}, '2025-08-03':{superonce:5} };
        console.assert(jornadasCalculadas(m)===2, 'jornadasCalculadas debe ser 2');
        // Test 4: eurosPorCategorias
        const ecat = eurosPorCategorias({'2025-08-01':{diario:1, r1:1, superonce:10}});
        console.assert(ecat.muyAlto===2 && ecat.alto===100 && ecat.resto===10, 'eurosPorCategorias fallo');
        console.log('%c[Tests] OK', 'color:#1ea64b');
      }catch(err){ console.warn('[Tests] error:', err); }
    }

    // ---------- Inicial ----------
    render();
    runTests();
  })();

  // Service Worker (silencioso si falta)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('SW registrado', reg.scope))
        .catch(() => console.warn('SW no encontrado (404). Registro omitido.'));
    });
  }
  </script>
</body>
</html>
