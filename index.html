<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Comisiones ONCE 2025</title>
  <meta name="theme-color" content="#0f766e" />
  <!-- PWA (ya tienes manifest y SW en el repo) -->
  <link rel="manifest" href="manifest.json" />
  <style>
    :root{
      --bg:#ffffff;--fg:#111827;--card:#f1f5f9;--muted:#6b7280;--primary:#0f766e;--accent:#22c55e;--danger:#ef4444;--warn:#f59e0b;--ok:#16a34a;--ring:#10b981;
    }
    [data-theme="dark"]{
      --bg:#0b1220;--fg:#e5e7eb;--card:#0f172a;--muted:#9ca3af;--primary:#22d3ee;--accent:#34d399;--danger:#f87171;--warn:#fbbf24;--ok:#22c55e;--ring:#06b6d4;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.4}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid #0001;z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{margin:8px 0 0;color:var(--primary);font-size:1.25rem}
    .sub{margin:4px 0 12px;color:var(--muted);font-size:.9rem}
    .grid{display:grid;gap:12px}
    @media(min-width:840px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid #0002;border-radius:12px;padding:12px}
    label{display:block;font-size:.9rem;margin-bottom:6px;color:var(--muted)}
    select,input[type="number"],input[type="date"]{width:100%;padding:10px 12px;border:1px solid #0002;border-radius:10px;background:var(--bg);color:var(--fg);outline:none}
    input[type="number"]{appearance:textfield}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600}
    .btn-primary{background:var(--primary);color:white}
    .btn-ghost{background:transparent;border:1px solid #0002;color:var(--fg)}
    .btn-danger{background:var(--danger);color:white}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.8rem;border:1px solid #0003}
    .ok{background:#16a34a22;color:var(--ok)}
    .warn{background:#f59e0b22;color:var(--warn)}
    .bad{background:#ef444422;color:var(--danger)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #0002;font-size:.92rem}
    th{color:var(--muted);text-align:left}
    tfoot td{font-weight:700}
    .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(min-width:620px){.kpi{grid-template-columns:repeat(4,1fr)}}
    .kpi .box{background:var(--bg);border:1px solid #0002;border-radius:12px;padding:10px}
    .box h3{margin:0 0 4px;font-size:.85rem;color:var(--muted)}
    .box p{margin:0;font-size:1.05rem;font-weight:700}
    .hint{color:var(--muted);font-size:.85rem}
    .progress{height:10px;background:#0002;border-radius:999px;overflow:hidden}
    .progress > span{display:block;height:100%;background:linear-gradient(90deg,var(--ring),var(--accent));width:0%}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .switch{float:right}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="grid-template-columns:1fr auto;align-items:center">
        <div>
          <h1>Calculadora de Comisiones ONCE 2025</h1>
          <p class="sub">Registro diario → Sumatorio mensual → Jornadas → Mínimo/Umbral → Tramo y objetivo siguiente</p>
        </div>
        <button id="btnTema" class="btn btn-ghost switch" onclick="toggleTema()">🌗 Oscuro</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <!-- IZQUIERDA: Registro diario -->
    <section class="card">
      <h2 style="margin:0 0 8px">Registrar venta del día</h2>
      <div class="row">
        <div>
          <label>Fecha</label>
          <input type="date" id="fecha" />
        </div>
        <div>
          <label>Tipo</label>
          <select id="tipo" onchange="autoPrecio()">
            <option value="diario">Diario</option>
            <option value="cuponazo">Cuponazo</option>
            <option value="sueldazo">Sueldazo</option>
            <option value="rasca1">Rasca 1 €</option>
            <option value="rasca2">Rasca 2 €</option>
            <option value="rasca3">Rasca 3 €</option>
            <option value="rasca5">Rasca 5 €</option>
            <option value="rasca10">Rasca 10 €</option>
            <option value="triplex">Triplex (0,50 €)</option>
            <option value="superonce">Super Once (1 €)</option>
            <option value="midia">Mi Día (1 €)</option>
            <option value="eurojackpot">Eurojackpot (2 €)</option>
            <option value="extraordinario">Extraordinario</option>
            <option value="otros">Resto</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Unidades vendidas</label>
          <input type="number" id="unidades" min="0" value="0" />
        </div>
        <div>
          <label>Precio (€)</label>
          <input type="number" id="precio" step="0.1" min="0" value="2" />
        </div>
      </div>
      <div class="row-actions" style="margin-top:4px">
        <button class="btn btn-primary" onclick="addVenta()">➕ Añadir día</button>
        <button class="btn btn-ghost" onclick="ajustarMes(-1)">⟵ Mes anterior</button>
        <button class="btn btn-ghost" onclick="ajustarMes(1)">Mes siguiente ⟶</button>
        <button class="btn btn-danger" onclick="borrarMes()">🧹 Borrar mes</button>
      </div>
      <p class="hint" id="mesLabel"></p>

      <div class="kpi" style="margin-top:8px">
        <div class="box"><h3>Jornadas</h3><p id="kpiJornadas">0</p></div>
        <div class="box"><h3>Total vendido</h3><p id="kpiTotal">0,00 €</p></div>
        <div class="box"><h3>Mínimo</h3><p id="kpiMin">0,00 €</p></div>
        <div class="box"><h3>Umbral</h3><p id="kpiUmb">0,00 €</p></div>
      </div>

      <div class="card" style="margin-top:12px;background:var(--bg)">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
          <div>
            <strong>Tramo (Resto de productos): </strong>
            <span id="tramoActual" class="pill"></span>
          </div>
          <div class="hint" id="siguienteInfo"></div>
        </div>
        <div class="progress" style="margin-top:8px"><span id="barra"></span></div>
      </div>
    </section>

    <!-- DERECHA: Tabla del mes -->
    <section class="card">
      <h2 style="margin:0 0 8px">Ventas del mes</h2>
      <div style="overflow:auto;max-height:60vh;border:1px solid #0002;border-radius:10px;background:var(--bg)">
        <table id="tabla">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Tipo</th>
              <th>Unidades</th>
              <th>Precio</th>
              <th>Importe</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="4">Total mes</td>
              <td id="totalMes">0,00 €</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <p class="hint" style="margin-top:8px">
        Nota: Mínimo y Umbral se calculan con <strong>142 €</strong> y <strong>210 €</strong> por jornada (día con ventas).
        Tramos (Resto): <strong>2.5%</strong> → <strong>6%</strong> → <strong>10%</strong> → <strong>13%</strong> → <strong>14%</strong> → <strong>15%</strong> → <strong>16%</strong> → <strong>17.5%</strong>.
      </p>
    </section>
  </main>

  <script>
    // === CONFIGURACIÓN ===
    const PRECIOS = {
      diario:2, cuponazo:3, sueldazo:2,
      rasca1:1, rasca2:2, rasca3:3, rasca5:5, rasca10:10,
      triplex:0.5, superonce:1, midia:1, eurojackpot:2,
      extraordinario:2.5, otros:1.5
    };

    // Tramos "Resto de productos": umbrales base por 1 jornada (euros)
    // (son los importes de la primera fila de la tabla para cada %)
    const UMBRALES_BASE = [
      {pct:2.5,  base:210}, // = Umbral (empieza comisionar)
      {pct:6.0,  base:289},
      {pct:10.0, base:344},
      {pct:13.0, base:400},
      {pct:14.0, base:455},
      {pct:15.0, base:510},
      {pct:16.0, base:566},
      {pct:17.5, base:677}
    ];

    // === ESTADO ===
    let hoy = new Date();
    let cursor = { y: hoy.getFullYear(), m: hoy.getMonth() }; // m: 0..11

    // === UTILIDADES ===
    const fmtEur = n => (n||0).toLocaleString('es-ES',{style:'currency',currency:'EUR'});
    const keyMes = ({y,m}) => `ventas-${y}-${String(m+1).padStart(2,'0')}`;

    function getMes() {
      const raw = localStorage.getItem(keyMes(cursor));
      return raw ? JSON.parse(raw) : []; // [{fecha, tipo, unidades, precio, importe}]
    }
    function setMes(data){
      localStorage.setItem(keyMes(cursor), JSON.stringify(data));
    }
    function autoPrecio(){
      const t = tipo.value;
      if (t in PRECIOS) precio.value = PRECIOS[t];
    }
    function ajustarMes(delta){
      let m = cursor.m + delta, y = cursor.y;
      if (m<0){m=11;y--;} else if (m>11){m=0;y++;}
      cursor = {y,m};
      pintar();
    }
    function toggleTema(){
      const html = document.documentElement;
      const dark = html.getAttribute('data-theme') === 'dark';
      html.setAttribute('data-theme', dark ? 'light' : 'dark');
      btnTema.textContent = dark ? '🌗 Oscuro' : '🌞 Claro';
      localStorage.setItem('tema', html.getAttribute('data-theme'));
    }
    (function initTema(){
      const saved = localStorage.getItem('tema');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
      btnTema.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '🌞 Claro' : '🌗 Oscuro';
    })();

    // === LÓGICA DE NEGOCIO ===
    function addVenta(){
      const f = fecha.value;
      const t = tipo.value;
      const u = Number(unidades.value||0);
      const p = Number(precio.value||0);
      if(!f) return alert('Selecciona la fecha.');
      if(u<=0) return alert('Indica unidades > 0.');
      if(p<0) return alert('Precio inválido.');

      const imp = +(u*p).toFixed(2);
      const data = getMes();
      data.push({fecha:f, tipo:t, unidades:u, precio:p, importe:imp});
      setMes(data);
      unidades.value = 0;
      pintar();
    }

    function borrarMes(){
      if(!confirm('¿Seguro que quieres borrar todas las ventas del mes?')) return;
      localStorage.removeItem(keyMes(cursor));
      pintar();
    }

    function borrarFila(idx){
      const data = getMes();
      data.splice(idx,1);
      setMes(data);
      pintar();
    }

    function jornadasUnicas(regs){
      // número de días distintos con cualquier venta
      const set = new Set(regs.map(r => r.fecha));
      return set.size;
    }

    function calcMinimo(j){ return 142 * j; }
    function calcUmbral(j){ return 210 * j; }

    function calcTramo(total, j){
      if (j<=0) return {pct:0, actualHasta:0, nextPct:null, nextAt:0};
      // Escala los umbrales por jornadas
      const escalados = UMBRALES_BASE.map(x => ({pct:x.pct, at: x.base * j}));
      // Busca tramo actual (máximo at <= total)
      let actual = {pct:0, at:0};
      for (const t of escalados){
        if (total >= t.at) actual = {pct:t.pct, at:t.at};
      }
      // Siguiente
      const next = escalados.find(t => t.at > total) || null;
      return {
        pct: actual.pct,
        actualHasta: actual.at,
        nextPct: next ? next.pct : null,
        nextAt: next ? next.at : null
      };
    }

    // === RENDER ===
    function pintar(){
      // fecha por defecto al día dentro del mes activo
      const def = new Date(cursor.y, cursor.m, Math.min(hoy.getDate(), 28));
      fecha.value = def.toISOString().slice(0,10);

      // Cabecera mes
      const mesStr = new Date(cursor.y, cursor.m, 1).toLocaleDateString('es-ES',{month:'long',year:'numeric'});
      mesLabel.textContent = `Mes activo: ${mesStr}`;

      // Tabla
      const regs = getMes().sort((a,b)=> a.fecha.localeCompare(b.fecha));
      const tbody = document.querySelector('#tabla tbody');
      tbody.innerHTML = '';
      let total = 0;
      regs.forEach((r, i) => {
        total += r.importe;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.fecha).toLocaleDateString('es-ES')}</td>
          <td>${mapTipo(r.tipo)}</td>
          <td>${r.unidades}</td>
          <td>${fmtEur(r.precio)}</td>
          <td>${fmtEur(r.importe)}</td>
          <td><button class="btn btn-ghost" onclick="borrarFila(${i})">🗑️</button></td>
        `;
        tbody.appendChild(tr);
      });
      totalMes.textContent = fmtEur(total);

      // KPIs
      const j = jornadasUnicas(regs);
      const minimo = calcMinimo(j);
      const umbral = calcUmbral(j);
      kpiJornadas.textContent = j;
      kpiTotal.textContent = fmtEur(total);
      kpiMin.textContent = fmtEur(minimo);
      kpiUmb.textContent = fmtEur(umbral);

      // Estado visual de mínimo/umbral
      kpiMin.parentElement.className = 'box';
      kpiUmb.parentElement.className = 'box';
      if (total < minimo){
        kpiMin.parentElement.classList.add('bad');
      } else if (total < umbral){
        kpiMin.parentElement.classList.add('ok');
        kpiUmb.parentElement.classList.add('warn');
      } else {
        kpiMin.parentElement.classList.add('ok');
        kpiUmb.parentElement.classList.add('ok');
      }

      // Tramo comisión (Resto productos)
      const tramo = calcTramo(total, j);
      const pill = tramo.pct === 0 ? 'Sin comisión' : `${tramo.pct.toFixed(1)}%`;
      tramoActual.textContent = pill;
      tramoActual.className = 'pill ' + (tramo.pct===0 ? 'bad' : 'ok');

      // Progreso hacia siguiente tramo
      const barra = document.getElementById('barra');
      let info = '';
      if (tramo.nextPct){
        const falta = Math.max(0, tramo.nextAt - total);
        info = `Siguiente: ${tramo.nextPct.toFixed(1)}% a ${fmtEur(tramo.nextAt)} (faltan ${fmtEur(falta)})`;
        const denom = Math.max(1, tramo.nextAt - tramo.actualHasta);
        const avance = Math.min(100, Math.max(0, ((total - tramo.actualHasta) / denom) * 100));
        barra.style.width = `${avance}%`;
      } else {
        info = j>0 ? '¡Máximo tramo alcanzado!' : 'Añade ventas para iniciar tramo';
        barra.style.width = tramo.pct===0 ? '0%' : '100%';
      }
      siguienteInfo.textContent = info;
    }

    function mapTipo(t){
      const m = {
        diario:'Diario',cuponazo:'Cuponazo',sueldazo:'Sueldazo',
        rasca1:'Rasca 1€',rasca2:'Rasca 2€',rasca3:'Rasca 3€',rasca5:'Rasca 5€',rasca10:'Rasca 10€',
        triplex:'Triplex',superonce:'Super Once',midia:'Mi Día',eurojackpot:'Eurojackpot',
        extraordinario:'Extraordinario',otros:'Otros'
      };
      return m[t]||t;
    }

    // Prefija fecha y precio al cargar
    (function init(){
      // fecha hoy en el mes activo
      const d = new Date(cursor.y, cursor.m, hoy.getDate());
      fecha.value = d.toISOString().slice(0,10);
      autoPrecio();
      pintar();
    })();

    // PWA: registra SW si existe en tu repo
    if ('serviceWorker' in navigator) {
      fetch('service-worker.js',{method:'HEAD'}).then(r=>{
        if(r.ok){
          navigator.serviceWorker.register('service-worker.js')
            .then(reg=>console.log('SW registrado', location.href))
            .catch(err=>console.warn('SW error', err));
        } else {
          console.log('SW no encontrado (404). Registro omitido.');
        }
      }).catch(()=>{});
    }
  </script>
</body>
</html>
