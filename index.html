<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Comisiones ONCE 2025</title>
<meta name="theme-color" content="#121212" />
<style>
  :root{
    --bg:#ffffff; --fg:#111; --card:#f6f6f6; --muted:#6b7280;
    --primary:#0d6efd; --ok:#198754; --warn:#f59e0b; --bad:#dc3545; --border:#0002;
    --bar:#0d6efd33;
  }
  [data-theme="dark"]{
    --bg:#121212; --fg:#f1f1f1; --card:#1e1e1e; --muted:#a3a3a3;
    --primary:#62a7ff; --ok:#5ddf9a; --warn:#ffd166; --bad:#ff8b94; --border:#fff2;
    --bar:#62a7ff33;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:var(--bg);color:var(--fg)}
  header{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:1rem;position:sticky;top:0;background:var(--bg)}
  h1{font-size:1.1rem;margin:0}
  main{max-width:980px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
  .card{background:var(--card);border-radius:12px;padding:1rem}
  label{display:block;font-weight:600;margin:.35rem 0}
  input,select,button{width:100%;padding:.7rem .8rem;border-radius:10px;border:1px solid var(--border);background:#fff}
  [data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] button{background:#111;border-color:var(--border);color:var(--fg)}
  .grid{display:grid;gap:.75rem}
  @media(min-width:860px){ .cols-2{grid-template-columns:1fr 1fr} .cols-3{grid-template-columns:1fr 1fr 1fr} }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
  .actions{display:flex;gap:.5rem;flex-wrap:wrap}
  button.primary{background:var(--primary);color:#fff;border:none}
  button.danger{background:var(--bad);color:#fff;border:none}
  .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.85rem;border:1px solid;vertical-align:middle}
  .ok{border-color:var(--ok);color:var(--ok);background:color-mix(in srgb, var(--ok) 16%, transparent)}
  .warn{border-color:var(--warn);color:#7a5a00;background:color-mix(in srgb, var(--warn) 20%, transparent)}
  .bad{border-color:var(--bad);color:#7a1a20;background:color-mix(in srgb, var(--bad) 20%, transparent)}
  .muted{color:var(--muted)}
  .kpi{font-size:1rem;margin:.25rem 0}
  .mono{font-variant-numeric:tabular-nums}
  .section-title{margin:.2rem 0 .8rem;font-size:1rem}
  table{width:100%;border-collapse:collapse;margin-top:.5rem}
  th,td{padding:.55rem;border-bottom:1px solid var(--border);text-align:left}
  td.num, th.num{text-align:right}

  .progress{
    background:var(--bar); border-radius:10px; height:14px; overflow:hidden; position:relative;
  }
  .progress > span{
    display:block; height:100%; background:var(--primary); width:0%;
    transition:width .3s ease;
  }
  .chips{display:flex;gap:.5rem;flex-wrap:wrap}
  .small{font-size:.9rem}
</style>
</head>
<body>
<header>
  <h1>Calculadora de Comisiones ONCE 2025</h1>
  <div class="actions">
    <button id="btnTema" title="Cambiar tema">üåó Tema</button>
  </div>
</header>

<main>
  <!-- CABECERA DE JORNADAS / UMBRALES EN VIVO -->
  <section class="card">
    <h2 class="section-title">‚öôÔ∏è Par√°metros del mes</h2>
    <div class="grid cols-3">
      <div>
        <label for="jornadasObj">Jornadas objetivo (1‚Äì26)</label>
        <input id="jornadasObj" type="number" min="1" max="26" value="20" />
      </div>
      <div>
        <label>Umbrales con jornadas</label>
        <div class="chips" id="umbralesChips" aria-live="polite"></div>
        <div class="muted small" style="margin-top:.25rem">M√≠nimo = 142 ‚Ç¨ √ó jornadas ¬∑ Umbral = 210 ‚Ç¨ √ó jornadas</div>
      </div>
      <div>
        <label for="mesFiltro">Mes visible</label>
        <input id="mesFiltro" type="month" />
      </div>
    </div>
  </section>

  <!-- CALCULADORA R√ÅPIDA -->
  <section class="card">
    <h2 class="section-title">üßÆ Calculadora r√°pida</h2>
    <div class="grid cols-3">
      <div>
        <label for="tipo">Tipo de producto</label>
        <select id="tipo">
          <option value="diario">Diario</option>
          <option value="cuponazo">Cuponazo</option>
          <option value="sueldazo">Sueldazo</option>
          <option value="rasca">Rasca</option>
          <option value="triplex">Triplex</option>
          <option value="superonce">Super Once</option>
          <option value="midia">Mi D√≠a</option>
          <option value="eurojackpot">Eurojackpot</option>
          <option value="extraordinario">Extraordinario</option>
          <option value="resto">Otros</option>
        </select>
      </div>

      <div>
        <label for="vendidos">Unidades vendidas</label>
        <input id="vendidos" type="number" min="0" value="0" />
      </div>

      <div>
        <label for="precio">Precio por unidad (‚Ç¨)</label>
        <input id="precio" type="number" step="0.01" min="0" value="2" />
        <div class="muted small" style="margin-top:.25rem">Se autocompleta por producto; puedes cambiarlo.</div>
      </div>

      <div class="actions" style="align-items:end">
        <button class="primary" id="btnCalc">üî¢ Calcular</button>
        <button id="btnReset">üßπ Limpiar</button>
      </div>
    </div>

    <div id="out" class="card" style="margin-top:1rem">
      <div class="muted">Introduce datos y pulsa ‚ÄúCalcular‚Äù.</div>
    </div>
  </section>

  <!-- REGISTRO DIARIO -->
  <section class="card">
    <h2 class="section-title">üóìÔ∏è Registro diario (se guarda en este dispositivo)</h2>
    <div class="grid cols-3">
      <div>
        <label for="rFecha">Fecha</label>
        <input id="rFecha" type="date" />
        <div class="muted small" style="margin-top:.25rem">
          Consejo: empieza por el <button id="btnPrimerDia" type="button">primer d√≠a del mes</button>.
        </div>
      </div>
      <div>
        <label for="rTipo">Producto</label>
        <select id="rTipo">
          <option value="diario">Diario</option>
          <option value="cuponazo">Cuponazo</option>
          <option value="sueldazo">Sueldazo</option>
          <option value="rasca">Rasca</option>
          <option value="triplex">Triplex</option>
          <option value="superonce">Super Once</option>
          <option value="midia">Mi D√≠a</option>
          <option value="eurojackpot">Eurojackpot</option>
          <option value="extraordinario">Extraordinario</option>
          <option value="resto">Otros</option>
        </select>
      </div>
      <div>
        <label for="rUnidades">Unidades</label>
        <input id="rUnidades" type="number" min="0" value="0" />
      </div>
      <div>
        <label for="rPrecio">Precio (‚Ç¨)</label>
        <input id="rPrecio" type="number" step="0.01" min="0" value="2" />
      </div>
      <div class="actions" style="align-items:end">
        <button class="primary" id="btnAdd">‚ûï A√±adir venta</button>
        <button class="danger" id="btnClearMes">üóëÔ∏è Borrar mes visible</button>
      </div>
    </div>

    <div id="tablaWrap">
      <table id="tabla">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Producto</th>
            <th class="num">Unid.</th>
            <th class="num">Precio</th>
            <th class="num">Importe</th>
            <th></th>
          </tr>
        </thead>
        <tbody><!-- din√°mico --></tbody>
      </table>
    </div>
  </section>

  <!-- PROGRESO DEL MES -->
  <section class="card">
    <h2 class="section-title">üìä Progreso del mes</h2>
    <div id="progresoResumen" class="grid cols-3">
      <!-- KPIs inyectados -->
    </div>
    <div class="progress" style="margin-top:.5rem" aria-label="Progreso hacia el umbral" aria-live="polite">
      <span id="bar"></span>
    </div>
    <div id="faltasWrap" class="grid cols-2" style="margin-top:.5rem"><!-- faltas --></div>
  </section>

</main>

<script>
  // ======= Config =======
  const precios = {
    diario:2, cuponazo:3, sueldazo:2,
    rasca:1, triplex:0.5, superonce:1, midia:1, eurojackpot:2,
    extraordinario:2.5, resto:1.5
  };
  // % comisi√≥n al superar UM UMBRAL (total mensual)
  const pct = {
    diario:0.077, cuponazo:0.077, sueldazo:0.077,
    rasca:0.065, triplex:0.05, superonce:0.05, midia:0.05, eurojackpot:0.05,
    extraordinario:0.10, resto:0.04
  };
  const LS_KEY="calcOnce.v2.logs"; // [{id, fecha:'YYYY-MM-DD', tipo, unidades, precio}]

  // ======= Helpers =======
  const $ = s => document.querySelector(s);
  const fmt2 = n => (isNaN(n)? "-": n.toLocaleString("es-ES",{minimumFractionDigits:2, maximumFractionDigits:2}));
  const todayStr = () => {
    const d=new Date(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
    return `${d.getFullYear()}-${m}-${da}`;
  };
  const monthStr = (d=new Date()) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
  const parseMonth = (ym) => { const [y,m]=ym.split("-").map(Number); return {y, m}; };
  const sameMonth = (fecha, ym) => {
    const d = new Date(fecha);
    const {y,m} = parseMonth(ym);
    return d.getFullYear()===y && (d.getMonth()+1)===m;
  };
  function loadLogs(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch{ return []; } }
  function saveLogs(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }

  // ======= Tema =======
  const applyTheme = t => document.documentElement.setAttribute("data-theme", t);
  const loadTheme = () => localStorage.getItem("tema") || (matchMedia("(prefers-color-scheme: dark)").matches? "dark":"light");
  const saveTheme = t => localStorage.setItem("tema", t);

  // ======= Umbrales en vivo =======
  function renderUmbrales(){
    const j = jornadasObj();
    const minimo = 142 * j;
    const umbral = 210 * j;
    $("#umbralesChips").innerHTML = `
      <span class="pill warn">M√≠nimo: <b class="mono">${fmt2(minimo)} ‚Ç¨</b></span>
      <span class="pill ok">Umbral: <b class="mono">${fmt2(umbral)} ‚Ç¨</b></span>
    `;
  }
  const jornadasObj = () => Math.max(1, Math.min(26, parseInt($("#jornadasObj").value||"0")));

  // ======= Calculadora r√°pida =======
  function autocompletarPrecio(){ const t=$("#tipo").value; if (precios[t]!=null) $("#precio").value=precios[t]; }
  function calcularRapido(){
    const tipo = $("#tipo").value;
    const vendidos = Math.max(0, parseInt($("#vendidos").value||"0"));
    const precio  = Math.max(0, parseFloat($("#precio").value||"0"));
    const j       = jornadasObj();

    const total = vendidos * precio;
    const minimo = 142 * j;
    const umbral = 210 * j;
    const p = pct[tipo] ?? 0;
    const comision = total >= umbral ? total * p : 0;

    let tramo = `<span class="pill bad">Tramo: Bajo (por debajo del m√≠nimo)</span>`;
    if (total >= umbral) tramo = `<span class="pill ok">Tramo: Comisi√≥n (umbral superado)</span>`;
    else if (total >= minimo) tramo = `<span class="pill warn">Tramo: Intermedio (sin comisi√≥n)</span>`;

    $("#out").innerHTML = `
      <div class="kpi">üßæ <b>${vendidos}</b> √ó <b>${fmt2(precio)} ‚Ç¨</b> = <b class="mono">${fmt2(total)} ‚Ç¨</b></div>
      <div class="kpi">üìÖ Jornadas: <b>${j}</b> ¬∑ M√≠nimo: <b class="mono">${fmt2(minimo)} ‚Ç¨</b> ¬∑ Umbral: <b class="mono">${fmt2(umbral)} ‚Ç¨</b></div>
      <div class="kpi">üìà % Comisi√≥n: <b>${(p*100).toFixed(1)}%</b> ¬∑ üí∞ Comisi√≥n estimada: <b class="mono">${fmt2(comision)} ‚Ç¨</b></div>
      <div style="margin-top:.5rem">${tramo}</div>
    `;
  }
  function resetRapido(){
    $("#vendidos").value=0; autocompletarPrecio();
    $("#out").innerHTML = `<div class="muted">Introduce datos y pulsa ‚ÄúCalcular‚Äù.</div>`;
  }

  // ======= Registro Diario =======
  function autPrecioRegistro(){ const t=$("#rTipo").value; if (precios[t]!=null) $("#rPrecio").value=precios[t]; }
  function primerDiaMesActual(){
    const ym = $("#mesFiltro").value || monthStr();
    const {y,m}=parseMonth(ym);
    return `${y}-${String(m).padStart(2,"0")}-01`;
  }
  function setPrimerDia(){ $("#rFecha").value = primerDiaMesActual(); }

  function addVenta(){
    const fecha = $("#rFecha").value || todayStr();
    const tipo = $("#rTipo").value;
    const unidades = Math.max(0, parseInt($("#rUnidades").value||"0"));
    const precio = Math.max(0, parseFloat($("#rPrecio").value||"0"));
    if (!fecha) return alert("Selecciona una fecha.");
    if (unidades<=0) return alert("Introduce unidades > 0.");

    const logs = loadLogs();
    logs.push({ id: crypto.randomUUID?.() || String(Date.now()), fecha, tipo, unidades, precio });
    saveLogs(logs);

    $("#rUnidades").value = 0;
    renderTabla();
    renderProgreso();
  }
  function delVenta(id){
    saveLogs(loadLogs().filter(x=>x.id!==id));
    renderTabla();
    renderProgreso();
  }
  function clearMes(){
    const ym = $("#mesFiltro").value || monthStr();
    const rest = loadLogs().filter(x => !sameMonth(x.fecha, ym));
    if (rest.length === loadLogs().length) return alert("No hay registros en ese mes.");
    if (!confirm("¬øEliminar todas las ventas del mes visible?")) return;
    saveLogs(rest);
    renderTabla();
    renderProgreso();
  }
  function filasMes(){
    const ym = $("#mesFiltro").value || monthStr();
    return loadLogs().filter(x => sameMonth(x.fecha, ym)).sort((a,b)=> a.fecha.localeCompare(b.fecha));
  }
  function renderTabla(){
    const tb = $("#tabla tbody");
    const rows = filasMes();
    tb.innerHTML="";
    if (!rows.length){ tb.innerHTML = `<tr><td colspan="6" class="muted">Sin ventas en este mes.</td></tr>`; return; }
    for (const r of rows){
      const imp = r.unidades*r.precio;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.fecha}</td>
        <td>${tituloProducto(r.tipo)}</td>
        <td class="num">${r.unidades}</td>
        <td class="num">${fmt2(r.precio)} ‚Ç¨</td>
        <td class="num mono">${fmt2(imp)} ‚Ç¨</td>
        <td><button class="danger small" data-id="${r.id}">Eliminar</button></td>
      `;
      tr.querySelector("button").addEventListener("click", ()=> delVenta(r.id));
      tb.appendChild(tr);
    }
  }
  function tituloProducto(t){
    const map={diario:"Diario", cuponazo:"Cuponazo", sueldazo:"Sueldazo", rasca:"Rasca", triplex:"Triplex", superonce:"Super Once", midia:"Mi D√≠a", eurojackpot:"Eurojackpot", extraordinario:"Extraordinario", resto:"Otros"};
    return map[t]||t;
  }

  // ======= Progreso / Tramos =======
  function resumenMes(){
    const rows = filasMes();
    const porProd = {};
    let total=0;
    const dias = new Set();
    for (const r of rows){
      const imp = r.unidades*r.precio;
      total+=imp;
      dias.add(r.fecha);
      if (!porProd[r.tipo]) porProd[r.tipo]={importe:0};
      porProd[r.tipo].importe += imp;
    }
    const jornadasReg = dias.size;
    const j = jornadasObj();
    const minimo = 142*j;
    const umbral = 210*j;

    let comision = 0;
    if (total >= umbral){
      for (const t in porProd){
        comision += (porProd[t].importe) * (pct[t]??0);
      }
    }
    return { total, jornadasReg, j, minimo, umbral, comision };
  }
  function renderProgreso(){
    const { total, jornadasReg, j, minimo, umbral, comision } = resumenMes();

    // KPIs
    const tramo = total>=umbral ? "Comisi√≥n"
                : total>=minimo ? "Intermedio"
                : "Bajo";
    const pillClass = total>=umbral ? "ok" : total>=minimo ? "warn" : "bad";

    $("#progresoResumen").innerHTML = `
      <div>
        <div class="kpi">üßæ Total mes</div>
        <div class="kpi mono"><b>${fmt2(total)} ‚Ç¨</b></div>
      </div>
      <div>
        <div class="kpi">üóìÔ∏è Jornadas</div>
        <div class="kpi"><b>${jornadasReg}</b> registradas / <b>${j}</b> objetivo</div>
      </div>
      <div>
        <div class="kpi">üí∞ Comisi√≥n</div>
        <div class="kpi mono"><b>${fmt2(comision)} ‚Ç¨</b></div>
      </div>
      <div class="chips" style="grid-column:1/-1;margin-top:.5rem">
        <span class="pill ${pillClass}">Tramo actual: <b>${tramo}</b></span>
        <span class="pill warn">M√≠nimo: <b class="mono">${fmt2(minimo)} ‚Ç¨</b></span>
        <span class="pill ok">Umbral: <b class="mono">${fmt2(umbral)} ‚Ç¨</b></span>
      </div>
    `;

    // Barra de progreso hacia UMBRAL
    const pctBar = umbral>0 ? Math.min(100, (total/umbral)*100) : 0;
    $("#bar").style.width = pctBar + "%";

    // Faltas y proyecci√≥n
    const faltaMin = Math.max(0, minimo - total);
    const faltaUmb = Math.max(0, umbral - total);
    const jornadasRest = Math.max(0, j - jornadasReg);
    const porJornadaMin = jornadasRest>0 ? faltaMin / jornadasRest : 0;
    const porJornadaUmb = jornadasRest>0 ? faltaUmb / jornadasRest : 0;

    $("#faltasWrap").innerHTML = `
      <div class="card">
        <div class="kpi">‚è≥ Falta para <b>m√≠nimo</b>:</div>
        <div class="kpi mono"><b>${fmt2(faltaMin)} ‚Ç¨</b></div>
        <div class="small muted">Necesario por jornada restante: <b>${fmt2(porJornadaMin)} ‚Ç¨</b></div>
      </div>
      <div class="card">
        <div class="kpi">üèÅ Falta para <b>umbral</b>:</div>
        <div class="kpi mono"><b>${fmt2(faltaUmb)} ‚Ç¨</b></div>
        <div class="small muted">Necesario por jornada restante: <b>${fmt2(porJornadaUmb)} ‚Ç¨</b></div>
      </div>
    `;
  }

  // ======= Eventos / Inicio =======
  // Tema
  const temaInicial=loadTheme(); applyTheme(temaInicial);
  $("#btnTema").addEventListener("click", ()=>{ const nuevo=(document.documentElement.getAttribute("data-theme")==="dark")?"light":"dark"; applyTheme(nuevo); saveTheme(nuevo); });

  // Jornadas/Umbral en vivo
  $("#jornadasObj").addEventListener("input", ()=>{ renderUmbrales(); renderProgreso(); });

  // Mes y fecha
  $("#mesFiltro").addEventListener("change", ()=>{ renderUmbrales(); renderTabla(); renderProgreso(); });
  $("#btnPrimerDia").addEventListener("click", setPrimerDia);

  // Calculadora r√°pida
  $("#tipo").addEventListener("change", autocompletarPrecio);
  $("#btnCalc").addEventListener("click", calcularRapido);
  $("#btnReset").addEventListener("click", resetRapido);

  // Registro diario
  $("#rTipo").addEventListener("change", autPrecioRegistro);
  $("#btnAdd").addEventListener("click", addVenta);
  $("#btnClearMes").addEventListener("click", clearMes);

  // Inicio
  $("#mesFiltro").value = monthStr();
  $("#rFecha").value = todayStr();
  renderUmbrales();
  autocompletarPrecio();
  autPrecioRegistro();
  renderTabla();
  renderProgreso();

  // PWA (opcional; si no hay SW, no pasa nada)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    });
  }
</script>
</body>
</html>
