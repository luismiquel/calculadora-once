<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora de Comisiones ONCE 2025</title>
  <meta name="theme-color" content="#d62828">
  <link rel="manifest" href="manifest.json">

  <style>
    :root { --bg:#ffffff; --fg:#111; --primary:#d62828; --secondary:#fcbf49; --accent:#003049; --card:#fff7e6; }
    [data-theme="dark"] { --bg:#1e1e1e; --fg:#f5f5f5; --primary:#ff595e; --secondary:#ffca3a; --accent:#8ac926; --card:#2a2a2a; }
    *{box-sizing:border-box}
    body{margin:0;padding:16px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
    h1{margin:0 0 12px;color:var(--primary);font-size:1.5rem}
    .wrap{max-width:780px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:12px 14px;margin:10px 0}
    label{display:block;margin:10px 0 4px}
    select,input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #ccc;background:#fff;font-size:16px}
    [data-theme="dark"] select,[data-theme="dark"] input{background:#141414;border:1px solid #444;color:var(--fg)}
    button{cursor:pointer;background:var(--accent);color:#fff;border:none;font-weight:600}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .resultado{white-space:pre-line}
    .alerta{padding:8px;border-radius:8px;margin-top:8px;font-weight:600}
    .verde{background:#d4edda;color:#155724}
    .naranja{background:#fff3cd;color:#856404}
    .rojo{background:#f8d7da;color:#721c24}
    .muted{opacity:.8;font-size:.95rem}
    .topbar{display:flex;gap:8px;margin-bottom:8px}
    .topbar button{width:auto;padding:8px 12px}
    .nota{font-size:.9rem;opacity:.9}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1 style="flex:1">Calculadora de Comisiones ONCE 2025</h1>
      <button id="btnTema" type="button">🌗 Tema</button>
    </div>

    <div class="card">
      <label>Tipo de producto</label>
      <select id="tipo">
        <option value="diario">Diario (2€)</option>
        <option value="cuponazo">Cuponazo (3€)</option>
        <option value="sueldazo">Sueldazo (2€)</option>
        <option value="rasca1">Rasca 1€</option>
        <option value="rasca2">Rasca 2€</option>
        <option value="rasca3">Rasca 3€</option>
        <option value="rasca5">Rasca 5€</option>
        <option value="rasca10">Rasca 10€</option>
        <option value="triplex">Triplex (0,50€)</option>
        <option value="superonce">Super Once (1€)</option>
        <option value="midia">Mi Día (1€)</option>
        <option value="eurojackpot">Eurojackpot (2€)</option>
        <option value="extraordinario">Extraordinario</option>
      </select>

      <div class="row">
        <div>
          <label>Días trabajados (1–25)</label>
          <input id="dias" type="number" min="1" max="25" value="20" />
        </div>
        <div>
          <label>Unidades vendidas</label>
          <input id="vendidos" type="number" min="0" value="0" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Precio unitario (€)</label>
          <input id="precio" type="number" min="0" step="0.01" value="2" />
        </div>
        <div>
          <label style="visibility:hidden">.</label>
          <button id="btnCalcular" type="button">🔢 Calcular</button>
        </div>
      </div>

      <div class="nota muted">
        Nota: Para **Extraordinarios** se aplican tramos por número de cupones (12%–17%). Para el resto se usa el
        esquema oficial por **Mínimo / Umbral y 8 tramos**; los importes de tramo escalan por jornadas.
      </div>
    </div>

    <div class="card">
      <div id="resultado" class="resultado"></div>
    </div>

    <div class="card muted">
      <strong>Ayuda rápida</strong><br>
      • Mínimo por jornada: 142 € &nbsp;|&nbsp; Umbral por jornada: 210 €<br>
      • Tramos (por jornada) tras el Umbral: 289, 344, 400, 455, 510, 566, 677 €<br>
      • Porcentajes por familia:<br>
      &nbsp;&nbsp;— Muy alto: 1.5, 4, 7, 8.5, 9, 9.5, 10, 10.5 %<br>
      &nbsp;&nbsp;— Alto: 2, 5, 8.5, 11.5, 12, 12.5, 13, 14 %<br>
      &nbsp;&nbsp;— Resto: 2.5, 6, 10, 13, 14, 15, 16, 17.5 %
    </div>
  </div>

  <script>
    // ---------- Tema ----------
    const root = document.documentElement;
    const btnTema = document.getElementById('btnTema');
    btnTema.onclick = () => {
      root.setAttribute('data-theme', root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
      localStorage.setItem('calc-once-theme', root.getAttribute('data-theme'));
    };
    (function initTheme(){
      const saved = localStorage.getItem('calc-once-theme');
      if(saved) root.setAttribute('data-theme', saved);
    })();

    // ---------- Datos base ----------
    const preciosPorDefecto = {
      diario:2, cuponazo:3, sueldazo:2,
      rasca1:1, rasca2:2, rasca3:3, rasca5:5, rasca10:10,
      triplex:0.5, superonce:1, midia:1, eurojackpot:2,
      extraordinario:2.5 // precio orientativo; ajustable
    };

    // Familias para tramos
    const FAMILIA = {
      MUY_ALTO: 'MUY_ALTO',
      ALTO: 'ALTO',
      RESTO: 'RESTO',
      EXTRA: 'EXTRA'
    };

    // Mapeo producto -> familia
    const familiaPorProducto = {
      diario: FAMILIA.RESTO,
      cuponazo: FAMILIA.ALTO,       // puedes ajustar si tu centro los clasifica distinto
      sueldazo: FAMILIA.ALTO,
      rasca1: FAMILIA.RESTO,
      rasca2: FAMILIA.RESTO,
      rasca3: FAMILIA.RESTO,
      rasca5: FAMILIA.RESTO,
      rasca10: FAMILIA.RESTO,
      triplex: FAMILIA.MUY_ALTO,
      superonce: FAMILIA.MUY_ALTO,
      midia: FAMILIA.MUY_ALTO,
      eurojackpot: FAMILIA.MUY_ALTO,
      extraordinario: FAMILIA.EXTRA
    };

    // Tramos por familia (8 bandas tras Umbral)
    const PORC = {
      [FAMILIA.MUY_ALTO]: [1.5, 4.0, 7.0, 8.5, 9.0, 9.5, 10.0, 10.5],
      [FAMILIA.ALTO]:     [2.0, 5.0, 8.5, 11.5, 12.0, 12.5, 13.0, 14.0],
      [FAMILIA.RESTO]:    [2.5, 6.0, 10.0, 13.0, 14.0, 15.0, 16.0, 17.5]
    };

    // Importes por jornada (base 1 jornada). Escalan * días.
    const BASE = {
      MINIMO: 142,
      UMBRAL: 210,
      TRAMOS: [289, 344, 400, 455, 510, 566, 677] // 7 adicionales tras umbral (total 8 bandas contando el umbral como 1ª barrera)
    };

    // Tramos Extraordinarios (por número de cupones)
    function porcentajeExtra(cant) {
      if (cant >= 600) return 17;
      if (cant >= 500) return 16;
      if (cant >= 400) return 15;
      if (cant >= 300) return 14;
      if (cant >= 200) return 13;
      if (cant >=   1) return 12;
      return 0;
    }

    // ---------- UI ----------
    const selTipo = document.getElementById('tipo');
    const inDias = document.getElementById('dias');
    const inVendidos = document.getElementById('vendidos');
    const inPrecio = document.getElementById('precio');
    const btnCalcular = document.getElementById('btnCalcular');
    const divRes = document.getElementById('resultado');

    // autocompletar precio al cambiar tipo
    selTipo.addEventListener('change', () => {
      const t = selTipo.value;
      inPrecio.value = preciosPorDefecto[t] ?? 0;
    });

    btnCalcular.addEventListener('click', calcular);

    function calcular(){
      const tipo = selTipo.value;
      const dias = Math.max(1, Math.min(25, parseInt(inDias.value || '0', 10)));
      const vendidos = Math.max(0, parseInt(inVendidos.value || '0', 10));
      const precio = Math.max(0, parseFloat(inPrecio.value || '0'));

      // Total vendido €
      const total = vendidos * precio;

      // Extraordinarios: tramos por cantidad de cupones
      if (familiaPorProducto[tipo] === FAMILIA.EXTRA) {
        const p = porcentajeExtra(vendidos);
        const comision = total * (p/100);
        divRes.innerHTML =
          `🎯 Extraordinario\n`+
          `🔢 Vendidos: ${vendidos} × ${precio.toFixed(2)} € = ${total.toFixed(2)} €\n`+
          `📈 Tramo aplicado: ${p}%\n`+
          `💰 Comisión estimada: ${comision.toFixed(2)} €`;
        return;
      }

      // Resto de productos: mínimo/umbral y 8 bandas
      const minimo = BASE.MINIMO * dias;
      const umbral = BASE.UMBRAL * dias;
      const escalones = [umbral, ...BASE.TRAMOS.map(v=>v * dias)]; // 8 valores

      let idx = -1; // -1 => por debajo de umbral
      for (let i = 0; i < escalones.length; i++) {
        if (total >= escalones[i]) idx = i; else break;
      }

      const familia = familiaPorProducto[tipo];
      const tablaPorc = PORC[familia];

      let pct = 0;
      if (idx >= 0) pct = tablaPorc[Math.min(idx, tablaPorc.length-1)];

      const comision = total * (pct/100);

      const alertaClass = total >= umbral ? 'verde' : (total >= minimo ? 'naranja' : 'rojo');
      const alertaTxt = total >= umbral
        ? '✅ Umbral superado: aplican tramos de comisión'
        : (total >= minimo ? '⚠️ Mínimo superado: sin comisión aún' : '❌ No alcanzas el mínimo');

      const infoTramo = idx >= 0
        ? `📊 Banda: ${idx+1} de 8 → ${pct}%`
        : `📊 Banda: 0 de 8 (sin comisión)`;

      divRes.innerHTML =
        `🧾 ${nombreProducto(tipo)} (${familia.replace('_',' ')})\n`+
        `🔢 Vendidos: ${vendidos} × ${precio.toFixed(2)} € = ${total.toFixed(2)} €\n`+
        `📅 Días: ${dias} → Mínimo: ${eu(minimo)} | Umbral: ${eu(umbral)}\n`+
        `${infoTramo}\n`+
        `💰 Comisión estimada: ${eu(comision)}\n`+
        `<div class="alerta ${alertaClass}">${alertaTxt}</div>`;
    }

    function nombreProducto(t){
      const map = {
        diario:'Diario', cuponazo:'Cuponazo', sueldazo:'Sueldazo',
        rasca1:'Rasca 1€', rasca2:'Rasca 2€', rasca3:'Rasca 3€', rasca5:'Rasca 5€', rasca10:'Rasca 10€',
        triplex:'Triplex', superonce:'Super Once', midia:'Mi Día', eurojackpot:'Eurojackpot',
        extraordinario:'Extraordinario'
      };
      return map[t] || t;
    }
    const eu = n => n.toLocaleString('es-ES',{style:'currency',currency:'EUR'});

    // ---------- PWA: registro SW (sin iconos) ----------
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(r => console.log('SW registrado', r.scope))
          .catch(err => console.log('SW no registrado', err));
      });
    }
  </script>
</body>
</html>
