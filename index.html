<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calculadora de Comisiones ONCE 2025</title>
  <meta name="theme-color" content="#202124" />
  <!-- PWA: usar√° tu manifest.json existente -->
  <link rel="manifest" href="./manifest.json" />
  <style>
    :root{
      --bg:#ffffff; --fg:#111; --card:#f4f4f4; --primary:#0b8457; --danger:#c0392b; --muted:#6b7280; --accent:#2563eb;
      --table:#fafafa; --border:#e5e7eb;
    }
    [data-theme="dark"]{
      --bg:#121212; --fg:#f5f5f5; --card:#1d1f22; --primary:#2ecc71; --danger:#ff6b6b; --muted:#a1a1aa; --accent:#60a5fa;
      --table:#16181b; --border:#2a2d31;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    header{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:1rem;border-bottom:1px solid var(--border)}
    h1{font-size:1.1rem;margin:0}
    .wrap{max-width:920px;margin:0 auto;padding:1rem}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:.75rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1rem}
    label{font-size:.85rem;color:var(--muted)}
    input,select,button{width:100%;padding:.7rem;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--fg)}
    button{cursor:pointer;border:0}
    .btn{background:var(--accent);color:#fff}
    .btn-sec{background:transparent;color:var(--fg);border:1px solid var(--border)}
    .btn-danger{background:var(--danger);color:#fff}
    table{width:100%;border-collapse:collapse;background:var(--table);border:1px solid var(--border);border-radius:10px;overflow:hidden}
    th,td{padding:.6rem;border-bottom:1px solid var(--border);text-align:left;font-size:.92rem}
    th{background:var(--card);color:var(--muted);font-weight:600}
    tfoot td{font-weight:700}
    .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid var(--border);padding:.25rem .5rem;border-radius:999px;font-size:.8rem}
    .ok{color:#0ea5e9}
    .warn{color:#f59e0b}
    .good{color:#10b981}
    .bad{color:#ef4444}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
    .row>*{flex:1}
    .r{text-align:right}
    .muted{color:var(--muted)}
    .hide{display:none}
    @media (max-width:720px){
      .grid{grid-template-columns:1fr}
      header{flex-wrap:wrap;gap:.75rem}
    }
  </style>
</head>
<body>
<header>
  <h1>Calculadora de Comisiones ONCE 2025</h1>
  <div class="row" style="max-width:420px">
    <button id="darkBtn" class="btn-sec" type="button">üåó Modo oscuro</button>
    <button id="installBtn" class="btn" type="button" title="Instalar (PWA)">‚¨áÔ∏è Instalar</button>
  </div>
</header>

<div class="wrap">

  <!-- Filtros Mes/A√±o -->
  <div class="card">
    <div class="grid">
      <div class="col" style="grid-column:span 6">
        <label>Mes</label>
        <select id="mesSel"></select>
      </div>
      <div class="col" style="grid-column:span 6">
        <label>A√±o</label>
        <select id="anioSel"></select>
      </div>
    </div>
  </div>

  <!-- Alta de venta diaria -->
  <div class="card">
    <h2 style="margin-top:0;font-size:1rem">A√±adir venta diaria</h2>
    <div class="grid">
      <div class="col" style="grid-column:span 4">
        <label>Fecha</label>
        <input id="fecha" type="date" />
      </div>
      <div class="col" style="grid-column:span 4">
        <label>Producto</label>
        <select id="producto">
          <optgroup label="Sorteos diarios">
            <option value="diario">Diario (2‚Ç¨)</option>
            <option value="cuponazo">Cuponazo (3‚Ç¨)</option>
            <option value="sueldazo">Sueldazo (2‚Ç¨)</option>
          </optgroup>
          <optgroup label="Rascas">
            <option value="rasca">Rasca (1‚Äì10‚Ç¨)</option>
          </optgroup>
          <optgroup label="Activos">
            <option value="triplex">Triplex (0.5‚Ç¨)</option>
            <option value="superonce">Super Once (1‚Ç¨)</option>
            <option value="midia">Mi D√≠a (1‚Ç¨)</option>
            <option value="eurojackpot">Eurojackpot (2‚Ç¨)</option>
          </optgroup>
          <optgroup label="Especiales">
            <option value="extra">Extraordinario (tramos)</option>
            <option value="otros">Otros</option>
          </optgroup>
        </select>
      </div>
      <div class="col" style="grid-column:span 4">
        <label>Unidades vendidas</label>
        <input id="unidades" type="number" min="0" step="1" value="0"/>
      </div>

      <div class="col" style="grid-column:span 4">
        <label>Precio (‚Ç¨)</label>
        <input id="precio" type="number" min="0" step="0.1" value="2"/>
      </div>
      <div class="col" style="grid-column:span 8">
        <label>Nota (opcional)</label>
        <input id="nota" type="text" placeholder="ej: lunes ma√±ana, zona centro‚Ä¶"/>
      </div>
    </div>

    <div class="row" style="margin-top:.75rem">
      <button id="addBtn" class="btn" type="button">‚ûï A√±adir</button>
      <button id="csvBtn" class="btn-sec" type="button">‚¨áÔ∏è Exportar CSV</button>
      <button id="limpiarBtn" class="btn-danger" type="button" title="Borra s√≥lo el mes seleccionado">üóëÔ∏è Borrar mes</button>
    </div>
  </div>

  <!-- Tabla de ventas -->
  <div class="card">
    <h2 style="margin-top:0;font-size:1rem">Ventas del mes</h2>
    <div class="muted" id="infoDias"></div>
    <div style="overflow:auto">
      <table id="tabla">
        <thead>
          <tr>
            <th>Fecha</th><th>Producto</th><th class="r">Unid.</th><th class="r">Precio</th><th class="r">Importe</th><th>Nota</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td colspan="4" class="r">Total mes (‚Ç¨)</td><td class="r" id="totalMes">0,00</td><td colspan="2"></td></tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Resumen y comisi√≥n -->
  <div class="card">
    <h2 style="margin-top:0;font-size:1rem">Resumen y comisi√≥n</h2>
    <div class="grid">
      <div class="col" style="grid-column:span 12">
        <div class="row">
          <span class="pill">D√≠as trabajados: <strong id="diasTrab">0</strong></span>
          <span class="pill">M√≠nimo: <strong id="minimo">0,00 ‚Ç¨</strong></span>
          <span class="pill">Umbral: <strong id="umbral">0,00 ‚Ç¨</strong></span>
          <span class="pill">Estado: <strong id="estado" class="warn">Sin comisi√≥n</strong></span>
        </div>
      </div>

      <div class="col" style="grid-column:span 12;margin-top:.5rem">
        <div id="resumenProductos" class="muted"></div>
      </div>

      <div class="col" style="grid-column:span 12;margin-top:.5rem">
        <div class="row">
          <div class="card" style="flex:1">
            <div class="muted">Comisi√≥n productos est√°ndar*</div>
            <div style="font-size:1.4rem"><strong id="comisionStd">0,00 ‚Ç¨</strong></div>
            <div class="muted" style="font-size:.8rem">*Diario, Cuponazo, Sueldazo, Rascas y Activos. S√≥lo si superas <b>Umbral</b>.</div>
          </div>
          <div class="card" style="flex:1">
            <div class="muted">Comisi√≥n Extraordinarios (tramos)</div>
            <div style="font-size:1.4rem"><strong id="comisionExtra">0,00 ‚Ç¨</strong></div>
            <div class="muted" style="font-size:.8rem">12% [1‚Äì199], 13% [200‚Äì299], 14% [300‚Äì399], 15% [400‚Äì499], 16% [500‚Äì599], 17% [‚â•600].</div>
          </div>
          <div class="card" style="flex:1">
            <div class="muted">Comisi√≥n total estimada</div>
            <div style="font-size:1.6rem;color:var(--primary)"><strong id="comisionTotal">0,00 ‚Ç¨</strong></div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ====== Config b√°sica ====== */
const PRODUCTOS = {
  diario:      {nombre:"Diario",      precio:2,   tipo:"std", pct:0.077},
  cuponazo:    {nombre:"Cuponazo",    precio:3,   tipo:"std", pct:0.077},
  sueldazo:    {nombre:"Sueldazo",    precio:2,   tipo:"std", pct:0.077},
  rasca:       {nombre:"Rasca",       precio:1,   tipo:"std", pct:0.065}, // puedes cambiar precio al cargar
  triplex:     {nombre:"Triplex",     precio:0.5, tipo:"std", pct:0.05},
  superonce:   {nombre:"Super Once",  precio:1,   tipo:"std", pct:0.05},
  midia:       {nombre:"Mi D√≠a",      precio:1,   tipo:"std", pct:0.05},
  eurojackpot: {nombre:"Eurojackpot", precio:2,   tipo:"std", pct:0.05},
  extra:       {nombre:"Extraordinario", precio:2.5, tipo:"extra"}, // precio libre por sorteo
  otros:       {nombre:"Otros", precio:1.5, tipo:"std", pct:0.04}
};

// Tabla oficial M√≠nimo/Umbral 2025 (1‚Äì25 jornadas)
const TABLA_MU = {
  1:{min:142, umbral:210},
  2:{min:284, umbral:420},
  3:{min:426, umbral:630},
  4:{min:568, umbral:840},
  5:{min:710, umbral:1050},
  6:{min:852, umbral:1260},
  7:{min:994, umbral:1470},
  8:{min:1136, umbral:1680},
  9:{min:1278, umbral:1890},
 10:{min:1420, umbral:2100},
 11:{min:1562, umbral:2310},
 12:{min:1704, umbral:2520},
 13:{min:1846, umbral:2730},
 14:{min:1988, umbral:2940},
 15:{min:2130, umbral:3150},
 16:{min:2272, umbral:3360},
 17:{min:2414, umbral:3570},
 18:{min:2556, umbral:3780},
 19:{min:2698, umbral:3990},
 20:{min:2840, umbral:4200},
 21:{min:2982, umbral:4410},
 22:{min:3124, umbral:4620},
 23:{min:3266, umbral:4830},
 24:{min:3408, umbral:5040},
 25:{min:3550, umbral:5250}
};

// Tramos extraordinario (por N¬∫ cupones Extra)
function pctExtraord(unidades){
  if (unidades>=600) return 0.17;
  if (unidades>=500) return 0.16;
  if (unidades>=400) return 0.15;
  if (unidades>=300) return 0.14;
  if (unidades>=200) return 0.13;
  if (unidades>=1)   return 0.12;
  return 0;
}

/* ====== Estado & utilidades ====== */
const $ = sel => document.querySelector(sel);
const storageKey = "once-ventas-2025";
const hoy = new Date();

function fmt(n){ return n.toLocaleString('es-ES',{minimumFractionDigits:2, maximumFractionDigits:2}); }
function yyyymm(d){ return d.toISOString().slice(0,7); }
function parseDateInput(v){ return v ? new Date(v+"T00:00:00") : new Date(); }

// Carga/guarda almacenamiento
function loadAll(){ try{ return JSON.parse(localStorage.getItem(storageKey) || "{}"); }catch{ return {}; } }
function saveAll(data){ localStorage.setItem(storageKey, JSON.stringify(data)); }

// Obtiene array ventas para (yyyy-mm)
function getMes(ym){
  const all = loadAll();
  return Array.isArray(all[ym]) ? all[ym] : [];
}
function setMes(ym, arr){
  const all = loadAll();
  all[ym] = arr;
  saveAll(all);
}

// Mes/a√±o selects
function rellenarMesAnio(){
  const mesSel = $("#mesSel"), anioSel=$("#anioSel");
  const meses = ["01","02","03","04","05","06","07","08","09","10","11","12"];
  mesSel.innerHTML = meses.map(m=>`<option value="${m}">${m}</option>`).join("");
  const y = hoy.getFullYear();
  const ys = [y-1, y, y+1];
  anioSel.innerHTML = ys.map(a=>`<option value="${a}">${a}</option>`).join("");
  mesSel.value = hoy.toISOString().slice(5,7);
  anioSel.value = String(y);
}

function ymActual(){ return `${$("#anioSel").value}-${$("#mesSel").value}`; }

/* ====== UI l√≥gica principal ====== */
function autocompletarPrecio(){
  const prod = $("#producto").value;
  const p = PRODUCTOS[prod];
  $("#precio").value = p ? p.precio : 1;
}

function addVenta(){
  const fecha = $("#fecha").value;
  const producto = $("#producto").value;
  const unidades = parseInt($("#unidades").value || "0", 10);
  const precio = parseFloat($("#precio").value || "0");
  const nota = $("#nota").value.trim();

  if(!fecha) return alert("Selecciona una fecha.");
  if(unidades<=0) return alert("Indica unidades vendidas (>0).");
  if(precio<=0) return alert("El precio debe ser mayor que 0.");

  const ym = ymActual();
  const ventas = getMes(ym);
  ventas.push({fecha, producto, unidades, precio, nota});
  // ordenar por fecha asc
  ventas.sort((a,b)=> a.fecha.localeCompare(b.fecha));
  setMes(ym, ventas);

  // limpiar inputs (menos producto)
  $("#unidades").value = 0;
  $("#nota").value = "";
  render();
}

function delVenta(idx){
  const ym = ymActual();
  const ventas = getMes(ym);
  ventas.splice(idx,1);
  setMes(ym, ventas);
  render();
}

function exportCSV(){
  const ym = ymActual();
  const ventas = getMes(ym);
  if(!ventas.length){ alert("No hay datos para exportar."); return; }
  const encabezado = ["fecha","producto","nombre","unidades","precio","importe","nota"];
  const filas = ventas.map(v=>{
    const def = PRODUCTOS[v.producto]||{nombre:v.producto};
    const imp = v.unidades * v.precio;
    return [v.fecha, v.producto, def.nombre||v.producto, v.unidades, v.precio.toFixed(2), imp.toFixed(2), (v.nota||"").replaceAll('"','""')];
  });
  const csv = [encabezado, ...filas].map(r=>r.map(x=>`"${x}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `ventas_${ym}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function limpiarMes(){
  if(!confirm("¬øSeguro que quieres borrar todas las ventas del mes seleccionado?")) return;
  const ym = ymActual();
  setMes(ym, []);
  render();
}

function render(){
  const ym = ymActual();
  const ventas = getMes(ym);
  // tabla
  const tbody = $("#tabla tbody");
  tbody.innerHTML = "";
  let totalMes = 0;

  ventas.forEach((v, i)=>{
    const importe = v.unidades * v.precio;
    totalMes += importe;
    const tr = document.createElement("tr");
    const nombre = (PRODUCTOS[v.producto]?.nombre)||v.producto;
    tr.innerHTML = `
      <td>${v.fecha}</td>
      <td>${nombre}</td>
      <td class="r">${v.unidades}</td>
      <td class="r">${fmt(v.precio)}</td>
      <td class="r">${fmt(importe)}</td>
      <td>${v.nota||""}</td>
      <td class="r"><button class="btn-danger" onclick="delVenta(${i})">Eliminar</button></td>
    `;
    tbody.appendChild(tr);
  });
  $("#totalMes").textContent = fmt(totalMes);

  // d√≠as trabajados (fechas √∫nicas con alguna venta)
  const dias = new Set(ventas.map(v=>v.fecha)).size;
  $("#diasTrab").textContent = dias;

  // m√≠nimo/umbral
  const mu = TABLA_MU[Math.min(dias,25)] || {min:0, umbral:0};
  $("#minimo").textContent = fmt(mu.min);
  $("#umbral").textContent = fmt(mu.umbral);

  // resumen por producto (importe y unidades)
  const porProducto = {};
  ventas.forEach(v=>{
    const key = v.producto;
    porProducto[key] ??= {unid:0, importe:0, precio:v.precio};
    porProducto[key].unid += v.unidades;
    porProducto[key].importe += v.unidades * v.precio;
  });
  const resDiv = $("#resumenProductos");
  resDiv.innerHTML = Object.entries(porProducto).map(([k,info])=>{
    const def = PRODUCTOS[k]||{nombre:k};
    return `<div>‚Ä¢ <b>${def.nombre||k}</b>: ${info.unid} unid ¬∑ ${fmt(info.importe)} ‚Ç¨</div>`;
  }).join("") || "<span class='muted'>Sin ventas registradas.</span>";

  // comisi√≥n est√°ndar (si totalMes >= umbral)
  let comStd = 0;
  if (totalMes >= (mu.umbral||Infinity)){
    for(const [k,info] of Object.entries(porProducto)){
      const def = PRODUCTOS[k];
      if(!def || def.tipo!=="std") continue;
      comStd += info.importe * (def.pct||0);
    }
    $("#estado").textContent = "Con comisi√≥n (superado Umbral)";
    $("#estado").className = "good";
  }else{
    $("#estado").textContent = totalMes >= (mu.min||Infinity) ? "M√≠nimo superado, sin comisi√≥n" : "Sin m√≠nimo";
    $("#estado").className = totalMes >= (mu.min||Infinity) ? "warn" : "bad";
  }
  $("#comisionStd").textContent = fmt(comStd);

  // comisi√≥n extraordinarios (tramos por n¬∫ cupones del propio extraordinario)
  const vExtra = porProducto["extra"];
  let comExtra = 0;
  if(vExtra){
    const pct = pctExtraord(vExtra.unid);
    comExtra = vExtra.importe * pct;
  }
  $("#comisionExtra").textContent = fmt(comExtra);

  // total
  $("#comisionTotal").textContent = fmt(comStd + comExtra);

  // info d√≠as
  $("#infoDias").innerHTML = `
    D√≠as con venta: <b>${dias}</b> ‚Ä¢ Total vendido: <b>${fmt(totalMes)} ‚Ç¨</b>
  `;
}

/* ====== Tema oscuro ====== */
function aplicarTema(base){
  const tema = base ?? localStorage.getItem("once-tema") ?? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
  document.documentElement.dataset.theme = tema;
  localStorage.setItem("once-tema", tema);
}
$("#darkBtn").addEventListener("click", ()=> aplicarTema(document.documentElement.dataset.theme==="dark"?"light":"dark"));

/* ====== PWA ====== */
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e)=>{
  deferredPrompt = e; // no preventDefault: dejamos que el navegador decida si mostrar banner
});
$("#installBtn").addEventListener("click", async ()=>{
  if(!deferredPrompt) { alert("Si tu navegador lo permite, podr√°s instalarla desde el men√∫ del navegador."); return; }
  deferredPrompt.prompt();
  deferredPrompt = null;
});
if ("serviceWorker" in navigator) {
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  });
}

/* ====== Eventos UI ====== */
$("#producto").addEventListener("change", autocompletarPrecio);
$("#addBtn").addEventListener("click", addVenta);
$("#csvBtn").addEventListener("click", exportCSV);
$("#limpiarBtn").addEventListener("click", limpiarMes);
$("#mesSel").addEventListener("change", render);
$("#anioSel").addEventListener("change", render);

/* ====== Init ====== */
(function init(){
  rellenarMesAnio();
  // fecha por defecto = hoy del mes/a√±o elegidos
  const ym = ymActual();
  const [yy,mm] = ym.split("-");
  const d = new Date(); d.setFullYear(+yy, +mm-1, Math.min(d.getDate(), 28));
  $("#fecha").value = d.toISOString().slice(0,10);
  autocompletarPrecio();
  aplicarTema();
  render();
})();
</script>
</body>
</html>
