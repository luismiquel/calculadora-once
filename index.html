<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora de Comisiones ONCE 2025</title>
<meta name="theme-color" content="#0f766e" />
<link rel="manifest" href="./manifest.json" />
<style>
  :root{
    --bg:#ffffff;--fg:#111827;--card:#f1f5f9;--muted:#6b7280;
    --primary:#0f766e;--primary-fg:#ffffff;--warn:#f59e0b;--danger:#dc2626;--ok:#16a34a;
    --ring:#0ea5e9;--border:#e5e7eb;
  }
  [data-theme="dark"]{
    --bg:#0b1220;--fg:#e5e7eb;--card:#0f172a;--muted:#9ca3af;
    --primary:#14b8a6;--primary-fg:#062925;--warn:#fbbf24;--danger:#ef4444;--ok:#22c55e;
    --ring:#38bdf8;--border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial}
  header{display:flex;gap:.75rem;align-items:center;justify-content:space-between;padding:1rem;position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);z-index:3}
  h1{font-size:1.15rem;margin:0;color:var(--primary)}
  .wrap{max-width:980px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:1rem}
  .row{display:grid;grid-template-columns:repeat(4,1fr);gap:.75rem}
  .row3{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem}
  .row2{display:grid;grid-template-columns:repeat(2,1fr);gap:.75rem}
  .row>*{min-width:0}
  label{display:flex;flex-direction:column;gap:.35rem;font-size:.92rem}
  input,select,button,textarea{
    font:inherit;padding:.65rem .7rem;border-radius:10px;border:1px solid var(--border);background:#fff;color:#111;
  }
  [data-theme="dark"] input,[data-theme="dark"] select,[data-theme="dark"] textarea{
    background:#0b1220;color:var(--fg);border-color:#1f2937;
  }
  button{cursor:pointer}
  .btn{background:var(--primary);color:white;border:none}
  .btn:active{transform:scale(.99)}
  .btn-secondary{background:transparent;border:1px solid var(--primary);color:var(--primary)}
  .pill{display:inline-block;padding:.25rem .55rem;border-radius:999px;font-size:.78rem;border:1px solid var(--border);color:var(--muted);background:#fff}
  [data-theme="dark"] .pill{background:#0b1220}
  table{width:100%;border-collapse:collapse;font-size:.92rem}
  th,td{padding:.55rem;border-bottom:1px solid var(--border);text-align:right}
  th:first-child,td:first-child{text-align:left}
  tfoot td{font-weight:600}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--danger)}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .progress{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,var(--primary),#22c55e)}
  .sticky-actions{display:flex;gap:.5rem;flex-wrap:wrap}
  .note{font-size:.85rem;color:var(--muted)}
  .badge{border-radius:8px;padding:.2rem .5rem}
  .badge.ok{background:rgba(22,163,74,.12)}
  .badge.warn{background:rgba(245,158,11,.12)}
  .badge.bad{background:rgba(220,38,38,.12)}
  @media (max-width:760px){
    .row{grid-template-columns:1fr 1fr}
    .row3{grid-template-columns:1fr}
    .row2{grid-template-columns:1fr}
    header{flex-wrap:wrap;gap:.5rem}
  }
</style>
</head>
<body>
<header>
  <h1>Calculadora de Comisiones ONCE 2025</h1>
  <div class="sticky-actions">
    <button id="btn-theme" class="btn-secondary">üåó Modo oscuro</button>
    <button id="btn-export" class="btn-secondary">‚¨áÔ∏è Exportar CSV</button>
  </div>
</header>

<main class="wrap">

  <!-- ALTA DE VENTAS (d√≠a a d√≠a) -->
  <section class="card">
    <h2 style="margin-top:0">‚ûï A√±adir venta (d√≠a a d√≠a)</h2>
    <div class="row">
      <label>Fecha
        <input type="date" id="fecha">
      </label>
      <label>Tipo de producto
        <select id="tipo">
          <optgroup label="Muy alto porcentaje">
            <option value="diario">Diario (2‚Ç¨)</option>
            <option value="cuponazo">Cuponazo (3‚Ç¨)</option>
            <option value="sueldazo">Sueldazo (2‚Ç¨)</option>
            <option value="extraordinario">Extraordinario (tramos)</option>
          </optgroup>
          <optgroup label="Alto porcentaje">
            <option value="eurojackpot">Eurojackpot (2‚Ç¨)</option>
          </optgroup>
          <optgroup label="Resto de productos">
            <option value="triplex">Triplex (0,50‚Ç¨)</option>
            <option value="superonce">Super Once (1‚Ç¨)</option>
            <option value="midia">Mi D√≠a (1‚Ç¨)</option>
            <option value="rasca1">Rasca 1‚Ç¨ (LIBRO=100‚Ç¨)</option>
            <option value="rasca2">Rasca 2‚Ç¨ (LIBRO=100‚Ç¨)</option>
            <option value="rasca3">Rasca 3‚Ç¨ (LIBRO=150‚Ç¨)</option>
            <option value="rasca5">Rasca 5‚Ç¨ (LIBRO=150‚Ç¨)</option>
            <option value="rasca10">Rasca 10‚Ç¨ (LIBRO=150‚Ç¨)</option>
          </optgroup>
        </select>
      </label>
      <label>Unidades (cupones o libros de rasca)
        <input type="number" id="unidades" value="0" min="0" step="1">
      </label>
      <label>Precio unitario (‚Ç¨)
        <input type="number" id="precio" value="2" step="0.01" min="0">
      </label>
    </div>
    <div class="row2">
      <label>Observaciones
        <input type="text" id="obs" placeholder="Opcional (ej: ma√±ana mercado)">
      </label>
      <div class="flex" style="align-items:end;justify-content:flex-end">
        <button id="btn-add" class="btn">üíæ Guardar venta</button>
      </div>
    </div>
    <div class="note">Para **rascas**, las unidades son **libros** (se usa el valor del libro indicado).</div>
  </section>

  <!-- CONTROLES DE MES -->
  <section class="card">
    <div class="flex">
      <h2 style="margin:0">üìÖ Resumen mensual</h2>
      <div class="right flex">
        <label>Mes
          <input type="month" id="mes" />
        </label>
        <button id="btn-clear-mes" class="btn-secondary">üßπ Borrar mes</button>
        <button id="btn-clear-all" class="btn-secondary">üóëÔ∏è Borrar todo</button>
      </div>
    </div>

    <div class="row3" style="margin-top:.75rem">
      <div class="card" style="background:#fff">
        <div class="flex">
          <div>
            <div class="muted">Jornadas trabajadas</div>
            <div id="jornadas" style="font-size:1.4rem;font-weight:700">0</div>
          </div>
          <div style="margin-left:auto;text-align:right">
            <div class="muted">M√≠nimo</div>
            <div id="minimo" style="font-weight:700">0,00 ‚Ç¨</div>
            <div class="muted">Umbral</div>
            <div id="umbral" style="font-weight:700">0,00 ‚Ç¨</div>
          </div>
        </div>
        <div class="progress" style="margin-top:.5rem">
          <div id="bar-min" class="bar" style="width:0%"></div>
        </div>
        <div class="note" id="texto-progreso">0,00 ‚Ç¨ vendidos de 0,00 ‚Ç¨ (m√≠nimo)</div>
      </div>

      <div class="card" style="background:#fff">
        <div class="muted">Total vendido mes</div>
        <div id="total-mes" style="font-size:1.6rem;font-weight:800">0,00 ‚Ç¨</div>
        <div id="estado-mes" class="badge warn" style="margin-top:.4rem">Sin comisi√≥n (no alcanzado umbral)</div>
      </div>

      <div class="card" style="background:#fff">
        <div class="muted">Comisi√≥n estimada mes</div>
        <div id="comision-mes" style="font-size:1.6rem;font-weight:800">0,00 ‚Ç¨</div>
        <div class="note">Si no llegas al **umbral**, la comisi√≥n se queda en 0 ‚Ç¨.</div>
      </div>
    </div>

    <details style="margin-top:.5rem">
      <summary><strong>üìä Desglose por producto</strong></summary>
      <div class="card" style="margin-top:.5rem">
        <div class="note">Las % por familia se configuran en el script (puedes ajustarlas).</div>
        <div class="table-wrap" style="overflow:auto">
          <table id="tabla-productos">
            <thead>
              <tr>
                <th>Producto</th>
                <th class="muted">Familia</th>
                <th>Unid.</th>
                <th>Precio</th>
                <th>Vendido (‚Ç¨)</th>
                <th>%</th>
                <th>Comisi√≥n (‚Ç¨)</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="4">TOTAL</td>
                <td id="t-vendido">0,00 ‚Ç¨</td>
                <td id="t-porc">‚Äî</td>
                <td id="t-comi">0,00 ‚Ç¨</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </details>

    <details style="margin-top:.5rem">
      <summary><strong>üóíÔ∏è Ventas del mes (detalle d√≠a a d√≠a)</strong></summary>
      <div class="table-wrap card" style="margin-top:.5rem;overflow:auto;background:#fff">
        <table id="tabla-mes">
          <thead>
            <tr>
              <th>Fecha</th><th>Producto</th><th>Unid.</th><th>Precio</th><th>Importe</th><th>Notas</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="4">TOTAL MES</td><td id="total-mes-tabla">0,00 ‚Ç¨</td><td></td><td></td></tr>
          </tfoot>
        </table>
      </div>
    </details>
  </section>

  <!-- RESUMEN ANUAL -->
  <section class="card">
    <h2 style="margin-top:0">üìÜ Resumen anual</h2>
    <div class="table-wrap" style="overflow:auto;background:#fff" id="wrap-anual">
      <table id="tabla-anual">
        <thead>
          <tr>
            <th>Mes</th><th>Jornadas</th><th>Vendido (‚Ç¨)</th><th>Umbral (‚Ç¨)</th><th>Comisi√≥n (‚Ç¨)</th><th>Estado</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>TOTAL</td><td id="a-jornadas">0</td><td id="a-vendido">0,00 ‚Ç¨</td><td id="a-umbral">0,00 ‚Ç¨</td><td id="a-comision">0,00 ‚Ç¨</td><td></td></tr>
        </tfoot>
      </table>
    </div>
  </section>

</main>

<script>
/* ========= Configuraci√≥n de productos ========= */
const PRODUCTOS = {
  diario:        { nombre:"Diario",        familia:"muy-alto", precio:2,   porc:0.077 },
  cuponazo:      { nombre:"Cuponazo",      familia:"muy-alto", precio:3,   porc:0.077 },
  sueldazo:      { nombre:"Sueldazo",      familia:"muy-alto", precio:2,   porc:0.077 },
  extraordinario:{ nombre:"Extraordinario",familia:"extra",    precio:2.5, porc:0 }, // % por tramos (m√°s abajo)
  eurojackpot:   { nombre:"Eurojackpot",   familia:"alto",     precio:2,   porc:0.06  },
  triplex:       { nombre:"Triplex",       familia:"resto",    precio:0.5, porc:0.05  },
  superonce:     { nombre:"Super Once",    familia:"resto",    precio:1,   porc:0.05  },
  midia:         { nombre:"Mi D√≠a",        familia:"resto",    precio:1,   porc:0.05  },
  // Rascas por LIBRO:
  rasca1:        { nombre:"Rasca 1‚Ç¨ (libro)",  familia:"resto", precio:100,  porc:0.05 },
  rasca2:        { nombre:"Rasca 2‚Ç¨ (libro)",  familia:"resto", precio:100,  porc:0.05 },
  rasca3:        { nombre:"Rasca 3‚Ç¨ (libro)",  familia:"resto", precio:150,  porc:0.05 },
  rasca5:        { nombre:"Rasca 5‚Ç¨ (libro)",  familia:"resto", precio:150,  porc:0.05 },
  rasca10:       { nombre:"Rasca 10‚Ç¨ (libro)", familia:"resto", precio:150,  porc:0.05 }
};

// Extraordinarios ‚Äì tramos por cupones (solo aplica si el mes supera umbral):
// 1-199:12%, 200-299:13%, 300-399:14%, 400-499:15%, 500-599:16%, 600+:17%
function porcExtra(cupones){
  if (cupones>=600) return 0.17;
  if (cupones>=500) return 0.16;
  if (cupones>=400) return 0.15;
  if (cupones>=300) return 0.14;
  if (cupones>=200) return 0.13;
  if (cupones>=1)   return 0.12;
  return 0;
}

/* ========= Tabla M√≠nimo / Umbral (Jornadas 0..26) =========
   Valores de ejemplo basados en documentaci√≥n aportada (euros).
   Si tienes una actualizaci√≥n oficial, cambia estos arrays. */
const MINIMO = [0,142,284,426,568,710,852,994,1136,1278,1420,1562,1704,1846,1988,2130,2272,2414,2556,2698,2840,2982,3124,3266,3408,3550,3692];
const UMBRAL = [0,210,420,630,840,1050,1260,1470,1680,1890,2100,2310,2520,2730,2940,3150,3360,3570,3780,3990,4200,4410,4620,4830,5040,5250,5460];
// Nota: las posiciones 1..26 equivalen a jornadas; √≠ndice 0 es 0.

const LS_KEY = "calc_once_2025_v2";

/* ========= Estado ========= */
let ventas = load();
function load(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)) || []; }
  catch{ return []; }
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(ventas)); }

/* ========= Utilidades ========= */
const $ = (q)=>document.querySelector(q);
const ‚Ç¨ = (n)=> (n||0).toLocaleString('es-ES',{minimumFractionDigits:2, maximumFractionDigits:2});

function hoyISO(){
  const d = new Date();
  return d.toISOString().slice(0,10);
}
function yyyymm(dateStr){
  return dateStr.slice(0,7);
}
function uniq(arr){ return [...new Set(arr)]; }

/* Sugerir precio al cambiar tipo */
function sugerirPrecio(){
  const tipo = $("#tipo").value;
  $("#precio").value = PRODUCTOS[tipo]?.precio ?? 0;
}

/* A√±adir venta */
function addVenta(){
  const fecha = $("#fecha").value;
  const tipo  = $("#tipo").value;
  const unidades = parseInt($("#unidades").value||"0",10);
  const precio = parseFloat($("#precio").value||"0");
  const obs = $("#obs").value.trim();

  if (!fecha) return alert("Selecciona una fecha.");
  if (!PRODUCTOS[tipo]) return alert("Selecciona un tipo v√°lido.");
  if (!(unidades>0)) return alert("Indica unidades (>0).");
  if (precio<0) return alert("Precio inv√°lido.");

  ventas.push({fecha, tipo, unidades, precio, obs});
  save();
  $("#unidades").value = 0;
  $("#obs").value = "";
  renderTodo();
}

/* Borrar venta por √≠ndice */
function delVenta(idx){
  ventas.splice(idx,1);
  save();
  renderTodo();
}

/* Calcular resumen del mes seleccionado */
function resumenMes(yymm){
  const listado = ventas.filter(v=>yyyymm(v.fecha)===yymm);
  const fechasConVenta = uniq(listado.map(v=>v.fecha)).sort();
  const jornadas = fechasConVenta.length;

  const min = MINIMO[jornadas]||0;
  const umb = UMBRAL[jornadas]||0;

  // Totales por producto
  const porProd = {};
  for (const v of listado){
    const p = PRODUCTOS[v.tipo];
    const importe = v.unidades * v.precio;
    if (!porProd[v.tipo]) porProd[v.tipo] = {nombre:p.nombre, familia:p.familia, unidades:0, importe:0, precio:v.precio};
    porProd[v.tipo].unidades += v.unidades;
    porProd[v.tipo].importe  += importe;
    // precio √∫ltimo visto (visual)
    porProd[v.tipo].precio = v.precio;
  }
  const totalMes = Object.values(porProd).reduce((s,x)=>s+x.importe,0);

  // Comisi√≥n: solo si total >= umbral
  let comisionTotal = 0;
  const detalleComi = {};
  const totalCuponesExtra = (porProd["extraordinario"]?.unidades)||0;
  const porcExtraMes = porcExtra(totalCuponesExtra);

  for (const [k,x] of Object.entries(porProd)){
    let porc = PRODUCTOS[k].porc;
    if (k==="extraordinario") porc = porcExtraMes;
    const comi = (totalMes>=umb) ? x.importe * porc : 0;
    detalleComi[k] = {porc, comi};
    comisionTotal += comi;
  }

  return {
    listado, fechasConVenta, jornadas, minimo:min, umbral:umb,
    porProd, totalMes, comisionTotal, detalleComi
  };
}

/* Resumen anual (por meses existentes en datos) */
function resumenAnual(){
  const meses = uniq(ventas.map(v=>yyyymm(v.fecha))).sort();
  const filas = [];
  let sumJ=0,sumV=0,sumU=0,sumC=0;

  for (const m of meses){
    const r = resumenMes(m);
    const estado = (r.totalMes>=r.umbral) ? "Con comisi√≥n" : (r.totalMes>=r.minimo ? "M√≠nimo" : "Bajo m√≠nimo");
    filas.push({
      mes: m, jornadas: r.jornadas, vendido: r.totalMes, umbral: r.umbral, comision:r.comisionTotal, estado
    });
    sumJ+=r.jornadas; sumV+=r.totalMes; sumU+=r.umbral; sumC+=r.comisionTotal;
  }
  return {filas, sumJ, sumV, sumU, sumC};
}

/* ========= Render ========= */
function renderMes(){
  const yymm = $("#mes").value;
  const r = resumenMes(yymm);

  // KPIs
  $("#jornadas").textContent = r.jornadas;
  $("#minimo").textContent = ‚Ç¨(r.minimo)+" ‚Ç¨";
  $("#umbral").textContent = ‚Ç¨(r.umbral)+" ‚Ç¨";
  $("#total-mes").textContent = ‚Ç¨(r.totalMes)+" ‚Ç¨";
  $("#comision-mes").textContent = ‚Ç¨(r.comisionTotal)+" ‚Ç¨";

  // Estado
  const estado = $("#estado-mes");
  if (r.totalMes>=r.umbral){
    estado.className="badge ok"; estado.textContent="‚úÖ Umbral superado (con comisi√≥n)";
  }else if (r.totalMes>=r.minimo){
    estado.className="badge warn"; estado.textContent="‚ö†Ô∏è M√≠nimo alcanzado (sin comisi√≥n)";
  }else{
    estado.className="badge bad"; estado.textContent="‚ùå Sin m√≠nimo (sin comisi√≥n)";
  }

  // Barra progreso a m√≠nimo
  const pc = (r.minimo>0) ? Math.min(100, (r.totalMes/r.minimo)*100) : 0;
  $("#bar-min").style.width = pc.toFixed(1)+"%";
  $("#texto-progreso").textContent = `${‚Ç¨(r.totalMes)} ‚Ç¨ vendidos de ${‚Ç¨(r.minimo)} ‚Ç¨ (m√≠nimo)`;

  // Tabla ventas del mes
  const tb = $("#tabla-mes tbody");
  tb.innerHTML = "";
  r.listado
    .map((v,idx)=>({v,idx}))
    .sort((a,b)=> (a.v.fecha<b.v.fecha?-1:a.v.fecha>b.v.fecha?1:0))
    .forEach(({v,idx})=>{
      const tr = document.createElement("tr");
      const importe = v.unidades*v.precio;
      tr.innerHTML = `
        <td>${v.fecha}</td>
        <td>${PRODUCTOS[v.tipo].nombre}</td>
        <td>${v.unidades}</td>
        <td>${‚Ç¨(v.precio)}</td>
        <td>${‚Ç¨(importe)}</td>
        <td style="text-align:left">${v.obs||""}</td>
        <td><button class="btn-secondary" onclick="delVenta(${ventas.indexOf(v)})">Eliminar</button></td>
      `;
      tb.appendChild(tr);
    });
  $("#total-mes-tabla").textContent = ‚Ç¨(r.totalMes)+" ‚Ç¨";

  // Desglose por producto
  const tpb = $("#tabla-productos tbody");
  tpb.innerHTML = "";
  let sumVend=0,sumComi=0;
  for (const [k,x] of Object.entries(r.porProd).sort((a,b)=>a[1].nombre.localeCompare(b[1].nombre))){
    const det = r.detalleComi[k];
    const porc = det ? det.porc : PRODUCTOS[k].porc;
    const comi = det ? det.comi : 0;
    const fam = PRODUCTOS[k].familia;
    const famText = fam==="muy-alto"?"Muy alto": fam==="alto"?"Alto": fam==="extra"?"Extraordinario":"Resto";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${x.nombre}</td>
      <td class="muted">${famText}</td>
      <td>${x.unidades}</td>
      <td>${‚Ç¨(x.precio)}</td>
      <td>${‚Ç¨(x.importe)}</td>
      <td>${porc? (porc*100).toFixed(1)+"%":"‚Äî"}</td>
      <td>${‚Ç¨(comi)}</td>
    `;
    tpb.appendChild(tr);
    sumVend+=x.importe; sumComi+=comi;
  }
  $("#t-vendido").textContent = ‚Ç¨(sumVend)+" ‚Ç¨";
  $("#t-comi").textContent = ‚Ç¨(sumComi)+" ‚Ç¨";
}

function renderAnual(){
  const r = resumenAnual();
  const tb = $("#tabla-anual tbody");
  tb.innerHTML = "";
  for (const f of r.filas){
    const tr = document.createElement("tr");
    const cls = f.estado.includes("Umbral")||f.estado.includes("comisi√≥n")? "ok" :
                (f.vendido>=f.umbral?"ok": f.vendido>=MINIMO[f.jornadas]?"warn":"bad");
    tr.innerHTML = `
      <td>${f.mes}</td>
      <td>${f.jornadas}</td>
      <td>${‚Ç¨(f.vendido)} ‚Ç¨</td>
      <td>${‚Ç¨(f.umbral)} ‚Ç¨</td>
      <td>${‚Ç¨(f.comision)} ‚Ç¨</td>
      <td class="${cls}">${f.estado}</td>
    `;
    tb.appendChild(tr);
  }
  $("#a-jornadas").textContent = r.sumJ;
  $("#a-vendido").textContent = ‚Ç¨(r.sumV)+" ‚Ç¨";
  $("#a-umbral").textContent = ‚Ç¨(r.sumU)+" ‚Ç¨";
  $("#a-comision").textContent = ‚Ç¨(r.sumC)+" ‚Ç¨";
}

function renderTodo(){
  const m = $("#mes").value;
  renderMes(m);
  renderAnual();
}

/* ========= Export CSV ========= */
function exportCSV(){
  let rows = [["fecha","producto","familia","unidades","precio","importe","observaciones"]];
  ventas
    .sort((a,b)=>a.fecha.localeCompare(b.fecha))
    .forEach(v=>{
      const p = PRODUCTOS[v.tipo];
      const imp = v.unidades*v.precio;
      rows.push([v.fecha,p.nombre,p.familia,v.unidades, v.precio.toString().replace(".",","), imp.toFixed(2).replace(".",","), (v.obs||"").replaceAll('"','""')]);
    });
  const csv = rows.map(r=>r.map(x=>{
    const s = (x==null?"":String(x));
    return /[",;\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(";")).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "ventas_once.csv";
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ========= Eventos ========= */
$("#tipo").addEventListener("change", sugerirPrecio);
$("#btn-add").addEventListener("click", addVenta);
$("#btn-export").addEventListener("click", exportCSV);
$("#btn-theme").addEventListener("click", ()=>{
  const r = document.documentElement;
  r.dataset.theme = r.dataset.theme==="dark" ? "" : "dark";
  localStorage.setItem("theme_once", r.dataset.theme || "light");
});
$("#btn-clear-mes").addEventListener("click", ()=>{
  const yymm = $("#mes").value;
  if (!yymm) return;
  if (!confirm("¬øBorrar todas las ventas del mes "+yymm+"?")) return;
  ventas = ventas.filter(v=>yyyymm(v.fecha)!==yymm);
  save(); renderTodo();
});
$("#btn-clear-all").addEventListener("click", ()=>{
  if (!confirm("¬øBorrar TODOS los datos? Esta acci√≥n no se puede deshacer.")) return;
  ventas = []; save(); renderTodo();
});

/* ========= Init ========= */
(function init(){
  // Fecha/mes por defecto
  $("#fecha").value = hoyISO();
  const m = hoyISO().slice(0,7);
  $("#mes").value = m;

  // Tema recordado
  const t = localStorage.getItem("theme_once");
  if (t==="dark") document.documentElement.dataset.theme="dark";

  // Precio inicial sugerido
  sugerirPrecio();

  // Primera pintura
  renderTodo();

  // Registrar SW si existe
  if ("serviceWorker" in navigator){
    fetch("./service-worker.js",{method:"HEAD"}).then(r=>{
      if (r.ok) navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
    }).catch(()=>{});
  }
})();
</script>
</body>
</html>
