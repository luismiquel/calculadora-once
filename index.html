<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Calculadora ONCE 2025 ‚Äî Calendario + Resumen semanal y mensual</title>
<style>
:root{
  --bg:#0b1320; --fg:#e8eefc; --muted:#9bb0cc; --card:#111a2c; --accent:#4da3ff;
  --good:#2ecc71; --warn:#f1c40f; --bad:#e74c3c; --border:#1f2a44; --focus:0 0 0 3px rgba(77,163,255,.25);
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
.wrap{max-width:1100px;margin-inline:auto;padding:16px}
h1{margin:0 0 10px;font-size:clamp(22px,3.5vw,28px)}
h2{margin:10px 0;font-size:clamp(18px,3vw,22px)}
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
.grid{display:grid;gap:12px}
@media(min-width:980px){.grid.two{grid-template-columns:1.1fr 1fr}}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--fg)}
input[type="number"]:focus{outline:var(--focus)}
.btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--accent);color:#fff;cursor:pointer}
.btn.secondary{background:transparent;color:var(--fg)}
.btn.danger{background:var(--bad);border-color:transparent}
.inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.mono{font-variant-numeric:tabular-nums}
.tips{font-size:13px;color:var(--muted)}
.kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.kpi .box{background:rgba(255,255,255,.03);border:1px solid var(--border);padding:10px;border-radius:10px}
.kpi .val{font-weight:600}
.stepper-wrap{display:flex;gap:6px;align-items:center}
.stepper{display:flex;gap:6px}
.stepper button{padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--fg);cursor:pointer}
.stepper button:focus{outline:var(--focus)}
.stepper button.neg{border-color:var(--bad)}
.cal-wrap{display:grid;gap:10px}
.cal-head{display:flex;align-items:center;justify-content:space-between}
.cal-head .nav{display:flex;gap:8px;align-items:center}
.legend{display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
.legend .chip{width:10px;height:10px;border-radius:3px;border:1px solid var(--border)}
.chip.min{background:rgba(241,196,15,.25)}
.chip.umb{background:rgba(46,204,113,.25)}
.chip.low{background:rgba(255,255,255,.06)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-dow{font-size:12px;color:var(--muted);text-align:center}
.cal-day{border:1px solid var(--border);border-radius:10px;padding:8px;min-height:66px;cursor:pointer;position:relative;background:rgba(255,255,255,.02); transition:box-shadow .15s, background .15s}
.cal-day.out{opacity:.45}
.cal-day .num{font-size:13px;color:var(--muted)}
.cal-day .dot{position:absolute;right:8px;bottom:8px;width:8px;height:8px;border-radius:50%;background:var(--accent)}
.cal-day.today{outline:var(--focus)}
.cal-day.sel{box-shadow:inset 0 0 0 2px var(--accent)}
.cal-day.min{background:rgba(241,196,15,.20)}
.cal-day.umb{background:rgba(46,204,113,.20)}
.cal-day.low{background:rgba(255,255,255,.04)}
.day-total{position:absolute;right:8px;top:8px;font-size:12px;opacity:.9}
.day-total .pill{display:inline-block;padding:1px 6px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.06)}
.day-total .pill.min{background:rgba(241,196,15,.25);border-color:transparent;color:#2a2400}
.day-total .pill.umb{background:rgba(46,204,113,.25);border-color:transparent;color:#052b11}
.day-total .pill.low{background:rgba(255,255,255,.10)}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid var(--border);text-align:right}
th:first-child,td:first-child{text-align:left}
.badge{display:inline-block;padding:.15rem .5rem;border-radius:999px;border:1px solid var(--border);font-size:.8rem}
.badge.good{background:rgba(46,204,113,.25);border-color:transparent;color:#052b11}
.badge.warn{background:rgba(241,196,15,.25);border-color:transparent;color:#2a2400}
.badge.bad{background:rgba(231,76,60,.25);border-color:transparent;color:#2b0303}
.sep{border:0;border-top:1px solid var(--border);margin:12px 0}
</style>

<script>
// ‚Äî‚Äî‚Äî Limpieza de Service Workers y cach√©s (evita errores antiguos) ‚Äî‚Äî‚Äî
(function(){
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs=>{
      regs.forEach(r=>r.unregister());
      console.log('[SW] Todos los service workers desregistrados');
    }).catch(()=>{});
  }
  if (window.caches && caches.keys) {
    caches.keys().then(keys=>Promise.all(keys.map(k=>caches.delete(k)))).then(()=>{
      console.log('[SW] Cach√©s borradas');
    }).catch(()=>{});
  }
})();
</script>
</head>
<body>
<div class="wrap">
  <h1>Calculadora ONCE 2025 ‚Äî Calendario</h1>

  <div class="grid two">
    <!-- Izquierda: Calendario + Ventas -->
    <section class="card">
      <div class="cal-wrap">
        <div class="cal-head">
          <div class="nav">
            <button id="prevMes" class="btn secondary">‚üµ Mes</button>
            <button id="hoyBtn" class="btn secondary">Hoy</button>
            <button id="nextMes" class="btn secondary">Mes ‚ü∂</button>
          </div>
          <div class="legend">
            <span class="chip low"></span> <span>Por debajo</span>
            <span class="chip min"></span> <span>M√≠nimo</span>
            <span class="chip umb"></span> <span>Umbral</span>
          </div>
          <div class="mono" id="tituloMes"></div>
        </div>
        <div class="cal-grid" id="calDow"></div>
        <div class="cal-grid" id="calDays"></div>
      </div>

      <hr class="sep">

      <h2 style="margin:0 0 6px">D√≠a seleccionado: <span id="lblFecha" class="mono">‚Äî</span></h2>

      <h3 style="margin:8px 0 6px">Cupones</h3>
      <div class="grid" style="grid-template-columns:repeat(3,1fr);gap:8px">
        <div><label>Diario (2‚Ç¨)</label><input type="number" id="nDiario" min="0" step="1" placeholder="0"></div>
        <div><label>Cuponazo (3‚Ç¨)</label><input type="number" id="nCuponazo" min="0" step="1" placeholder="0"></div>
        <div><label>Sueldazo (2‚Ç¨)</label><input type="number" id="nSueldazo" min="0" step="1" placeholder="0"></div>
      </div>

      <h3 style="margin:10px 0 6px">Rascas (por libros)</h3>
      <div class="grid" style="grid-template-columns:repeat(5,1fr);gap:8px">
        <div><label>R1‚Ç¨ (libro=100‚Ç¨)</label><input type="number" id="libroR1" min="0" step="1" placeholder="0"></div>
        <div><label>R2‚Ç¨ (libro=100‚Ç¨)</label><input type="number" id="libroR2" min="0" step="1" placeholder="0"></div>
        <div><label>R3‚Ç¨ (libro=150‚Ç¨)</label><input type="number" id="libroR3" min="0" step="1" placeholder="0"></div>
        <div><label>R5‚Ç¨ (libro=150‚Ç¨)</label><input type="number" id="libroR5" min="0" step="1" placeholder="0"></div>
        <div><label>R10‚Ç¨ (libro=150‚Ç¨)</label><input type="number" id="libroR10" min="0" step="1" placeholder="0"></div>
      </div>

      <h3 style="margin:10px 0 6px">Activos</h3>
      <div class="grid" style="grid-template-columns:repeat(4,1fr);gap:8px">
        <div><label>Triples (0,50‚Ç¨)</label><input type="number" id="nTriples" min="0" step="1" placeholder="0"></div>
        <div><label>SuperONCE (importe ‚Ç¨)</label><input type="number" id="eurosSuperonce" min="0" step="0.5" placeholder="0"></div>
        <div><label>Mi D√≠a (1‚Ç¨)</label><input type="number" id="nMiDia" min="0" step="1" placeholder="0"></div>
        <div><label>Eurojackpot (2‚Ç¨)</label><input type="number" id="nEurojackpot" min="0" step="1" placeholder="0"></div>
      </div>

      <h3 style="margin:10px 0 6px">Extras (comisi√≥n por tramos)</h3>
      <div class="grid" style="grid-template-columns:repeat(5,1fr);gap:8px">
        <div><label>Navidad (10‚Ç¨)</label><input type="number" id="extNavidad" min="0" step="1" placeholder="0"></div>
        <div><label>Verano (6‚Ç¨)</label><input type="number" id="extVerano" min="0" step="1" placeholder="0"></div>
        <div><label>Once del Once (6‚Ç¨)</label><input type="number" id="extOnceOnce" min="0" step="1" placeholder="0"></div>
        <div><label>D√≠a del Padre (5‚Ç¨)</label><input type="number" id="extDiaPadre" min="0" step="1" placeholder="0"></div>
        <div><label>D√≠a de la Madre (5‚Ç¨)</label><input type="number" id="extDiaMadre" min="0" step="1" placeholder="0"></div>
      </div>

      <div class="inline" style="margin-top:10px;gap:10px;flex-wrap:wrap">
        <button id="resetDia" class="btn danger">Reiniciar d√≠a</button>
        <button id="btnSumar" class="btn">üíæ Guardar (sumar)</button>
        <button id="btnReemplazar" class="btn secondary">üíæ Guardar (reemplazar)</button>
      </div>

      <p class="tips">‚ÄúGuardar (sumar)‚Äù acumula; ‚Äúreemplazar‚Äù pisa el d√≠a. Los extras aplican porcentaje por tramos seg√∫n cupones del d√≠a.</p>

      <div class="card" style="margin-top:10px">
        <div class="kpi">
          <div class="box"><div class="muted">Total del d√≠a (‚Ç¨)</div><div class="val mono" id="totDia">0,00</div></div>
          <div class="box"><div class="muted">Comisi√≥n d√≠a (‚Ç¨)</div><div class="val mono" id="comDia">0,00</div></div>
          <div class="box"><div class="muted">Extras cupones (d√≠a)</div><div class="val mono" id="extraCntDia">0</div></div>
          <div class="box"><div class="muted">Extras (‚Ç¨ d√≠a)</div><div class="val mono" id="extraEurDia">0,00</div></div>
          <div class="box"><div class="muted">% extras aplicado</div><div class="val mono" id="extraPctDia">0%</div></div>
          <div class="box"><div class="muted">Comisi√≥n extras (d√≠a)</div><div class="val mono" id="comExtraDia">0,00</div></div>
        </div>
      </div>
    </section>

    <!-- Derecha: Semana + Mes -->
    <section class="card">
      <h2 style="margin:0 0 6px">Resumen semanal (L‚ÄìD) de la fecha seleccionada</h2>
      <div class="tips" id="lblSemana">Semana: ‚Äî</div>
      <div style="overflow:auto;margin-top:8px">
        <table id="tablaSemana">
          <thead>
            <tr><th>D√≠a</th><th>Fecha</th><th>Ventas ‚Ç¨</th><th>M√≠nimo/Umbral</th><th>Estado</th></tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><th colspan="2">Total semana</th><th class="mono" id="totSem">0,00</th><th class="mono" id="objSem">0,00 / 0,00</th><th></th></tr>
          </tfoot>
        </table>
      </div>
      <div class="kpi" style="margin-top:10px">
        <div class="box"><div class="muted">Extras cupones (semana)</div><div class="val mono" id="extraCntSem">0</div></div>
        <div class="box"><div class="muted">Extras (‚Ç¨ semana)</div><div class="val mono" id="extraEurSem">0,00</div></div>
        <div class="box"><div class="muted">Comisi√≥n extras (semana)</div><div class="val mono" id="comExtraSem">0,00</div></div>
      </div>

      <hr class="sep">

      <h2 style="margin:0 0 6px">Resumen mensual</h2>
      <div class="kpi">
        <div class="box"><div class="muted">Ventas mes (‚Ç¨)</div><div class="val mono" id="totMes">0,00</div></div>
        <div class="box"><div class="muted">Jornadas mes</div><div class="val mono" id="jorMes">0</div></div>
        <div class="box"><div class="muted">Objetivo mes (m√≠n.)</div><div class="val mono" id="objMinMes">0,00</div></div>
        <div class="box"><div class="muted">Objetivo mes (umbral)</div><div class="val mono" id="objUmbMes">0,00</div></div>
      </div>
      <div class="kpi" style="margin-top:10px">
        <div class="box"><div class="muted">Extras cupones (mes)</div><div class="val mono" id="extraCntMes">0</div></div>
        <div class="box"><div class="muted">Extras (‚Ç¨ mes)</div><div class="val mono" id="extraEurMes">0,00</div></div>
        <div class="box"><div class="muted">Comisi√≥n extras (mes)</div><div class="val mono" id="comExtraMes">0,00</div></div>
      </div>
      <p class="tips" id="txtExtraNextTier">‚Äì</p>
      <p class="tips" id="txtMetaMes">‚Äì</p>
    </section>
  </div>
</div>

<script>
(function(){
  // ‚Äî‚Äî‚Äî Configuraci√≥n ‚Äî‚Äî‚Äî
  const PRICES = { diario:2, cuponazo:3, sueldazo:2, triples:0.5, miDia:1, eurojackpot:2 };
  const LIBROS_RASCAS = { r1:100, r2:100, r3:150, r5:150, r10:150 };
  const MIN_DIA=142, UMBRAL_DIA=210;
  const KEY='once2025.data'; // { "YYYY-MM": { "YYYY-MM-DD": entry } }

  // ‚Äî‚Äî‚Äî Estado ‚Äî‚Äî‚Äî
  let data = load();
  let current = new Date(); current.setHours(0,0,0,0);

  // ‚Äî‚Äî‚Äî Utils ‚Äî‚Äî‚Äî
  const pad2 = (n)=> String(n).padStart(2,'0');
  const yyyymm = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  const iso = (d)=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

  // Formato robusto "1.234,56"
  function fmtEur(n){
    const num = Number.isFinite(n) ? n : 0;
    const sign = num < 0 ? '-' : '';
    const abs = Math.abs(num);
    const fixed = abs.toFixed(2);
    const [i, d] = fixed.split('.');
    const withDots = i.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    return sign + withDots + ',' + d;
  }

  function mondayOf(d){ const x=new Date(d); const wd=(x.getDay()+6)%7; x.setDate(x.getDate()-wd); x.setHours(0,0,0,0); return x; }
  function sundayOf(d){ const m=mondayOf(d); const s=new Date(m); s.setDate(m.getDate()+6); s.setHours(23,59,59,999); return s; }

  function load(){ try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch{return {}} }
  function save(obj){ localStorage.setItem(KEY, JSON.stringify(obj)); }

  // ‚Äî‚Äî‚Äî Extras por TRAMOS ‚Äî‚Äî‚Äî
  function extraPctByCount(cnt){
    if (cnt<=0) return 0;
    if (cnt<=199) return 0.12;
    if (cnt<=299) return 0.13;
    if (cnt<=399) return 0.14;
    if (cnt<=499) return 0.15;
    if (cnt<=599) return 0.16;
    return 0.17;
  }
  function nextTierInfo(cnt){
    if (cnt<=0) return {next:1, pct:0.12, faltan:1};
    if (cnt<199) return {next:200, pct:0.13, faltan:200-cnt};
    if (cnt<299) return {next:300, pct:0.14, faltan:300-cnt};
    if (cnt<399) return {next:400, pct:0.15, faltan:400-cnt};
    if (cnt<499) return {next:500, pct:0.16, faltan:500-cnt};
    if (cnt<599) return {next:600, pct:0.17, faltan:600-cnt};
    return {next:null, pct:0.17, faltan:0};
  }
  function extrasCount(e){
    return (e.extNavidad||0)+(e.extVerano||0)+(e.extOnceOnce||0)+(e.extDiaPadre||0)+(e.extDiaMadre||0);
  }
  function extrasEuros(e){
    return (e.extNavidad||0)*10 + (e.extVerano||0)*6 + (e.extOnceOnce||0)*6 + (e.extDiaPadre||0)*5 + (e.extDiaMadre||0)*5;
  }

  // ‚Äî‚Äî‚Äî Totales por entrada ‚Äî‚Äî‚Äî
  function calcTotalEntry(e){
    const totalCupones = (e.diario||0)*PRICES.diario + (e.cuponazo||0)*PRICES.cuponazo + (e.sueldazo||0)*PRICES.sueldazo;
    const totalRascas = (e.r1||0)*LIBROS_RASCAS.r1 + (e.r2||0)*LIBROS_RASCAS.r2 + (e.r3||0)*LIBROS_RASCAS.r3 + (e.r5||0)*LIBROS_RASCAS.r5 + (e.r10||0)*LIBROS_RASCAS.r10;
    const totalActivos = (e.triples||0)*PRICES.triples + (e.superonce||0) + (e.miDia||0)*PRICES.miDia + (e.eurojackpot||0)*PRICES.eurojackpot;
    const totalExtras = extrasEuros(e);
    return totalCupones + totalRascas + totalActivos + totalExtras;
  }

  function calcComisionEntry(e){
    // Normales (fijas)
    const cNorm =  (e.diario||0)*2*0.06 + (e.cuponazo||0)*3*0.06 + (e.sueldazo||0)*2*0.06
                 + (e.r1||0)*LIBROS_RASCAS.r1*0.05 + (e.r2||0)*LIBROS_RASCAS.r2*0.05 + (e.r3||0)*LIBROS_RASCAS.r3*0.05
                 + (e.r5||0)*LIBROS_RASCAS.r5*0.05 + (e.r10||0)*LIBROS_RASCAS.r10*0.05
                 + (e.triples||0)*0.5*0.05 + (e.superonce||0)*1*0.05 + (e.miDia||0)*1*0.05 + (e.eurojackpot||0)*2*0.05;
    // Extras por tramo (del d√≠a)
    const cnt = extrasCount(e);
    const pct = extraPctByCount(cnt);
    const eur = extrasEuros(e);
    const cExt = eur * pct;
    return { total: cNorm + cExt, cNorm, cExt, cnt, pct, eur };
  }

  // ‚Äî‚Äî‚Äî DOM ‚Äî‚Äî‚Äî
  const tituloMes = document.getElementById('tituloMes');
  const calDow = document.getElementById('calDow');
  const calDays = document.getElementById('calDays');
  const lblFecha = document.getElementById('lblFecha');
  const btnPrev = document.getElementById('prevMes');
  const btnNext = document.getElementById('nextMes');
  const btnHoy  = document.getElementById('hoyBtn');
  const btnSumar = document.getElementById('btnSumar');
  const btnReempl = document.getElementById('btnReemplazar');
  const btnReset = document.getElementById('resetDia');

  const inputs = {
    nDiario: 'diario', nCuponazo:'cuponazo', nSueldazo:'sueldazo',
    libroR1:'r1', libroR2:'r2', libroR3:'r3', libroR5:'r5', libroR10:'r10',
    nTriples:'triples', eurosSuperonce:'superonce', nMiDia:'miDia', nEurojackpot:'eurojackpot',
    extNavidad:'extNavidad', extVerano:'extVerano', extOnceOnce:'extOnceOnce', extDiaPadre:'extDiaPadre', extDiaMadre:'extDiaMadre'
  };
  const inputEls = Object.fromEntries(Object.keys(inputs).map(id=>[id, document.getElementById(id)]));

  const totDiaEl = document.getElementById('totDia');
  const comDiaEl = document.getElementById('comDia');
  const extraCntDiaEl = document.getElementById('extraCntDia');
  const extraEurDiaEl = document.getElementById('extraEurDia');
  const extraPctDiaEl = document.getElementById('extraPctDia');
  const comExtraDiaEl = document.getElementById('comExtraDia');

  const lblSemana = document.getElementById('lblSemana');
  const tblBody = document.querySelector('#tablaSemana tbody');
  const totSem = document.getElementById('totSem');
  const objSem = document.getElementById('objSem');
  const extraCntSemEl = document.getElementById('extraCntSem');
  const extraEurSemEl = document.getElementById('extraEurSem');
  const comExtraSemEl = document.getElementById('comExtraSem');

  // Mensual
  const totMesEl = document.getElementById('totMes');
  const jorMesEl = document.getElementById('jorMes');
  const objMinMesEl = document.getElementById('objMinMes');
  const objUmbMesEl = document.getElementById('objUmbMes');
  const extraCntMesEl = document.getElementById('extraCntMes');
  const extraEurMesEl = document.getElementById('extraEurMes');
  const comExtraMesEl = document.getElementById('comExtraMes');
  const txtExtraNextTier = document.getElementById('txtExtraNextTier');
  const txtMetaMes = document.getElementById('txtMetaMes');

  // ‚Äî‚Äî‚Äî DOW encabezado ‚Äî‚Äî‚Äî
  const dows = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
  calDow.innerHTML = dows.map(d=>`<div class="cal-dow">${d}</div>`).join('');

  // ‚Äî‚Äî‚Äî Calendario ‚Äî‚Äî‚Äî
  function renderCalendar(){
    const ym = yyyymm(current);
    tituloMes.textContent = current.toLocaleDateString('es-ES',{month:'long', year:'numeric'});
    const first = new Date(current.getFullYear(), current.getMonth(), 1);
    const start = mondayOf(first);
    const todayIso = iso(new Date());
    const monthObj = (data[ym]||{});

    const cells = [];
    for(let i=0;i<42;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const inMonth = d.getMonth()===current.getMonth();
      const isToday = iso(d)===todayIso;
      const isSel = iso(d)===iso(current);
      const e = monthObj[iso(d)]||{};
      const total = calcTotalEntry(e);
      const hasData = total>0;
      const stateClass = total>=UMBRAL_DIA ? 'umb' : total>=MIN_DIA ? 'min' : (hasData ? 'low' : '');
      const pillClass = total>=UMBRAL_DIA ? 'umb' : total>=MIN_DIA ? 'min' : 'low';
      const pill = hasData ? `<span class="pill ${pillClass}">${fmtEur(total)}</span>` : '';
      cells.push(`
        <div class="cal-day ${inMonth?'':'out'} ${isToday?'today':''} ${isSel?'sel':''} ${stateClass}" data-date="${iso(d)}">
          <div class="num">${d.getDate()}</div>
          <div class="day-total">${pill}</div>
          ${hasData?'<span class="dot"></span>':''}
        </div>
      `);
    }
    calDays.innerHTML = cells.join('');
    calDays.querySelectorAll('.cal-day').forEach(div=>{
      div.addEventListener('click', ()=>{
        const d = div.getAttribute('data-date');
        const [Y,M,D]=d.split('-').map(Number);
        current = new Date(Y, M-1, D);
        loadDay();
        renderCalendar();
        renderWeek();
        renderMonth();
      });
    });
  }

  // ‚Äî‚Äî‚Äî D√≠a ‚Äî‚Äî‚Äî
  function getEntry(dateIso){
    const ym = dateIso.slice(0,7);
    return (data[ym] && data[ym][dateIso]) ? {...data[ym][dateIso]} : {};
  }
  function setEntry(dateIso, entry, mode='replace'){
    const ym = dateIso.slice(0,7);
    data[ym] = data[ym] || {};
    const prev = data[ym][dateIso] || {};
    if(mode==='add'){
      const keys = ['diario','cuponazo','sueldazo','r1','r2','r3','r5','r10','triples','superonce','miDia','eurojackpot','extNavidad','extVerano','extOnceOnce','extDiaPadre','extDiaMadre'];
      const out = {...prev};
      for(const k of keys){ out[k] = (out[k]||0) + (entry[k]||0); }
      data[ym][dateIso] = out;
    }else{
      data[ym][dateIso] = entry;
    }
    save(data);
  }

  function readInputs(){
    const e = {};
    for(const id in inputs){
      const k = inputs[id];
      const v = id==='eurosSuperonce' ? Math.max(0, +inputEls[id].value||0) : Math.max(0, Math.floor(+inputEls[id].value||0));
      e[k] = v;
    }
    return e;
  }
  function writeInputs(e){
    inputEls.nDiario.value = e.diario||0;
    inputEls.nCuponazo.value = e.cuponazo||0;
    inputEls.nSueldazo.value = e.sueldazo||0;
    inputEls.libroR1.value = e.r1||0; inputEls.libroR2.value = e.r2||0; inputEls.libroR3.value = e.r3||0; inputEls.libroR5.value = e.r5||0; inputEls.libroR10.value = e.r10||0;
    inputEls.nTriples.value = e.triples||0; inputEls.eurosSuperonce.value = e.superonce||0; inputEls.nMiDia.value = e.miDia||0; inputEls.nEurojackpot.value = e.eurojackpot||0;
    inputEls.extNavidad.value = e.extNavidad||0; inputEls.extVerano.value = e.extVerano||0; inputEls.extOnceOnce.value = e.extOnceOnce||0; inputEls.extDiaPadre.value = e.extDiaPadre||0; inputEls.extDiaMadre.value = e.extDiaMadre||0;
  }

  function recalcDayTotals(){
    const e = readInputs();
    const totals = calcComisionEntry(e); // {total, cNorm, cExt, cnt, pct, eur}
    const totalDia = calcTotalEntry(e);
    totDiaEl.textContent = fmtEur(totalDia);
    comDiaEl.textContent = fmtEur(totals.total);
    extraCntDiaEl.textContent = totals.cnt;
    extraEurDiaEl.textContent = fmtEur(totals.eur);
    extraPctDiaEl.textContent = (totals.pct*100).toFixed(0)+'%';
    comExtraDiaEl.textContent = fmtEur(totals.cExt);
  }

  function loadDay(){
    const dIso = iso(current);
    const e = getEntry(dIso);
    document.getElementById('lblFecha').textContent = dIso;
    writeInputs(e);
    recalcDayTotals();
  }

  // ‚Äî‚Äî‚Äî Semana ‚Äî‚Äî‚Äî
  function renderWeek(){
    const mon = mondayOf(current);
    const sun = sundayOf(current);
    lblSemana.textContent = `Semana: ${iso(mon)} a ${iso(sun)}`;
    tblBody.innerHTML = '';
    let sumTotal=0, jornadas=0;
    let extraCnt=0, extraEur=0, extraComi=0;

    for(let i=0;i<7;i++){
      const d=new Date(mon); d.setDate(mon.getDate()+i);
      const dIso=iso(d);
      const e = getEntry(dIso);
      const total = calcTotalEntry(e);
      const comi = calcComisionEntry(e);
      const estado = total>=UMBRAL_DIA? ['good','Umbral'] : total>=MIN_DIA? ['warn','M√≠nimo'] : ['bad','Pendiente'];
      if(total>0) jornadas++;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'][i]}</td>
        <td class="mono">${dIso}</td>
        <td class="mono">${fmtEur(total)}</td>
        <td class="mono">${fmtEur(MIN_DIA)} / ${fmtEur(UMBRAL_DIA)}</td>
        <td><span class="badge ${estado[0]}">${estado[1]}</span></td>
      `;
      tblBody.appendChild(tr);

      sumTotal += total;
      extraCnt  += comi.cnt;
      extraEur  += comi.eur;
      extraComi += comi.cExt; // suma comisi√≥n de extras, tramo por d√≠a
    }

    totSem.textContent = fmtEur(sumTotal);
    objSem.textContent = `${fmtEur(jornadas*MIN_DIA)} / ${fmtEur(jornadas*UMBRAL_DIA)}`;
    extraCntSemEl.textContent = extraCnt;
    extraEurSemEl.textContent = fmtEur(extraEur);
    comExtraSemEl.textContent = fmtEur(extraComi);
  }

  // ‚Äî‚Äî‚Äî Mes ‚Äî‚Äî‚Äî
  function renderMonth(){
    const ym = yyyymm(current);
    const month = data[ym] || {};
    const dates = Object.keys(month);
    let tot=0, j=0;
    let extraCnt=0, extraEur=0, comExt=0;

    for(const d of dates){
      const e = month[d]||{};
      const t = calcTotalEntry(e);
      if(t>0) j++;
      tot += t;
      const ce = calcComisionEntry(e);
      extraCnt += ce.cnt;
      extraEur += ce.eur;
      comExt   += ce.cExt;
    }

    totMesEl.textContent = fmtEur(tot);
    jorMesEl.textContent = j;
    objMinMesEl.textContent = fmtEur(j*MIN_DIA);
    objUmbMesEl.textContent = fmtEur(j*UMBRAL_DIA);

    extraCntMesEl.textContent = extraCnt;
    extraEurMesEl.textContent = fmtEur(extraEur);
    comExtraMesEl.textContent = fmtEur(comExt);

    // Mensajes de ayuda
    const nxt = nextTierInfo(extraCnt);
    if(nxt.next){
      txtExtraNextTier.textContent = `Extras mes: te faltan ${nxt.faltan} cupones para llegar al ${Math.round(nxt.pct*100)}% (informativo por acumulado mensual).`;
    }else{
      txtExtraNextTier.textContent = `Extras mes: ya est√°s en el tramo m√°ximo (17%).`;
    }
    if(tot>=j*UMBRAL_DIA){
      txtMetaMes.textContent = `‚úÖ Mes en umbral (+${fmtEur(tot - j*UMBRAL_DIA)} sobre umbral).`;
    }else if(tot>=j*MIN_DIA){
      txtMetaMes.textContent = `üü° Mes en m√≠nimo. Faltan ${fmtEur(j*UMBRAL_DIA - tot)} para el umbral.`;
    }else{
      txtMetaMes.textContent = `üî¥ Faltan ${fmtEur(j*MIN_DIA - tot)} para el m√≠nimo del mes.`;
    }
  }

  // ‚Äî‚Äî‚Äî Steppers ‚Äî‚Äî‚Äî
  function attachSteppers(ids, steps=[-5,-1,1,5,10]){
    ids.forEach(id=>{
      const input = document.getElementById(id);
      if(!input || input.dataset.stepper==="1") return;
      input.dataset.stepper = "1";
      const wrap = document.createElement('div');
      wrap.className = 'stepper-wrap';
      const btns = document.createElement('div');
      btns.className = 'stepper';
      input.parentElement.insertBefore(wrap, input);
      wrap.appendChild(input);
      wrap.appendChild(btns);
      steps.forEach(s=>{
        const b = document.createElement('button');
        b.type='button';
        b.textContent = `${s>0?'+':''}${s}`;
        if(s<0) b.classList.add('neg');
        b.addEventListener('click', ()=>{
          const isMoney = input.id==='eurosSuperonce';
          let cur = +input.value||0;
          let next = cur + s;
          if(isMoney){ if(next<0) next=0; }
          else{ next = Math.max(0, Math.floor(next)); }
          input.value = next;
          input.dispatchEvent(new Event('input',{bubbles:true}));
        });
        btns.appendChild(b);
      });
    });
  }

  // ‚Äî‚Äî‚Äî Listeners ‚Äî‚Äî‚Äî
  Object.keys(inputs).forEach(id=>{
    document.getElementById(id).addEventListener('input', ()=>{
      recalcDayTotals();
      renderCalendar(); // refresca colores/p√≠ldoras del mes
      renderWeek();
      renderMonth();
    });
  });

  document.getElementById('btnSumar').addEventListener('click', ()=>{
    const dIso = iso(current);
    const e = readInputs();
    setEntry(dIso, e, 'add');
    loadDay(); renderCalendar(); renderWeek(); renderMonth();
  });
  document.getElementById('btnReemplazar').addEventListener('click', ()=>{
    const dIso = iso(current);
    const e = readInputs();
    setEntry(dIso, e, 'replace');
    loadDay(); renderCalendar(); renderWeek(); renderMonth();
  });
  document.getElementById('resetDia').addEventListener('click', ()=>{
    if(!confirm('¬øReiniciar el d√≠a seleccionado?')) return;
    setEntry(iso(current), {
      diario:0,cuponazo:0,sueldazo:0,r1:0,r2:0,r3:0,r5:0,r10:0,triples:0,superonce:0,miDia:0,eurojackpot:0,
      extNavidad:0,extVerano:0,extOnceOnce:0,extDiaPadre:0,extDiaMadre:0
    }, 'replace');
    loadDay(); renderCalendar(); renderWeek(); renderMonth();
  });

  document.getElementById('prevMes').addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); renderCalendar(); renderWeek(); renderMonth(); });
  document.getElementById('nextMes').addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); renderCalendar(); renderWeek(); renderMonth(); });
  document.getElementById('hoyBtn').addEventListener('click', ()=>{ current = new Date(); current.setHours(0,0,0,0); renderCalendar(); loadDay(); renderWeek(); renderMonth(); });

  // ‚Äî‚Äî‚Äî Inicial ‚Äî‚Äî‚Äî
  const dowsHeader = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];
  document.getElementById('calDow').innerHTML = dowsHeader.map(d=>`<div class="cal-dow">${d}</div>`).join('');
  attachSteppers(Object.keys(inputs));
  renderCalendar();
  loadDay();
  renderWeek();
  renderMonth();

  // Test m√≠nimo
  try{ console.assert(fmtEur(1234.5)==='1.234,50','fmtEur debe formatear 1.234,50'); }catch(e){ console.error(e); }
})();
</script>
</body>
</html>
